<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Invoice Generator – Vinayaka Industries</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- SweetAlert2 for custom modals -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <!-- html2pdf.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>
  <style>
    /* Spinner overlay */
    #spinnerOverlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:50; align-items:center; justify-content:center; }
    .spinner { border:4px solid #f3f3f3; border-top:4px solid #3498db; border-radius:50%; width:40px; height:40px; animation:spin 1s linear infinite; }
    @keyframes spin { to { transform:rotate(360deg); } }
    /* Hide number input spinners */
    input[type=number]::-webkit-outer-spin-button,
    input[type=number]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
  </style>
</head>
<body class="bg-gradient-to-br from-primary-dark-blue to-secondary-dark-blue text-gray-100">
  <div id="spinnerOverlay" class="flex"><div class="spinner"></div></div>
  <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div>

  <div id="invoiceApp" class="max-w-4xl mx-auto my-10 p-6 bg-gradient-to-br from-secondary-dark-blue/80 to-primary-dark-blue/80 shadow-2xl rounded-2xl">
    <h1 class="text-4xl font-extrabold text-light-blue mb-6">Invoice Generator</h1>

    <!-- Customer Select -->
    <div class="mb-6">
      <label for="customerSelect" class="block text-gray-200 font-semibold mb-2">Customer</label>
      <select id="customerSelect" class="w-full bg-secondary-dark-blue border border-accent-blue rounded p-2 text-gray-100">
        <option value="">-- Select Customer --</option>
      </select>
    </div>

    <!-- Items Table -->
    <div class="mb-6">
      <label class="block text-gray-200 font-semibold mb-2">Items</label>
      <table class="w-full border-collapse text-sm" id="itemsTable">
        <thead>
          <tr class="bg-accent-blue text-white">
            <th class="border p-2">#</th>
            <th class="border p-2">Model</th>
            <th class="border p-2">Product</th>
            <th class="border p-2">HSN/SAC</th>
            <th class="border p-2">Rate</th>
            <th class="border p-2">Qty</th>
            <th class="border p-2">CGST%</th>
            <th class="border p-2">SGST%</th>
            <th class="border p-2">Discount%</th>
            <th class="border p-2">Amount</th>
            <th class="border p-2">Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <button id="addItemBtn" class="mt-3 bg-gradient-to-r from-light-blue to-cyan-400 text-primary-dark-blue px-4 py-2 rounded-full font-semibold shadow-lg">
        Add Item
      </button>
    </div>

    <!-- Actions -->
    <div class="flex gap-4 mb-6">
      <button id="saveInvoiceBtn" class="flex-1 bg-gradient-to-r from-green-500 to-green-400 text-white px-4 py-2 rounded-full font-semibold shadow-lg" disabled>
        Save & Generate PDF
      </button>
      <button id="browseHistoryBtn" class="flex-1 bg-gradient-to-r from-yellow-500 to-yellow-400 text-white px-4 py-2 rounded-full font-semibold shadow-lg">
        Browse History
      </button>
      <button id="resetBtn" class="flex-1 bg-gradient-to-r from-gray-500 to-gray-600 text-white px-4 py-2 rounded-full font-semibold shadow-lg">
        Reset
      </button>
    </div>

    <!-- Preview + PDF Header/Footer -->
    <div id="invoicePreview" class="relative p-6 bg-secondary-dark-blue/70 border border-accent-blue rounded-2xl shadow-inner text-gray-200 print:shadow-none print:border-none">
      <!-- PDF Header -->
      <div class="absolute top-0 left-0 w-full p-4 text-center text-sm hidden print:block">
        <img src="https://drive.google.com/thumbnail?id=1L_NG4hUWi56GAaSTWBYFyau5cpG2Pb7W&sz=s800" class="inline h-8" alt="Logo" />
        <span class="font-bold ml-2">VINAYAKA INDUSTRIES</span>
      </div>

      <!-- Customer & Invoice Meta -->
      <div class="grid grid-cols-2 gap-4 mb-4 pt-10">
        <div class="space-y-1 text-sm">
          <p><strong>M/s:</strong> <span id="previewCustomer"></span></p>
          <p><strong>Address:</strong> <span id="previewAddress"></span></p>
          <p><strong>Contact:</strong> <span id="previewContact"></span></p>
          <p><strong>GSTIN:</strong> <span id="previewGSTIN"></span></p>
        </div>
        <div class="text-right space-y-1 text-sm">
          <p><strong>Invoice No:</strong> <span id="previewInvoiceNo"></span></p>
          <p><strong>Date:</strong> <span id="previewDate"></span></p>
        </div>
      </div>

      <!-- Items Preview Table -->
      <table class="w-full border-collapse text-sm mb-4">
        <thead>
          <tr class="bg-accent-blue text-white">
            <th class="border p-2">#</th>
            <th class="border p-2">Model</th>
            <th class="border p-2">Product</th>
            <th class="border p-2">HSN/SAC</th>
            <th class="border p-2">Qty</th>
            <th class="border p-2">Rate</th>
            <th class="border p-2">CGST</th>
            <th class="border p-2">SGST</th>
            <th class="border p-2">Discount</th>
            <th class="border p-2">Amount</th>
          </tr>
        </thead>
        <tbody id="previewItems"></tbody>
      </table>

      <!-- Totals & T&C -->
      <div class="flex justify-end text-sm mb-8">
        <table class="w-1/3 text-right">
          <tr><td>Sub Total</td><td>₹<span id="previewSubtotal"></span></td></tr>
          <tr><td>Total CGST</td><td>₹<span id="previewCGST"></span></td></tr>
          <tr><td>Total SGST</td><td>₹<span id="previewSGST"></span></td></tr>
          <tr><td>Total Discount</td><td>₹<span id="previewDiscount"></span></td></tr>
          <tr class="font-bold bg-primary-dark-blue"><td class="text-light-blue">Grand Total</td><td class="text-light-blue">₹<span id="previewGrandTotal"></span></td></tr>
        </table>
      </div>
      <div class="text-xs italic text-center print:block hidden">Payment due within 30 days.</div>

      <!-- PDF Footer -->
      <div class="absolute bottom-0 left-0 w-full p-2 text-center text-xs hidden print:block">
        Page <span class="pageNumber"></span> of <span class="totalPages"></span>
      </div>
    </div>
  </div>

  <script>
    // State
    const state = {
      customers: [],
      products: [],
      models: [],
      invoiceItems: [],
      historyCache: {},
    };
    const API = 'https://script.google.com/macros/s/AKfycbxL7ahq_PEPbGdqdif1CPbfVDVhL9INsM0-of6W2iI13NwFdqJ5VsUW-vjenu5dfcoZ/exec';

    // Helpers
    const showSpinner = on => document.getElementById('spinnerOverlay').style.display = on ? 'flex' : 'none';
    function showToast(msg, color='green') { Swal.fire({ toast:true, position:'top-end', icon: color, title: msg, showConfirmButton:false, timer:2000 }); }
    async function fetchJSONP(params) {
      return new Promise((res,rej)=>{
        const cb='cb'+Date.now(); window[cb]=d=>{res(d); delete window[cb]; s.remove();};
        const qs=new URLSearchParams({...params,callback:cb}).toString();
        const s=document.createElement('script'); s.src=`${API}?${qs}`; s.onerror=()=>rej(); document.body.append(s);
      });
    }
    function postData(payload) {
      return fetch(API,{method:'POST',body:JSON.stringify(payload)}).then(r=>r.json());
    }

    // Init
    window.onload = async ()=>{
      showSpinner(true);
      state.customers = await fetchJSONP({action:'getCustomers'});
      state.products  = await fetchJSONP({action:'getProducts'});
      state.models    = [...new Set(state.products.map(p=>`${p.MODEL} ${p['MODEL NUMBER']}`))];
      const invNo = await fetchJSONP({action:'getNextInvoiceNo'});
      document.getElementById('previewInvoiceNo').textContent = invNo;
      document.getElementById('previewDate').textContent      = new Date().toLocaleDateString('en-IN');
      bindUI(); renderCustomerOptions(); showSpinner(false);
    };

    function bindUI() {
      document.getElementById('addItemBtn').onclick = addItemRow;
      document.getElementById('saveInvoiceBtn').onclick = saveAndPDF;
      document.getElementById('browseHistoryBtn').onclick = browseHistory;
      document.getElementById('resetBtn').onclick = ()=>location.reload();
      document.getElementById('customerSelect').onchange = onCustomerChange;
    }

    function renderCustomerOptions() {
      const sel=document.getElementById('customerSelect');
      state.customers.forEach(c=>sel.add(new Option(c['Customer Name'],c['Customer Name'])));
    }
    function onCustomerChange() {
      const v=this.value; const c=state.customers.find(x=>x['Customer Name']===v)||{};
      ['previewCustomer','previewAddress','previewContact','previewGSTIN'].forEach(id=>document.getElementById(id).textContent=c[id.replace('preview','')]||'');
      toggleSave();
    }

    function toggleSave() { document.getElementById('saveInvoiceBtn').disabled = !document.getElementById('customerSelect').value || !state.invoiceItems.length; }

    // Add row
    function addItemRow() {
      const tbody=document.querySelector('#itemsTable tbody'); const idx=tbody.children.length;
      const tr=document.createElement('tr');
      tr.innerHTML= `<td class="border p-2 text-center">${idx+1}</td>
        <td class="border p-2"><select class="model-select"></select></td>
        <td class="border p-2"><select disabled class="product-select"></select></td>
        <td class="border p-2 hsn-cell"></td>
        <td class="border p-2 rate-cell"></td>
        <td class="border p-2"><input type="number" min="1" value="1" class="qty-input" /></td>
        <td class="border p-2"><input type="number" min="0" value="9" class="cgst-input" /></td>
        <td class="border p-2"><input type="number" min="0" value="9" class="sgst-input" /></td>
        <td class="border p-2"><input type="number" min="0" value="0" class="disc-input" /></td>
        <td class="border p-2 amount-cell">0.00</td>
        <td class="border p-2 text-center"><button class="remove-btn text-red-400">X</button></td>`;
      tbody.append(tr);
      // bind
      const ms=tr.querySelector('.model-select'), ps=tr.querySelector('.product-select');
      state.models.forEach(m=>ms.add(new Option(m,m)));
      ms.onchange=()=>{
        const val=ms.value; if(!val) return;
        if(val==='__add_new__') { /* handle new-entry */ }
        ps.disabled=false; ps.innerHTML='<option value="">Select Product</option>';
        state.products.filter(p=>`${p.MODEL} ${p['MODEL NUMBER']}`===val)
          .forEach((p,i)=>ps.add(new Option(`${p.DEVICE} | ${p.SIZE} ${p['ITEM NAME']}`,i)));
        calculateRow(tr);
      };
      [tr.querySelector('.qty-input'),tr.querySelector('.cgst-input'),tr.querySelector('.sgst-input'),tr.querySelector('.disc-input')]
        .forEach(inp=>inp.oninput=()=>calculateRow(tr));
      tr.querySelector('.remove-btn').onclick=()=>{tbody.removeChild(tr); updatePreview();};
      // add default 'Add New' last
      ms.add(new Option('➕ Add New','__add_new__'));
      toggleSave();
    }

    function calculateRow(tr) {
      const qty=+tr.querySelector('.qty-input').value;
      const rate=+tr.querySelector('.rate-cell').textContent||0;
      const cg=+tr.querySelector('.cgst-input').value;
      const sg=+tr.querySelector('.sgst-input').value;
      const dc=+tr.querySelector('.disc-input').value;
      const gross=qty*rate;
      const tax=(gross*(cg+sg)/100);
      const disc=(gross*dc/100);
      const amt=gross+tax-disc;
      tr.querySelector('.amount-cell').textContent=amt.toFixed(2);
      updatePreview();
    }

    function updatePreview(){
      const pt=document.getElementById('previewItems'); pt.innerHTML='';
      document.querySelectorAll('#itemsTable tbody tr').forEach((tr,i)=>{
        const clone=tr.cloneNode(true);
        clone.querySelectorAll('select,input,button').forEach(n=>n.remove());
        clone.children[0].textContent=i+1;
        pt.append(clone);
      }); calculateTotals();
    }

    function calculateTotals(){
      let sub=0,cg=0,sg=0,dc=0;
      document.querySelectorAll('#previewItems tr').forEach(tr=>{
        const c=tr.children;
        const g=+c[4].textContent; const r=+c[5].textContent;
        const cgP=+c[6].textContent, sgP=+c[7].textContent, dcP=+c[8].textContent;
        sub+=g*r; cg+=g*r*(cgP/100); sg+=g*r*(sgP/100); dc+=g*r*(dcP/100);
      });
      const grand=sub+cg+sg-dc;
      document.getElementById('previewSubtotal').textContent=sub.toFixed(2);
      document.getElementById('previewCGST').textContent=cg.toFixed(2);
      document.getElementById('previewSGST').textContent=sg.toFixed(2);
      document.getElementById('previewDiscount').textContent=dc.toFixed(2);
      document.getElementById('previewGrandTotal').textContent=grand.toFixed(2);
      toggleSave();
    }

    async function saveAndPDF() {
      const invNo=document.getElementById('previewInvoiceNo').textContent;
      const rows=[];
      document.querySelectorAll('#previewItems tr').forEach((tr,i)=>{
        const d=Array.from(tr.children).map(td=>td.textContent);
        rows.push({
          'Invoice No':invNo, 'Sr.No.':i+1,
          Model:d[1],Product:d[2],'HSN/SAC':d[3],Qty:d[4],Rate:d[5],
          'CGST%':d[6],'SGST%':d[7],'Discount%':d[8],Amount:d[9]
        });
      });
      showSpinner(true);
      const res=await postData({action:'addInvoice',invoice:rows});
      if(!res.success){showToast('Save failed','error');showSpinner(false);return;} 
      html2pdf(document.getElementById('invoicePreview'),{
        filename:`Invoice_${invNo}.pdf`,
        margin: [20,10,20,10],
        html2canvas:{ scale:2 },
        jsPDF:{ unit:'pt', format:'a4' }
      });
      showSpinner(false);
    }

    function browseHistory() {
      Swal.fire({
        title:'Enter Invoice No', input:'text', showCancelButton:true
      }).then(async r=>{
        if(!r.value) return;
        showSpinner(true);
        const data=await fetchJSONP({action:'getInvoice',invoiceNo:r.value});
        showSpinner(false);
        if(!data.length) return showToast('Not found','error');
        // populate preview only
        document.getElementById('previewItems').innerHTML='';
        data.forEach((row,i)=>{
          const tr=document.createElement('tr');
          tr.innerHTML=Object.values(row).slice(1).map(val=>`<td class="border p-2">${val}</td>`).join('');
          tr.children[0].textContent=i+1;
          document.getElementById('previewItems').append(tr);
        });
        calculateTotals();
      });
    }
  </script>
</body>
</html>
