<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Invoice Generator â€“ Vinayaka Industries</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'primary-dark-blue': '#0f172a',
            'secondary-dark-blue': '#1e293b',
            'accent-blue': '#1d4ed8',
            'light-blue': '#3b82f6',
            'navy': '#1e3a8a',
            'slate': '#334155',
            'primary': '#0ea5e9',
            'secondary': '#06b6d4',
          },
          animation: {
            'fade-in': 'fadeIn 0.5s ease-in-out',
            'slide-up': 'slideUp 0.3s ease-out',
            'bounce-gentle': 'bounceGentle 0.6s ease-in-out',
          },
          keyframes: {
            fadeIn: {
              '0%': { opacity: '0', transform: 'translateY(10px)' },
              '100%': { opacity: '1', transform: 'translateY(0)' },
            },
            slideUp: {
              '0%': { transform: 'translateY(20px)', opacity: '0' },
              '100%': { transform: 'translateY(0)', opacity: '1' },
            },
            bounceGentle: {
              '0%, 100%': { transform: 'translateY(0)' },
              '50%': { transform: 'translateY(-5px)' },
            },
          },
          backdropBlur: {
            'xs': '2px',
          },
          boxShadow: {
            'elegant': '0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)',
            'inner-elegant': 'inset 0 2px 4px 0 rgba(0, 0, 0, 0.06)',
            'glow': '0 0 20px rgba(59, 130, 246, 0.3)',
          },
        },
      },
    };
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>
  <style>
    /* Hide spinners on number inputs */
    input[type=number]::-webkit-outer-spin-button,
    input[type=number]::-webkit-inner-spin-button {
      -webkit-appearance: none; 
      margin: 0;
    }

    /* Custom scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
    }
    ::-webkit-scrollbar-track {
      background: #1e293b;
      border-radius: 4px;
    }
    ::-webkit-scrollbar-thumb {
      background: #3b82f6;
      border-radius: 4px;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: #1d4ed8;
    }

    /* Smooth transitions */
    * {
      transition: all 0.2s ease-in-out;
    }

    /* Glass morphism effect */
    .glass {
      backdrop-filter: blur(10px);
      background: rgba(30, 41, 59, 0.8);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    /* Hover effects */
    .hover-lift:hover {
      transform: translateY(-2px);
    }

    /* Focus effects */
    .focus-ring:focus {
      outline: none;
      ring-width: 2px;
      ring-color: rgb(59 130 246);
      ring-offset-width: 2px;
      ring-offset-color: rgb(15 23 42);
    }

    /* Button press animation */
    .btn-press:active {
      transform: scale(0.98);
    }

    /* Gradient text */
    .gradient-text {
      background: linear-gradient(135deg, #3b82f6 0%, #06b6d4 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-900 via-primary-dark-blue to-navy text-gray-100 font-sans">
  <!-- Animated background elements -->
  <div class="fixed inset-0 overflow-hidden pointer-events-none">
    <div class="absolute top-1/4 left-1/4 w-64 h-64 bg-blue-500/10 rounded-full blur-3xl animate-pulse"></div>
    <div class="absolute bottom-1/4 right-1/4 w-96 h-96 bg-cyan-500/10 rounded-full blur-3xl animate-pulse delay-1000"></div>
  </div>

  <!-- Toast Container -->
  <div id="toast-container" class="fixed top-6 right-6 z-50 space-y-3"></div>

  <!-- Main Container -->
  <div id="invoiceApp" class="relative max-w-7xl mx-auto my-8 p-8 glass rounded-3xl shadow-elegant animate-fade-in">
    <!-- Header -->
    <div class="text-center mb-12">
      <h1 class="text-6xl font-black gradient-text mb-4 tracking-tight">Invoice Generator</h1>
      <div class="w-24 h-1 bg-gradient-to-r from-primary to-secondary mx-auto rounded-full"></div>
      <p class="text-gray-400 mt-4 text-lg">Professional Invoice Management System</p>
    </div>

    <!-- Invoice Form -->
    <div id="invoiceForm" class="space-y-8 animate-slide-up">
      <!-- Customer Section -->
      <div class="glass p-6 rounded-2xl shadow-inner-elegant hover-lift">
        <div class="flex items-center mb-4">
          <div class="w-3 h-8 bg-gradient-to-b from-primary to-secondary rounded-full mr-3"></div>
          <label for="customerSelect" class="block text-xl font-bold text-gray-200">Customer Information</label>
        </div>
        <select id="customerSelect" class="w-full bg-slate/50 border-2 border-slate-600 hover:border-primary focus:border-secondary rounded-xl p-4 text-gray-100 focus-ring transition-all duration-300 text-lg font-medium">
          <option value="">-- SELECT Customer --</option>
        </select>
      </div>

      <!-- Items Section -->
      <div class="glass p-6 rounded-2xl shadow-inner-elegant hover-lift">
        <div class="flex items-center justify-between mb-6">
          <div class="flex items-center">
            <div class="w-3 h-8 bg-gradient-to-b from-primary to-secondary rounded-full mr-3"></div>
            <label class="block text-xl font-bold text-gray-200">Invoice Items</label>
          </div>
          <button id="addItemBtn" class="group bg-gradient-to-r from-emerald-500 via-primary to-secondary hover:from-emerald-600 hover:via-blue-600 hover:to-cyan-600 text-white px-6 py-3 rounded-full font-bold shadow-lg hover:shadow-glow btn-press transform hover:scale-105 transition-all duration-300">
            <span class="flex items-center gap-2">
              <svg class="w-5 h-5 group-hover:rotate-90 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
              </svg>
              Add Item
            </span>
          </button>
        </div>
        
        <div class="overflow-x-auto rounded-xl border-2 border-slate-600">
          <table class="w-full border-collapse text-sm">
            <thead>
              <tr class="bg-gradient-to-r from-navy to-accent-blue text-white">
                <th class="border border-slate-600 p-4 font-bold text-center">Sr.No.</th>
                <th class="border border-slate-600 p-4 font-bold">Model</th>
                <th class="border border-slate-600 p-4 font-bold">Product</th>
                <th class="border border-slate-600 p-4 font-bold">HSN/SAC</th>
                <th class="border border-slate-600 p-4 font-bold">Rate</th>
                <th class="border border-slate-600 p-4 font-bold">Qty</th>
                <th class="border border-slate-600 p-4 font-bold">IGST%</th>
                <th class="border border-slate-600 p-4 font-bold">Amount</th>
              </tr>
            </thead>
            <tbody id="itemsTable" class="bg-slate-800/50"></tbody>
          </table>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="flex gap-6 pt-4">
        <button id="saveInvoiceBtn" class="group flex-1 bg-gradient-to-r from-emerald-500 to-green-500 hover:from-emerald-600 hover:to-green-600 text-white px-8 py-4 rounded-2xl font-bold shadow-elegant hover:shadow-glow btn-press transform hover:scale-105 transition-all duration-300">
          <span class="flex items-center justify-center gap-3 text-lg">
            <svg class="w-6 h-6 group-hover:animate-bounce-gentle" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 0V6a2 2 0 00-2-2H10a2 2 0 00-2 2v1m1 0h4m-4 0a2 2 0 002 2v3a2 2 0 01-2 2H9a2 2 0 01-2-2v-3a2 2 0 012-2h2z"></path>
            </svg>
            Save & Generate PDF
          </span>
        </button>
        <button id="resetBtn" class="group flex-1 bg-gradient-to-r from-gray-600 to-slate-700 hover:from-gray-700 hover:to-slate-800 text-white px-8 py-4 rounded-2xl font-bold shadow-elegant hover:shadow-xl btn-press transform hover:scale-105 transition-all duration-300">
          <span class="flex items-center justify-center gap-3 text-lg">
            <svg class="w-6 h-6 group-hover:rotate-180 transition-transform duration-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0V9a8 8 0 1115.356 2m-15.356-2H9"></path>
            </svg>
            Reset Form
          </span>
        </button>
      </div>
    </div>

    <!-- Invoice Preview -->
    <div id="invoicePreview" class="mt-12 p-8 glass rounded-2xl shadow-inner-elegant animate-slide-up border-2 border-slate-600/50">
      <!-- Header -->
      <div class="flex justify-between items-start mb-8 p-6 bg-gradient-to-r from-slate-800/50 to-slate-700/50 rounded-xl">
        <div class="flex items-center gap-4">
          <img src="https://drive.google.com/thumbnail?id=1L_NG4hUWi56GAaSTWBYFyau5cpG2Pb7W&sz=s800" alt="Logo" class="h-20 w-20 object-contain rounded-lg shadow-lg border-2 border-primary/20">
        </div>
        <div class="text-right">
          <h2 class="text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-primary to-secondary mb-2">VINAYAKA INDUSTRIES</h2>
          <div class="text-gray-300 space-y-1 text-sm">
            <p class="font-medium">No.34, Lakshmipura Main Road</p>
            <p class="font-medium">Chikkabanavara Post, Abigere, Bangalore - 560090</p>
            <p class="font-semibold text-primary">Mo: +91 9448355315</p>
          </div>
        </div>
      </div>

      <!-- Customer & Invoice Details -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
        <div class="space-y-3 p-6 bg-slate-800/30 rounded-xl border border-slate-600/50">
          <h3 class="text-lg font-bold text-primary mb-4 border-b border-primary/30 pb-2">Bill To:</h3>
          <div class="space-y-2 text-sm">
            <p><span class="font-semibold text-gray-400 w-20 inline-block">M/s:</span> <span id="previewCustomer" class="text-gray-200 font-medium"></span></p>
            <p><span class="font-semibold text-gray-400 w-20 inline-block">Address:</span> <span id="previewAddress" class="text-gray-200"></span></p>
            <p><span class="font-semibold text-gray-400 w-20 inline-block">Contact:</span> <span id="previewContact" class="text-gray-200"></span></p>
            <p><span class="font-semibold text-gray-400 w-20 inline-block">GSTIN:</span> <span id="previewGSTIN" class="text-gray-200 font-mono"></span></p>
          </div>
        </div>
        <div class="space-y-3 p-6 bg-slate-800/30 rounded-xl border border-slate-600/50">
          <h3 class="text-lg font-bold text-secondary mb-4 border-b border-secondary/30 pb-2">Invoice Details:</h3>
          <div class="space-y-2 text-sm">
            <p><span class="font-semibold text-gray-400">Invoice No:</span> <span id="previewInvoiceNo" class="text-gray-200 font-bold text-lg text-primary"></span></p>
            <p><span class="font-semibold text-gray-400">Date:</span> <span id="previewDate" class="text-gray-200 font-medium"></span></p>
          </div>
        </div>
      </div>

      <!-- Items Table -->
      <div class="overflow-x-auto rounded-xl border-2 border-slate-600/50 mb-8">
        <table class="w-full border-collapse text-sm">
          <thead>
            <tr class="bg-gradient-to-r from-navy via-accent-blue to-primary text-white">
              <th class="border border-slate-500 p-4 font-bold">Sr.No.</th>
              <th class="border border-slate-500 p-4 font-bold">Model</th>
              <th class="border border-slate-500 p-4 font-bold">Product</th>
              <th class="border border-slate-500 p-4 font-bold">HSN/SAC</th>
              <th class="border border-slate-500 p-4 font-bold">Qty</th>
              <th class="border border-slate-500 p-4 font-bold">Rate</th>
              <th class="border border-slate-500 p-4 font-bold">IGST%</th>
              <th class="border border-slate-500 p-4 font-bold">Amount</th>
            </tr>
          </thead>
          <tbody id="previewItems" class="bg-slate-800/20"></tbody>
        </table>
      </div>

      <!-- Totals Section -->
      <div class="flex justify-end">
        <div class="w-full md:w-1/2 lg:w-1/3">
          <div class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-xl p-6 border-2 border-slate-600/50 shadow-elegant">
            <table class="w-full text-right text-sm space-y-2">
              <tr class="border-b border-slate-600 pb-2">
                <td class="py-2 text-gray-400 font-medium">Sub Total</td>
                <td class="py-2 text-gray-200 font-bold">â‚¹<span id="previewSubtotal"></span></td>
              </tr>
              <tr class="border-b border-slate-600 pb-2">
                <td class="py-2 text-gray-400 font-medium">Total GST</td>
                <td class="py-2 text-gray-200 font-bold">â‚¹<span id="previewTotalGST"></span></td>
              </tr>
              <tr class="border-b border-slate-600 pb-2">
                <td class="py-2 text-gray-400 font-medium">Round Off</td>
                <td class="py-2 text-gray-200 font-bold">â‚¹<span id="previewRoundOff"></span></td>
              </tr>
              <tr class="bg-gradient-to-r from-primary/20 to-secondary/20 rounded-lg">
                <td class="py-4 px-4 text-primary font-bold text-lg">Grand Total</td>
                <td class="py-4 px-4 text-primary font-black text-xl">â‚¹<span id="previewGrandTotal"></span></td>
              </tr>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbxL7ahq_PEPbGdqdif1CPbfVDVhL9INsM0-of6W2iI13NwFdqJ5VsUW-vjenu5dfcoZ/exec';

    function fetchJSONP(params = {}) {
      return new Promise((resolve, reject) => {
        const cb = '__jsonp_cb_' + Date.now();
        window[cb] = data => { resolve(data); delete window[cb]; script.remove(); };
        params.callback = cb;
        const qs = new URLSearchParams(params).toString();
        const script = document.createElement('script');
        script.src = `${API_URL}?${qs}`;
        script.onerror = () => reject(new Error('JSONP load error'));
        document.body.appendChild(script);
      });
    }

    function postInvoiceData(payload) {
      return fetch(API_URL, {
        method: 'POST',
        body: JSON.stringify(payload)
      }).then(r => r.json());
    }

    function showToast(msg, color='green') {
      const cont = document.getElementById('toast-container');
      const div = document.createElement('div');
      div.textContent = msg;
      div.className = `px-6 py-4 text-white rounded-2xl shadow-elegant bg-${color}-500 border border-${color}-400 animate-slide-up backdrop-blur-sm`;
      cont.append(div);
      setTimeout(() => {
        div.style.opacity = '0';
        div.style.transform = 'translateX(100px)';
        setTimeout(() => div.remove(), 300);
      }, 3000);
    }

    let customers = [], products = [], modelsList = [];

    async function init() {
      customers = await fetchJSONP({ action:'getCustomers' });
      const custSel = document.getElementById('customerSelect');
      const custOptions = customers.map(c=>`<option value="${c['Customer Name']}">${c['Customer Name']}</option>`).join('');
      custSel.innerHTML = `<option value="">-- SELECT Customer --</option>${custOptions}`;
      custSel.addEventListener('change', onCustomer);

      products = await fetchJSONP({ action:'getProducts' });
      modelsList = [...new Set(products.map(p=>`${p['MODEL']} ${p['MODEL NUMBER']}`))];
      window.modelOptionsHTML = `<option value="">Select Model</option>${modelsList.map(m=>`<option value="${m}">${m}</option>`).join('')}<option value="__add_new__">âž• Add New</option>`;

      const invNo = await fetchJSONP({ action:'getNextInvoiceNo' });
      document.getElementById('previewInvoiceNo').textContent = invNo;
      document.getElementById('previewDate').textContent      = new Date().toLocaleDateString('en-IN');

      document.getElementById('addItemBtn').addEventListener('click', addItemRow);
      document.getElementById('saveInvoiceBtn').addEventListener('click', saveAndPDF);
      document.getElementById('resetBtn').addEventListener('click',()=>location.reload());
    }

    function onCustomer() {
      const c = customers.find(x=>x['Customer Name']===this.value) || {};
      document.getElementById('previewCustomer').textContent = c['Customer Name'] || '';
      document.getElementById('previewAddress').textContent  = c['Address'] || '';
      document.getElementById('previewContact').textContent  = c['contact'] || '';
      document.getElementById('previewGSTIN').textContent    = c['Customer GSTIN'] || '';
    }

    function updateAllModelSelects() {
      document.querySelectorAll('.model-select').forEach(sel => {
        const cur = sel.value;
        sel.innerHTML = window.modelOptionsHTML;
        sel.value = cur;
      });
    }

    function addItemRow() {
      const tbody = document.getElementById('itemsTable');
      const idx   = tbody.children.length;
      const tr    = document.createElement('tr');
      tr.className = 'hover:bg-slate-700/30 transition-colors duration-200 animate-fade-in';
      tr.innerHTML = `
        <td class="p-4 text-center font-semibold text-primary border border-slate-600">${idx+1}</td>
        <td class="border border-slate-600 p-3">
          <select class="model-select w-full bg-slate-800/70 border-2 border-slate-600 hover:border-primary focus:border-secondary rounded-lg p-3 text-gray-100 focus-ring transition-all duration-300 font-medium">
            ${window.modelOptionsHTML}
          </select>
        </td>
        <td class="border border-slate-600 p-3">
          <select class="product-selector w-full bg-slate-800/70 border-2 border-slate-600 hover:border-primary focus:border-secondary rounded-lg p-3 text-gray-100 focus-ring transition-all duration-300 font-medium">
            <option value="">Select Product</option>
          </select>
        </td>
        <td class="border border-slate-600 p-4 hsn-cell text-center font-mono font-semibold text-secondary">8413</td>
        <td class="border border-slate-600 p-4 rate-cell text-center font-bold text-emerald-400"></td>
        <td class="border border-slate-600 p-3">
          <input type="number" class="qty-input w-20 bg-slate-800/70 border-2 border-slate-600 hover:border-primary focus:border-secondary rounded-lg p-3 text-gray-100 text-center font-semibold focus-ring transition-all duration-300" min="1" value="1">
        </td>
        <td class="border border-slate-600 p-4 igst-cell text-center font-bold text-yellow-400">18</td>
        <td class="border border-slate-600 p-4 amount-cell text-center font-bold text-primary">0.00</td>
      `;
      tbody.append(tr);

      const modelSel = tr.querySelector('.model-select');
      const prodSel  = tr.querySelector('.product-selector');

      modelSel.addEventListener('change',()=>{
        if (modelSel.value === '__add_new__') {
          tr.classList.add('new-entry');
          tr.innerHTML = `
            <td class="p-4 text-center font-semibold text-primary border border-slate-600">${idx+1}</td>
            <td class="border border-slate-600 p-3" colspan="2">
              <input class="new-model w-full rounded-lg p-3 text-black bg-white font-medium border-2 border-gray-300 focus:border-blue-500 transition-all duration-300" placeholder="Model ModelNumber">
            </td>
            <td class="border border-slate-600 p-3" colspan="2">
              <select class="new-device w-full rounded-lg p-3 text-black bg-white font-medium border-2 border-gray-300 focus:border-blue-500 transition-all duration-300">
                <option value="Swing Device">Swing Device</option>
                <option value="Travel Device">Travel Device</option>
              </select>
            </td>
            <td class="border border-slate-600 p-3" colspan="2">
              <input class="new-name w-full rounded-lg p-3 text-black bg-white font-medium border-2 border-gray-300 focus:border-blue-500 transition-all duration-300" placeholder="Size ItemName">
            </td>
            <td class="border border-slate-600 p-3">
              <input type="number" class="new-rate w-28 rounded-lg p-3 text-black bg-white font-medium border-2 border-gray-300 focus:border-blue-500 transition-all duration-300" placeholder="Rate">
            </td>
            <td class="border border-slate-600 p-3 text-center">
              <div class="flex gap-2 justify-center">
                <button class="confirm-add-btn bg-gradient-to-r from-emerald-500 to-green-500 hover:from-emerald-600 hover:to-green-600 text-white rounded-lg px-4 py-2 font-bold shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105">âœ“</button>
                <button class="cancel-add-btn bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white rounded-lg px-4 py-2 font-bold shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105">âœ—</button>
              </div>
            </td>
          `;
          tr.querySelector('.cancel-add-btn').addEventListener('click', ()=>{
            tr.remove();
            updateAllModelSelects();
            renderPreview();
          });
          tr.querySelector('.confirm-add-btn').addEventListener('click', async ()=>{
            if (!confirm('Are you sure you want to add this product?')) return;
            const mIn = tr.querySelector('.new-model').value.trim();
            const [model, num] = mIn.split(/\s+(?=[^\s]+$)/);
            const dev  = tr.querySelector('.new-device').value.trim();
            const nm   = tr.querySelector('.new-name').value.trim();
            const rate = tr.querySelector('.new-rate').value.trim();
            const [size, ...item] = nm.split(' ');
            const resp = await postInvoiceData({
              action: 'addProduct',
              MODEL: model,
              'MODEL NUMBER': num || '',
              DEVICE: dev,
              SIZE: size || '',
              'ITEM NAME': item.join('') || '',
              PRICE: rate
            });
            if (!resp.success) { showToast('Add failed','red'); return; }
            products.push({ MODEL: model, 'MODEL NUMBER': num||'', DEVICE: dev, SIZE: size||'', 'ITEM NAME': item.join('')||'', PRICE: rate });
            modelsList.push(`${model} ${num||''}`);
            showToast('Product added!');
            replaceNewEntry(tr, `${model} ${num||''}`, `${dev} | ${nm}`, rate);
          });
        } else {
          prodSel.disabled = false;
          prodSel.innerHTML = `<option value="">Select Product</option>` +
            products
              .filter(p => `${p['MODEL']} ${p['MODEL NUMBER']}` === modelSel.value)
              .map((p,i) => `<option value="${i}">${p['DEVICE']} | ${p['SIZE']} ${p['ITEM NAME']}</option>`)
              .join('');
        }
        renderPreview();
      });

      prodSel.addEventListener('change', ()=>{
        const idx = parseInt(prodSel.value);
        const list = products.filter(p => `${p['MODEL']} ${p['MODEL NUMBER']}` === modelSel.value);
        if (!isNaN(idx) && list[idx]) {
          tr.querySelector('.rate-cell').textContent = list[idx]['PRICE'];
          tr.querySelector('.hsn-cell').textContent  = '8413';
        }
        calculateRow(tr);
      });

      tr.querySelector('.qty-input').addEventListener('input', ()=>calculateRow(tr));
    }

    function replaceNewEntry(tr, model, product, rate) {
      const idx = Array.from(tr.parentNode.children).indexOf(tr);
      tr.classList.remove('new-entry');
      tr.innerHTML = `
        <td class="p-4 text-center font-semibold text-primary border border-slate-600">${idx+1}</td>
        <td class="border border-slate-600 p-4 text-gray-200 font-medium">${model}</td>
        <td class="border border-slate-600 p-4 text-gray-200 font-medium">${product}</td>
        <td class="border border-slate-600 p-4 text-center font-mono font-semibold text-secondary">8413</td>
        <td class="border border-slate-600 p-4 text-center font-bold text-emerald-400">${rate}</td>
        <td class="border border-slate-600 p-3">
          <input type="number" class="qty-input w-20 bg-slate-800/70 border-2 border-slate-600 hover:border-primary focus:border-secondary rounded-lg p-3 text-gray-100 text-center font-semibold focus-ring transition-all duration-300" min="1" value="1">
        </td>
        <td class="border border-slate-600 p-4 text-center font-bold text-yellow-400">18</td>
        <td class="border border-slate-600 p-4 amount-cell text-center font-bold text-primary">0.00</td>
      `;
      tr.querySelector('.qty-input').addEventListener('input', ()=>calculateRow(tr));
      calculateRow(tr);
      updateAllModelSelects();
    }

    function calculateRow(tr) {
      const rate = parseFloat(tr.querySelector('.rate-cell').textContent) || 0;
      const qty = parseInt(tr.querySelector('.qty-input').value) || 0;
      const igst = parseFloat(tr.querySelector('.igst-cell').textContent) || 0;
      const subtotal = rate * qty;
      const gst = subtotal * (igst / 100);
      const total = subtotal + gst;
      tr.querySelector('.amount-cell').textContent = total.toFixed(2);
      renderPreview();
    }

    function renderPreview() {
      const tbody = document.getElementById('previewItems');
      const rows = [...document.getElementById('itemsTable').children].filter(r => !r.classList.contains('new-entry'));
      tbody.innerHTML = rows.map((tr, i) => {
        const model = tr.children[1].textContent || tr.children[1].querySelector('select')?.value || '';
        const product = tr.children[2].textContent || tr.children[2].querySelector('select')?.options[tr.children[2].querySelector('select')?.selectedIndex]?.text || '';
        const hsn = tr.querySelector('.hsn-cell').textContent;
        const qty = tr.querySelector('.qty-input').value;
        const rate = tr.querySelector('.rate-cell').textContent;
        const igst = tr.querySelector('.igst-cell').textContent;
        const amount = tr.querySelector('.amount-cell').textContent;
        return `<tr class="hover:bg-slate-700/20 transition-colors duration-200"><td class="border border-slate-500 p-3 text-center font-semibold">${i+1}</td><td class="border border-slate-500 p-3 font-medium">${model}</td><td class="border border-slate-500 p-3 font-medium">${product}</td><td class="border border-slate-500 p-3 text-center font-mono">${hsn}</td><td class="border border-slate-500 p-3 text-center font-semibold">${qty}</td><td class="border border-slate-500 p-3 text-center font-bold text-emerald-400">â‚¹${rate}</td><td class="border border-slate-500 p-3 text-center font-bold text-yellow-400">${igst}%</td><td class="border border-slate-500 p-3 text-center font-bold text-primary">â‚¹${amount}</td></tr>`;
      }).join('');
      calculateTotals();
    }

    function calculateTotals() {
      const amounts = [...document.querySelectorAll('.amount-cell')].map(cell => parseFloat(cell.textContent) || 0);
      const subtotal = amounts.reduce((sum, amt) => {
        const rate = amt / 1.18;
        return sum + rate;
      }, 0);
      const totalGST = amounts.reduce((sum, amt) => sum + amt, 0) - subtotal;
      const beforeRound = subtotal + totalGST;
      const rounded = Math.round(beforeRound);
      const roundOff = rounded - beforeRound;
      
      document.getElementById('previewSubtotal').textContent = subtotal.toFixed(2);
      document.getElementById('previewTotalGST').textContent = totalGST.toFixed(2);
      document.getElementById('previewRoundOff').textContent = roundOff.toFixed(2);
      document.getElementById('previewGrandTotal').textContent = rounded.toFixed(2);
    }

    async function saveAndPDF() {
      if (!document.getElementById('customerSelect').value) {
        showToast('Please select a customer', 'red');
        return;
      }
      const items = [...document.getElementById('itemsTable').children].filter(r => !r.classList.contains('new-entry'));
      if (items.length === 0) {
        showToast('Please add at least one item', 'red');
        return;
      }

      showToast('Saving invoice...', 'blue');
      
      const customer = customers.find(c => c['Customer Name'] === document.getElementById('customerSelect').value);
      const invoiceData = {
        action: 'saveInvoice',
        invoiceNo: document.getElementById('previewInvoiceNo').textContent,
        date: document.getElementById('previewDate').textContent,
        customer: customer,
        items: items.map((tr, i) => {
          const modelText = tr.children[1].textContent || tr.children[1].querySelector('select')?.value || '';
          const productSelect = tr.children[2].querySelector('select');
          const productIndex = parseInt(productSelect.value);
          const matchingProducts = products.filter(p => `${p['MODEL']} ${p['MODEL NUMBER']}` === modelText);
          const product = matchingProducts[productIndex];
          
          return {
            srNo: i + 1,
            model: modelText,
            product: product ? `${product['DEVICE']} | ${product['SIZE']} ${product['ITEM NAME']}` : '',
            hsn: tr.querySelector('.hsn-cell').textContent,
            qty: parseInt(tr.querySelector('.qty-input').value),
            rate: parseFloat(tr.querySelector('.rate-cell').textContent),
            igst: parseFloat(tr.querySelector('.igst-cell').textContent),
            amount: parseFloat(tr.querySelector('.amount-cell').textContent)
          };
        }),
        totals: {
          subtotal: parseFloat(document.getElementById('previewSubtotal').textContent),
          totalGST: parseFloat(document.getElementById('previewTotalGST').textContent),
          roundOff: parseFloat(document.getElementById('previewRoundOff').textContent),
          grandTotal: parseFloat(document.getElementById('previewGrandTotal').textContent)
        }
      };

      try {
        const result = await postInvoiceData(invoiceData);
        if (result.success) {
          showToast('Invoice saved successfully!', 'green');
          setTimeout(() => {
            const element = document.getElementById('invoicePreview');
            const opt = {
              margin: 1,
              filename: `Invoice_${invoiceData.invoiceNo}.pdf`,
              image: { type: 'jpeg', quality: 0.98 },
              html2canvas: { scale: 2 },
              jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
            };
            html2pdf().set(opt).from(element).save();
          }, 1000);
        } else {
          showToast('Failed to save invoice', 'red');
        }
      } catch (error) {
        showToast('Error saving invoice', 'red');
      }
    }

    window.onload = init;
  </script>
</body>
</html>
