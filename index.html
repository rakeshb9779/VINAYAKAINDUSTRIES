<!DOCTYPE html> 
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Invoice Generator Pro - Vinayaka Industries</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode/1.5.3/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        :root {
            --primary-rgb: 56 189 248;
            --primary-dark-rgb: 37 99 235;
            --bg-light: 241 245 249;
            --text-light: 15 23 42;
            --card-bg-light: rgba(255, 255, 255, 0.5);
            --card-border-light: rgba(var(--primary-rgb), 0.3);
            --input-bg-light: rgba(255, 255, 255, 0.8);
            --input-border-light: rgba(var(--primary-rgb), 0.4);
            --text-muted-light: 100 116 139;
            --invoice-bg-light: white;
            --bg-dark: #0f172a;
            --text-dark: #f8fafc;
            --card-bg-dark: rgba(30, 41, 59, 0.3);
            --card-border-dark: rgba(var(--primary-rgb), 0.3);
            --input-bg-dark: rgba(51, 65, 85, 0.5);
            --input-border-dark: rgba(var(--primary-rgb), 0.4);
            --text-muted-dark: #94a3b8;
            --invoice-bg-dark: #1e293b;
        }
        * {
            box-sizing: border-box;
        }
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.5s ease, color 0.5s ease;
            overflow: hidden;
        }
        body.light-theme {
            background-color: rgb(var(--bg-light));
            color: rgb(var(--text-light));
        }
        body.dark-theme {
            background-color: var(--bg-dark);
            color: var(--text-dark);
        }
        .main-layout {
            display: flex;
            height: 100vh;
        }
        .sidebar {
            width: 16rem;
            height: 100vh;
            flex-shrink: 0;
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 1.5rem 1rem;
            overflow-y: auto;
            transition: background-color 0.5s ease, border-color 0.5s ease;
            display: flex;
            flex-direction: column;
        }
        body.light-theme .sidebar {
            background-color: var(--card-bg-light);
            border-right: 1px solid var(--card-border-light);
        }
        body.dark-theme .sidebar {
            background-color: var(--card-bg-dark);
            border-right: 1px solid var(--card-border-dark);
        }
        .main-content {
            flex-grow: 1;
            padding: 2rem;
            padding-bottom: 100px;
            overflow-y: auto;
        }
        .glass-card {
            border-radius: 20px;
            padding: 1.5rem;
            border: 1px solid;
            box-shadow: 0 8px 32px rgba(var(--primary-rgb), 0.1);
            transition: background-color 0.5s ease, border-color 0.5s ease,
                transform 0.3s ease;
        }
        .glass-card:hover {
            transform: translateY(-5px);
        }
        body.light-theme .glass-card {
            background-color: var(--card-bg-light);
            border-color: var(--card-border-light);
        }
        body.dark-theme .glass-card {
            background-color: var(--card-bg-dark);
            border-color: var(--card-border-dark);
        }
        .futuristic-input,
        .futuristic-select,
        .futuristic-textarea {
            border: 2px solid;
            border-radius: 12px;
            padding: 12px 16px;
            transition: all 0.3s ease;
            font-weight: 500;
            width: 100%;
            outline: none;
        }
        body.light-theme .futuristic-input,
        body.light-theme .futuristic-select,
        body.light-theme .futuristic-textarea {
            background-color: var(--input-bg-light);
            border-color: var(--input-border-light);
            color: var(--text-light);
        }
        body.dark-theme .futuristic-input,
        body.dark-theme .futuristic-select,
        body.dark-theme .futuristic-textarea {
            background-color: var(--input-bg-dark);
            border-color: var(--input-border-dark);
            color: var(--text-dark);
        }
        .futuristic-input:focus,
        .futuristic-select:focus,
        .futuristic-textarea:focus {
            border-color: rgb(var(--primary-rgb));
            box-shadow: 0 0 0 4px rgba(var(--primary-rgb), 0.2);
        }
        .futuristic-btn {
            background: linear-gradient(
                135deg,
                rgb(var(--primary-rgb)) 0%,
                rgb(var(--primary-dark-rgb)) 100%
            );
            border: none;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            padding: 12px 24px;
            transition: all 0.3s ease;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .futuristic-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(var(--primary-rgb), 0.25);
        }
        .futuristic-btn-secondary {
            background: linear-gradient(135deg, #34d399 0%, #059669 100%);
        }
        .futuristic-btn-secondary:hover {
            box-shadow: 0 10px 20px rgba(52, 211, 153, 0.25);
        }
        .futuristic-btn-tertiary {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }
        .futuristic-btn-tertiary:hover {
            box-shadow: 0 10px 20px rgba(245, 158, 11, 0.25);
        }
        .futuristic-btn-neutral {
            background: linear-gradient(135deg, #64748b 0%, #334155 100%);
        }
        .futuristic-btn-neutral:hover {
            box-shadow: 0 10px 20px rgba(100, 116, 139, 0.25);
        }
        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            border-radius: 12px;
            font-weight: 500;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .nav-item.active {
            background: linear-gradient(
                135deg,
                rgb(var(--primary-rgb)) 0%,
                rgb(var(--primary-dark-rgb)) 100%
            );
            color: white;
            box-shadow: 0 6px 20px rgba(var(--primary-rgb), 0.3);
            transform: translateY(-2px);
        }
        .nav-item:not(.active):hover {
            background-color: rgba(var(--primary-rgb), 0.1);
            transform: translateX(5px);
        }
        body.light-theme .nav-item:not(.active) {
            color: #334155;
        }
        body.dark-theme .nav-item:not(.active) {
            color: var(--text-dark);
        }
        .text-muted {
            color: var(--text-muted-dark);
        }
        body.light-theme .text-muted {
            color: var(--text-muted-light);
        }
        body.light-theme .text-gray-800 {
            color: #1f2937;
        }
        body.dark-theme .text-gray-800 {
            color: var(--text-dark);
        }
        .table-header {
            border-bottom: 2px solid;
        }
        .table-row {
            border-bottom: 1px solid;
        }
        body.light-theme .table-header,
        body.light-theme .table-row {
            border-color: var(--card-border-light);
        }
        body.dark-theme .table-header,
        body.dark-theme .table-row {
            border-color: var(--card-border-dark);
        }
        body.light-theme .table-header {
            background-color: rgba(var(--primary-rgb), 0.05);
        }
        body.dark-theme .table-header {
            background-color: rgba(var(--primary-rgb), 0.1);
        }
        .invoice-preview {
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.1);
            transition: background-color 0.5s ease, color 0.5s ease;
        }
        body.light-theme .invoice-preview {
            background-color: var(--invoice-bg-light);
            color: var(--text-light);
        }
        body.dark-theme .invoice-preview {
            background-color: var(--invoice-bg-dark);
            color: var(--text-dark);
        }
        .fixed-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 1rem 2rem;
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            z-index: 100;
        }
        body.light-theme .fixed-footer {
            background-color: var(--card-bg-light);
            border-top: 1px solid var(--card-border-light);
        }
        body.dark-theme .fixed-footer {
            background-color: var(--card-bg-dark);
            border-top: 1px solid var(--card-border-dark);
        }
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: rgb(var(--primary-rgb));
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: rgb(var(--primary-dark-rgb));
        }
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .fade-in-up {
            animation: fadeInUp 0.5s ease-out forwards;
        }
        @media print {
            .no-print {
                display: none !important;
            }
            .sidebar,
            .main-content > .flex.justify-between,
            .fixed-footer {
                display: none !important;
            }
            .main-layout {
                display: block;
            }
            .main-content {
                padding: 0;
                overflow: visible;
            }
            .invoice-preview-container {
                border: none !important;
            }
            .invoice-preview {
                box-shadow: none;
                margin: 0;
                padding: 0;
            }
            body {
                background-color: white !important;
                color: black !important;
            }
            .invoice-preview {
                background-color: white !important;
                color: black !important;
            }
            .invoice-preview *,
            .invoice-preview .text-gray-800 {
                color: black !important;
            }
        }
    </style>
</head>
<body class="dark-theme">
    <div class="main-layout">
        <aside class="sidebar no-print">
            <div class="flex justify-between items-center mb-6">
                <div class="flex items-center space-x-3">
                    <div class="bg-gradient-to-br from-blue-500 to-blue-700 p-2 rounded-lg shadow-lg">
                        <i data-lucide="file-text" class="w-6 h-6 text-white"></i>
                    </div>
                    <div>
                        <h1 class="font-bold text-lg tracking-wider">VINAYAKA</h1>
                        <p class="text-xs text-muted">INDUSTRIES</p>
                    </div>
                </div>
                <button
                    id="theme-toggle"
                    class="p-2 rounded-full transition-colors duration-300 hover:bg-black/10 dark:hover:bg-white/10"
                >
                    <i
                        id="theme-icon"
                        data-lucide="sun"
                        class="w-5 h-5 text-muted"
                    ></i>
                </button>
            </div>

            <nav class="flex-grow">
                <ul class="space-y-2">
                    <li>
                        <a href="#dashboard" class="nav-item active"
                            ><i
                                data-lucide="layout-dashboard"
                                class="w-5 h-5"
                            ></i
                            ><span>Dashboard</span></a
                        >
                    </li>
                    <li>
                        <a href="#create-invoice" class="nav-item"
                            ><i data-lucide="file-plus" class="w-5 h-5"></i
                            ><span>Create Invoice</span></a
                        >
                    </li>
                    <li>
                        <a href="#quotation" class="nav-item"
                            ><i data-lucide="file-check-2" class="w-5 h-5"></i
                            ><span>Quotation</span></a
                        >
                    </li>
                    <li>
                        <a href="#invoice-history" class="nav-item"
                            ><i data-lucide="history" class="w-5 h-5"></i
                            ><span>History</span></a
                        >
                    </li>
                    <li>
                        <a href="#customers" class="nav-item"
                            ><i data-lucide="users" class="w-5 h-5"></i
                            ><span>Customers</span></a
                        >
                    </li>
                    <li>
                        <a href="#products" class="nav-item"
                            ><i data-lucide="package" class="w-5 h-5"></i
                            ><span>Products</span></a
                        >
                    </li>
                    <li>
                        <a href="#reports" class="nav-item"
                            ><i data-lucide="bar-chart-3" class="w-5 h-5"></i
                            ><span>Reports</span></a
                        >
                    </li>
                </ul>
            </nav>
            <div>
                <a href="#settings" class="nav-item"
                    ><i data-lucide="settings" class="w-5 h-5"></i
                    ><span>Settings</span></a
                >
            </div>
        </aside>

        <main class="main-content">
            <div id="dashboard" class="page">
                <div
                    class="flex justify-between items-center mb-8 fade-in-up"
                    style="animation-delay: 100ms"
                >
                    <div>
                        <h2 class="text-3xl font-bold">Invoice Generator Pro</h2>
                        <p class="text-muted">
                            Create professional invoices with GST compliance
                        </p>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span
                            class="bg-green-500/20 text-green-400 text-xs font-semibold px-3 py-1 rounded-full flex items-center"
                        >
                            <div
                                class="w-2 h-2 bg-green-500 rounded-full mr-2 animate-pulse"
                            ></div
                            >GST Ready
                        </span>
                        <button
                            onclick="syncData()"
                            class="futuristic-btn futuristic-btn-neutral"
                        >
                            <i data-lucide="refresh-cw" class="w-4 h-4"></i
                            ><span>Sync</span>
                        </button>
                    </div>
                </div>

                <div
                    class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8"
                >
                    <div
                        class="glass-card p-6 fade-in-up"
                        style="animation-delay: 200ms"
                    >
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-muted text-sm">TOTAL INVOICES</p>
                                <p class="text-3xl font-bold" id="stats-total-invoices">
                                    0
                                </p>
                            </div>
                            <div class="bg-blue-500/20 p-3 rounded-lg">
                                <i data-lucide="file-text" class="text-blue-400"></i>
                            </div>
                        </div>
                    </div>
                    <div
                        class="glass-card p-6 fade-in-up"
                        style="animation-delay: 300ms"
                    >
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-muted text-sm">REVENUE</p>
                                <p class="text-3xl font-bold" id="stats-revenue">₹0</p>
                            </div>
                            <div class="bg-green-500/20 p-3 rounded-lg">
                                <i data-lucide="dollar-sign" class="text-green-400"></i>
                            </div>
                        </div>
                    </div>
                    <div
                        class="glass-card p-6 fade-in-up"
                        style="animation-delay: 400ms"
                    >
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-muted text-sm">ACTIVE CUSTOMERS</p>
                                <p
                                    class="text-3xl font-bold"
                                    id="stats-active-customers"
                                >
                                    0
                                </p>
                            </div>
                            <div class="bg-yellow-500/20 p-3 rounded-lg">
                                <i data-lucide="users" class="text-yellow-400"></i>
                            </div>
                        </div>
                    </div>
                    <div
                        class="glass-card p-6 fade-in-up"
                        style="animation-delay: 500ms"
                    >
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-muted text-sm">PRODUCTS</p>
                                <p class="text-3xl font-bold" id="stats-products">0</p>
                            </div>
                            <div class="bg-purple-500/20 p-3 rounded-lg">
                                <i data-lucide="package" class="text-purple-400"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <div
                    class="glass-card p-6 fade-in-up"
                    style="animation-delay: 600ms"
                >
                    <h3 class="text-xl font-bold mb-4">Quick Actions</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <a
                            href="#create-invoice"
                            class="nav-link-action futuristic-btn p-6 rounded-lg flex flex-col items-start justify-between text-left h-40"
                        >
                            <i data-lucide="file-plus" class="w-8 h-8 mb-4"></i>
                            <div>
                                <p class="font-bold text-lg">Create Invoice</p>
                                <p class="text-sm font-normal text-white/70">
                                    Generate GST invoice
                                </p>
                            </div>
                        </a>
                        <a
                            href="#customers"
                            class="nav-link-action futuristic-btn futuristic-btn-secondary p-6 rounded-lg flex flex-col items-start justify-between text-left h-40"
                        >
                            <i data-lucide="user-plus" class="w-8 h-8 mb-4"></i>
                            <div>
                                <p class="font-bold text-lg">Add Customer</p>
                                <p class="text-sm font-normal text-white/70">
                                    Register new customer
                                </p>
                            </div>
                        </a>
                        <a
                            href="#products"
                            class="nav-link-action futuristic-btn futuristic-btn-tertiary p-6 rounded-lg flex flex-col items-start justify-between text-left h-40"
                        >
                            <i data-lucide="package-plus" class="w-8 h-8 mb-4"></i>
                            <div>
                                <p class="font-bold text-lg">Add Product</p>
                                <p class="text-sm font-normal text-white/70">
                                    Manage inventory
                                </p>
                            </div>
                        </a>
                    </div>
                </div>
            </div>

            <div id="create-invoice" class="page hidden">
                <div class="flex justify-between items-center mb-8">
                    <div>
                        <h2 class="text-3xl font-bold">Create Invoice</h2>
                        <p class="text-muted">Generate GST compliant invoices</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="glass-card p-8">
                        <h3 class="text-xl font-bold mb-6">Invoice Details</h3>
                        <form id="invoice-form" class="space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label
                                        class="block text-sm font-medium text-muted mb-2"
                                        >Invoice Number</label
                                    >
                                    <div class="relative">
                                        <input
                                            id="invoice-number"
                                            type="text"
                                            class="futuristic-input pr-10"
                                            readonly
                                        />
                                        <button
                                            type="button"
                                            onclick="refreshInvoiceNumber()"
                                            class="absolute inset-y-0 right-0 flex items-center pr-3 text-muted hover:text-blue-400 transition-colors"
                                            title="Refresh Invoice Number"
                                        >
                                            <i
                                                data-lucide="refresh-cw"
                                                class="w-5 h-5"
                                            ></i>
                                        </button>
                                    </div>
                                </div>
                                <div>
                                    <label
                                        class="block text-sm font-medium text-muted mb-2"
                                        >Invoice Date</label
                                    >
                                    <input
                                        id="invoice-date"
                                        type="date"
                                        class="futuristic-input"
                                        required
                                    />
                                </div>
                            </div>

                            <div>
                                <label
                                    class="block text-sm font-medium text-muted mb-2"
                                    >Select Customer</label
                                >
                                <select
                                    id="customer-select"
                                    class="futuristic-select"
                                    required
                                ></select>
                            </div>

                            <div>
                                <label
                                    class="block text-sm font-medium text-muted mb-2"
                                    >Customer GSTIN</label
                                >
                                <input
                                    id="customer-gstin-display"
                                    type="text"
                                    class="futuristic-input bg-opacity-50"
                                    readonly
                                />
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label
                                        class="block text-sm font-medium text-muted mb-2"
                                        >Place of Supply</label
                                    >
                                    <input
                                        id="place-of-supply-display"
                                        type="text"
                                        class="futuristic-input bg-opacity-50"
                                        readonly
                                    />
                                </div>
                                <div>
                                    <label
                                        class="block text-sm font-medium text-muted mb-2"
                                        >Dispatch</label
                                    >
                                    <select
                                        id="dispatch-method"
                                        class="futuristic-select"
                                    >
                                        <option>By Transport</option>
                                        <option>By Self</option>
                                    </select>
                                </div>
                            </div>
                            <div>
                                <label
                                    class="block text-sm font-medium text-muted mb-2"
                                    >Eway Bill #</label
                                >
                                <input
                                    id="eway-bill-number"
                                    type="text"
                                    class="futuristic-input"
                                    placeholder="Enter E-Way Bill Number if applicable"
                                />
                            </div>
                        </form>

                        <div class="mt-8">
                            <div
                                class="flex justify-between items-center mb-4"
                            >
                                <h3 class="text-lg font-bold">Invoice Items</h3>
                                <button
                                    onclick="addInvoiceItem()"
                                    class="futuristic-btn futuristic-btn-secondary px-4 py-2"
                                >
                                    <i data-lucide="plus" class="w-4 h-4"></i
                                    ><span>Add Item</span>
                                </button>
                            </div>
                            <div
                                id="invoice-items-container"
                                class="space-y-4 max-h-[50vh] overflow-y-auto p-1"
                            ></div>
                        </div>
                    </div>

                    <div class="p-2 rounded-lg">
                        <div
                            class="flex justify-between items-center mb-4"
                        >
                            <h3 class="text-lg font-bold">Live Preview</h3>
                            <button
                                onclick="resetInvoiceForm()"
                                class="text-sm futuristic-btn futuristic-btn-neutral px-3 py-1"
                            >
                                <i
                                    data-lucide="rotate-cw"
                                    class="w-4 h-4"
                                ></i
                                ><span>Reset</span>
                            </button>
                        </div>
                        <div
                            id="invoice-preview-container"
                            class="border-2 border-dashed border-white/20 rounded-lg overflow-hidden"
                        >
                            <div id="invoice-preview" class="invoice-preview">
                                <div
                                    class="flex flex-col justify-center items-center text-center text-muted h-full p-6"
                                >
                                    <i
                                        data-lucide="file-text"
                                        class="w-16 h-16 mx-auto mb-4 opacity-50"
                                    ></i>
                                    <p>Invoice preview will appear here</p>
                                    <p class="text-sm">
                                        Fill in the invoice details to see the live
                                        preview
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- other pages omitted for brevity -->

        </main>
    </div>
    <footer
        class="fixed-footer no-print page-footer hidden"
        data-page="create-invoice"
    >
        <a
            href="#settings"
            class="nav-link-action futuristic-btn futuristic-btn-neutral"
            ><i data-lucide="settings" class="w-5 h-5"></i>Settings</a
        >
        <button
            onclick="previewInvoice()"
            class="futuristic-btn futuristic-btn-secondary"
        >
            <i data-lucide="eye" class="w-5 h-5"></i>Preview Live
        </button>
        <button
            onclick="handleLoadData()"
            class="futuristic-btn futuristic-btn-neutral"
        >
            <i data-lucide="upload-cloud" class="w-5 h-5"></i>Load Data
        </button>
        <button onclick="generatePDF()" class="futuristic-btn">
            <i data-lucide="file-down" class="w-5 h-5"></i>Generate
        </button>
    </footer>

    <script>
        lucide.createIcons();

        // THEME TOGGLE
        const themeToggle = document.getElementById("theme-toggle");
        const setTheme = (isDark) => {
            document.body.className = isDark ? "dark-theme" : "light-theme";
            document
                .getElementById("theme-icon")
                .setAttribute("data-lucide", isDark ? "sun" : "moon");
            lucide.createIcons();
            localStorage.setItem("invoiceAppTheme", isDark ? "dark" : "light");
        };
        themeToggle.onclick = () =>
            setTheme(!document.body.classList.contains("dark-theme"));

        // APP LOGIC
        const GET_API_URL =
            "https://script.google.com/macros/s/AKfycbytvxDO1jlUxa289NXACCuRj0osY4Idep6WXaNC_rJ9WR_6h1pUYfWpBdtsI-AfuGkB/exec";
        const POST_API_URL = "/.netlify/functions/proxy";

        let customers = [],
            allProducts = [],
            invoiceItems = [],
            invoiceHistory = [],
            quotationHistory = [],
            currentInvoiceNumber = "VI-001";

        window.onload = () => {
            try {
                setTheme(localStorage.getItem("invoiceAppTheme") !== "light");
                showPage(window.location.hash.substring(1) || "dashboard");
                init();
            } catch (e) {
                console.error("Critical error on load:", e);
                showToast("A critical error occurred.", "error");
            }
        };

        function postData(payload) {
            return fetch(POST_API_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload),
            }).then((r) => r.json());
        }

        function showToast(title, icon = "success") {
            const isDark = document.body.classList.contains("dark-theme");
            Swal.mixin({
                toast: true,
                position: "top-end",
                showConfirmButton: false,
                timer: 3000,
                timerProgressBar: true,
                background: isDark ? "#1e293b" : "#f1f5f9",
                color: isDark ? "#f8fafc" : "#0f172a",
                didOpen: (toast) => {
                    toast.onmouseenter = Swal.stopTimer;
                    toast.onmouseleave = Swal.resumeTimer;
                },
            }).fire({ icon, title });
        }

        const navLinks = document.querySelectorAll(".nav-item, .nav-link-action");
        const pages = document.querySelectorAll(".page");
        const footers = document.querySelectorAll(".page-footer");

        function showPage(pageId) {
            pages.forEach((page) => page.classList.add("hidden"));
            footers.forEach((footer) => footer.classList.add("hidden"));

            const activePage = document.getElementById(pageId);
            if (activePage) activePage.classList.remove("hidden");

            const activeFooter = document.querySelector(
                `.page-footer[data-page="${pageId}"], .page-footer[data-page="${pageId.split("-")[0]}"]`
            );
            if (activeFooter) activeFooter.classList.remove("hidden");

            document.querySelectorAll(".nav-item").forEach((link) => {
                link.classList.remove("active");
                if (link.getAttribute("href") === `#${pageId}`) link.classList.add("active");
            });
        }
        navLinks.forEach((link) =>
            link.addEventListener("click", (e) => {
                e.preventDefault();
                const pageId = link.getAttribute("href").substring(1);
                showPage(pageId);
                window.location.hash = pageId;
            })
        );

        async function init() {
            setupEventListeners();
            loadInvoiceSettings();
            loadCompanySettings();
            loadBankSettings();
            initializeInvoiceForm();
            await syncData(true); // Pass true for initial load
        }

        function processAllData(data, isInitialLoad = false) {
            customers = data.customers || [];
            allProducts = (data.products || []).map((p, index) => ({
                ...p,
                row_index: index,
                uniqueModel: `${p.MODEL || ""} ${p["MODEL NUMBER"] || ""}`
                    .trim()
                    .toUpperCase(),
                uniqueItemName: `${p.SIZE || ""} ${p["ITEM NAME"] || ""}`
                    .trim()
                    .toUpperCase(),
            }));

            invoiceHistory = data.invoiceHistory || [];
            quotationHistory = data.quotationHistory || [];

            if (isInitialLoad) {
                const settings = JSON.parse(localStorage.getItem("invoiceConfig") || "{}");
                const prefix = settings.prefix || "VI-";
                let nextNum;

                const latestNumStr = String(data.latestInvoiceNumber || "");
                if (latestNumStr) {
                    const numericPart = parseInt(latestNumStr.replace(/[^0-9]/g, ""), 10);
                    nextNum = isNaN(numericPart) ? settings.nextNumber || 1 : numericPart + 1;
                } else {
                    nextNum = settings.nextNumber || invoiceHistory.length + 1;
                }

                currentInvoiceNumber = `${prefix}${String(nextNum).padStart(3, "0")}`;
                document.getElementById("invoice-number").value = currentInvoiceNumber;
            }

            renderCustomerList();
            renderProductList();
            updateDashboardStats();
            populateCustomerSelect();
            renderInvoiceHistory();

            document.querySelectorAll(".invoice-item").forEach((item, index) => {
                populateModelDropdown(index);
            });
        }

        function setupEventListeners() {
            document
                .getElementById("add-customer-form")
                .addEventListener("submit", handleAddCustomerFormSubmit);
            document
                .getElementById("add-product-form")
                .addEventListener("submit", handleAddProductFormSubmit);
            document
                .getElementById("invoice-settings-form")
                .addEventListener("submit", handleInvoiceSettingsFormSubmit);
            document
                .getElementById("company-settings-form")
                .addEventListener("submit", handleCompanySettingsFormSubmit);
            document
                .getElementById("bank-settings-form")
                .addEventListener("submit", handleBankSettingsFormSubmit);

            document
                .getElementById("invoice-prefix")
                .addEventListener("input", updateInvoiceExample);
            document
                .getElementById("invoice-next-number")
                .addEventListener("input", updateInvoiceExample);
            document
                .getElementById("invoice-form")
                .addEventListener("input", updateInvoicePreview);
            document
                .getElementById("customer-select")
                .addEventListener("change", populateCustomerDetails);
        }

        function initializeInvoiceForm() {
            const today = new Date();
            document.getElementById("invoice-date").value = today.toISOString().split("T")[0];
            if (invoiceItems.length === 0) addInvoiceItem();
        }

        // Updated addInvoiceItem with description fix
        function addInvoiceItem() {
            const container = document.getElementById("invoice-items-container");
            const itemIndex = invoiceItems.length;
            const itemHtml = `<div class="invoice-item bg-black/10 dark:bg-white/5 p-4 rounded-xl space-y-3" data-index="${itemIndex}">
                <div class="flex justify-between items-center"><h4 class="font-semibold">Item ${
                    itemIndex + 1
                }</h4><button type="button" onclick="removeInvoiceItem(${itemIndex})" class="text-red-400 hover:text-red-300"><i data-lucide="x-circle" class="w-5 h-5"></i></button></div>
                <div class="grid grid-cols-2 gap-3">
                    <select class="item-model futuristic-select text-sm" onchange="updateDependentDropdowns(${itemIndex})"><option value="">SELECT MODEL</option></select>
                    <select class="item-device futuristic-select text-sm" onchange="updateDependentDropdowns(${itemIndex})"><option value="">(BLANK)</option><option value="SWING DEVICE">SWING DEVICE</option><option value="TRAVEL DEVICE">TRAVEL DEVICE</option></select>
                </div>
                <select class="item-name futuristic-select text-sm" onchange="populateItemDetails(${itemIndex})"><option value="">SELECT ITEM NAME</option></select>
                <div class="grid grid-cols-6 gap-2 text-sm">
                    <input type="text" class="item-hsn futuristic-input col-span-2" placeholder="HSN/SAC" readonly>
                    <input type="number" class="item-rate futuristic-input" placeholder="Rate" readonly>
                    <input type="number" class="item-quantity futuristic-input" value="1" min="1" oninput="calculateItemTotal(${itemIndex})" placeholder="Qty">
                    <input type="number" class="item-discount futuristic-input" value="0" min="0" max="100" oninput="calculateItemTotal(${itemIndex})" placeholder="Disc %">
                    <input type="number" class="item-tax-rate futuristic-input" value="18" min="0" max="100" oninput="calculateItemTotal(${itemIndex})" placeholder="Tax %">
                    <input type="number" class="item-total futuristic-input" placeholder="Total" readonly>
                </div>
                <input type="text" class="item-description futuristic-input text-xs" placeholder="Description" readonly>
            </div>`;
            container.insertAdjacentHTML("beforeend", itemHtml);
            invoiceItems.push({
                model: "",
                device: "",
                name: "",
                hsn: "",
                rate: 0,
                quantity: 1,
                discount: 0,
                taxRate: 18,
                total: 0,
                description: "", // important to clear description here
            });
            lucide.createIcons();
            populateModelDropdown(itemIndex);
            updateDependentDropdowns(itemIndex);
        }

        function removeInvoiceItem(index) {
            invoiceItems.splice(index, 1);
            renderInvoiceItems();
            updateInvoicePreview();
        }

        function renderInvoiceItems() {
            const container = document.getElementById("invoice-items-container");
            container.innerHTML = "";
            invoiceItems.forEach((item, idx) => {
                addInvoiceItem();
            });
        }

        function populateModelDropdown(index) {
            const container = document.getElementById("invoice-items-container");
            const itemDiv = container.querySelector(`.invoice-item[data-index="${index}"]`);
            if (!itemDiv) return;

            const modelSelect = itemDiv.querySelector(".item-model");
            modelSelect.innerHTML = `<option value="">SELECT MODEL</option>`;
            const uniqueModels = [...new Set(allProducts.map((p) => p.uniqueModel))].filter(Boolean);
            uniqueModels.forEach((model) => {
                modelSelect.insertAdjacentHTML("beforeend", `<option>${model}</option>`);
            });
            if (invoiceItems[index]) {
                modelSelect.value = invoiceItems[index].model || "";
            }
        }

        // Called when model or device changes, filters item names accordingly
        function updateDependentDropdowns(index) {
            const container = document.getElementById("invoice-items-container");
            const itemDiv = container.querySelector(`.invoice-item[data-index="${index}"]`);
            if (!itemDiv) return;

            const modelSelect = itemDiv.querySelector(".item-model");
            const deviceSelect = itemDiv.querySelector(".item-device");
            const nameSelect = itemDiv.querySelector(".item-name");

            const selectedModel = modelSelect.value.trim().toUpperCase();
            const selectedDevice = deviceSelect.value.trim().toUpperCase();

            invoiceItems[index].model = selectedModel;
            invoiceItems[index].device = selectedDevice;

            // Filter items based on selected model and device
            let filteredItems = allProducts;
            if (selectedModel) {
                filteredItems = filteredItems.filter((p) => p.uniqueModel === selectedModel);
            }
            if (selectedDevice && selectedDevice !== "(BLANK)") {
                filteredItems = filteredItems.filter(
                    (p) => (p["DEVICE TYPE"] || "").toUpperCase() === selectedDevice
                );
            }

            // Clear and refill item-name select
            nameSelect.innerHTML = `<option value="">SELECT ITEM NAME</option>`;
            const uniqueNames = [...new Set(filteredItems.map((p) => p.uniqueItemName))].filter(Boolean);
            uniqueNames.forEach((name) => {
                nameSelect.insertAdjacentHTML("beforeend", `<option>${name}</option>`);
            });

            // If current item.name is not in filtered names, reset it and clear details
            if (!uniqueNames.includes(invoiceItems[index].name)) {
                invoiceItems[index].name = "";
                clearItemDetails(index);
            }
            // Reset selected value if needed
            nameSelect.value = invoiceItems[index].name || "";

            updateInvoicePreview();
        }

        function clearItemDetails(index) {
            const container = document.getElementById("invoice-items-container");
            const itemDiv = container.querySelector(`.invoice-item[data-index="${index}"]`);
            if (!itemDiv) return;

            itemDiv.querySelector(".item-hsn").value = "";
            itemDiv.querySelector(".item-rate").value = "";
            itemDiv.querySelector(".item-quantity").value = 1;
            itemDiv.querySelector(".item-discount").value = 0;
            itemDiv.querySelector(".item-tax-rate").value = 18;
            itemDiv.querySelector(".item-total").value = "";
            itemDiv.querySelector(".item-description").value = "";

            if (invoiceItems[index]) {
                invoiceItems[index].hsn = "";
                invoiceItems[index].rate = 0;
                invoiceItems[index].quantity = 1;
                invoiceItems[index].discount = 0;
                invoiceItems[index].taxRate = 18;
                invoiceItems[index].total = 0;
                invoiceItems[index].description = "";
            }
        }

        // Populates the details of the selected item-name
        function populateItemDetails(index) {
            const container = document.getElementById("invoice-items-container");
            const itemDiv = container.querySelector(`.invoice-item[data-index="${index}"]`);
            if (!itemDiv) return;

            const nameSelect = itemDiv.querySelector(".item-name");
            const selectedName = nameSelect.value.trim().toUpperCase();

            invoiceItems[index].name = selectedName;

            const itemData = allProducts.find(
                (p) => p.uniqueItemName === selectedName && (invoiceItems[index].model ? p.uniqueModel === invoiceItems[index].model : true)
            );

            if (itemData) {
                itemDiv.querySelector(".item-hsn").value = itemData.HSN || "";
                itemDiv.querySelector(".item-rate").value = itemData.RATE || 0;
                itemDiv.querySelector(".item-quantity").value = 1;
                itemDiv.querySelector(".item-discount").value = 0;
                itemDiv.querySelector(".item-tax-rate").value = 18;
                itemDiv.querySelector(".item-description").value = itemData.DESCRIPTION || "";
                invoiceItems[index].hsn = itemData.HSN || "";
                invoiceItems[index].rate = Number(itemData.RATE) || 0;
                invoiceItems[index].quantity = 1;
                invoiceItems[index].discount = 0;
                invoiceItems[index].taxRate = 18;
                invoiceItems[index].description = itemData.DESCRIPTION || "";
                calculateItemTotal(index);
            } else {
                clearItemDetails(index);
            }
        }

        // Calculates total for one item
        function calculateItemTotal(index) {
            const container = document.getElementById("invoice-items-container");
            const itemDiv = container.querySelector(`.invoice-item[data-index="${index}"]`);
            if (!itemDiv) return;

            const quantityInput = itemDiv.querySelector(".item-quantity");
            const discountInput = itemDiv.querySelector(".item-discount");
            const taxRateInput = itemDiv.querySelector(".item-tax-rate");
            const rateInput = itemDiv.querySelector(".item-rate");
            const totalInput = itemDiv.querySelector(".item-total");

            const quantity = Number(quantityInput.value) || 0;
            const discount = Number(discountInput.value) || 0;
            const taxRate = Number(taxRateInput.value) || 0;
            const rate = Number(rateInput.value) || 0;

            invoiceItems[index].quantity = quantity;
            invoiceItems[index].discount = discount;
            invoiceItems[index].taxRate = taxRate;

            let amount = rate * quantity;
            let discountAmt = (amount * discount) / 100;
            let taxableAmount = amount - discountAmt;
            let taxAmt = (taxableAmount * taxRate) / 100;
            let total = taxableAmount + taxAmt;

            totalInput.value = total.toFixed(2);
            invoiceItems[index].total = total;

            updateInvoicePreview();
        }

        // Updates the invoice preview area live
        function updateInvoicePreview() {
            const previewContainer = document.getElementById("invoice-preview");
            if (invoiceItems.length === 0 || !invoiceItems.some((item) => item.name)) {
                previewContainer.innerHTML = `<div class="flex flex-col justify-center items-center text-center text-muted h-full p-6">
                    <i data-lucide="file-text" class="w-16 h-16 mx-auto mb-4 opacity-50"></i>
                    <p>Invoice preview will appear here</p>
                    <p class="text-sm">Fill in the invoice details to see the live preview</p>
                </div>`;
                lucide.createIcons();
                return;
            }
            // Render full invoice with all items that have a name
            let html = `
            <div class="p-6">
                <h2 class="text-2xl font-bold mb-4">Invoice Preview</h2>
                <table class="w-full border-collapse text-sm">
                    <thead class="table-header bg-blue-100 dark:bg-blue-900">
                        <tr>
                            <th class="border px-2 py-1">Item Name</th>
                            <th class="border px-2 py-1">HSN/SAC</th>
                            <th class="border px-2 py-1">Qty</th>
                            <th class="border px-2 py-1">Rate</th>
                            <th class="border px-2 py-1">Discount %</th>
                            <th class="border px-2 py-1">Tax %</th>
                            <th class="border px-2 py-1">Total</th>
                        </tr>
                    </thead>
                    <tbody>`;

            let grandTotal = 0;
            invoiceItems.forEach((item) => {
                if (!item.name) return;
                grandTotal += item.total || 0;
                html += `<tr class="table-row">
                    <td class="border px-2 py-1">${item.name}</td>
                    <td class="border px-2 py-1">${item.hsn}</td>
                    <td class="border px-2 py-1 text-center">${item.quantity}</td>
                    <td class="border px-2 py-1 text-right">${item.rate.toFixed(2)}</td>
                    <td class="border px-2 py-1 text-center">${item.discount}</td>
                    <td class="border px-2 py-1 text-center">${item.taxRate}</td>
                    <td class="border px-2 py-1 text-right">${item.total.toFixed(2)}</td>
                </tr>`;
            });

            html += `<tr class="table-row font-semibold">
                <td colspan="6" class="border px-2 py-1 text-right">Grand Total</td>
                <td class="border px-2 py-1 text-right">${grandTotal.toFixed(2)}</td>
            </tr></tbody></table></div>`;

            previewContainer.innerHTML = html;
            lucide.createIcons();
        }

        function refreshInvoiceNumber() {
            const prefix = (localStorage.getItem("invoicePrefix") || "VI-").toUpperCase();
            const nextNum =
                parseInt(
                    (localStorage.getItem("invoiceNextNumber") || "1").replace(/\D/g, ""),
                    10
                ) || 1;
            currentInvoiceNumber = prefix + String(nextNum).padStart(3, "0");
            document.getElementById("invoice-number").value = currentInvoiceNumber;
            showToast("Invoice number refreshed");
        }

        // Sample syncData stub (replace with actual API call)
        async function syncData(isInitialLoad = false) {
            showToast("Syncing data...");
            // Simulated fetch - replace with your actual fetch call
            try {
                const response = await fetch(GET_API_URL);
                if (!response.ok) throw new Error("Failed to fetch data");
                const data = await response.json();
                processAllData(data, isInitialLoad);
                showToast("Data synced successfully");
            } catch (e) {
                console.error(e);
                showToast("Failed to sync data", "error");
            }
        }

        // Additional utility functions here...

        // Start lucide icons on page load
        lucide.createIcons();
    </script>
</body>
</html>
