<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>INvoice Generator Pro - Vinayaka Industries</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode/1.5.3/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        :root {
            --primary-rgb: 56 189 248;
            --primary-dark-rgb: 37 99 235;
            --bg-light: 241 245 249;
            --text-light: 15 23 42;
            --card-bg-light: rgba(255, 255, 255, 0.5);
            --card-border-light: rgba(var(--primary-rgb), 0.3);
            --input-bg-light: rgba(255, 255, 255, 0.8);
            --input-border-light: rgba(var(--primary-rgb), 0.4);
            --text-muted-light: 100 116 139;
            --invoice-bg-light: white;
            --bg-dark: #0f172a;
            --text-dark: #f8fafc;
            --card-bg-dark: rgba(30, 41, 59, 0.3);
            --card-border-dark: rgba(var(--primary-rgb), 0.3);
            --input-bg-dark: rgba(51, 65, 85, 0.5);
            --input-border-dark: rgba(var(--primary-rgb), 0.4);
            --text-muted-dark: #94a3b8;
            --invoice-bg-dark: #1e293b;
        }

        * { box-sizing: border-box; }
        
        body { 
            font-family: 'Inter', sans-serif; 
            transition: background-color 0.5s ease, color 0.5s ease; 
            overflow: hidden;
        }

        body.light-theme { 
            background-color: rgb(var(--bg-light)); 
            color: rgb(var(--text-light)); 
        }
        body.dark-theme { 
            background-color: var(--bg-dark); 
            color: var(--text-dark); 
        }

        .main-layout { display: flex; height: 100vh; }

        .sidebar {
            width: 16rem;
            height: 100vh;
            flex-shrink: 0;
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 1.5rem 1rem;
            overflow-y: auto;
            transition: background-color 0.5s ease, border-color 0.5s ease;
            display: flex;
            flex-direction: column;
        }
        body.light-theme .sidebar { 
            background-color: var(--card-bg-light); 
            border-right: 1px solid var(--card-border-light); 
        }
        body.dark-theme .sidebar { 
            background-color: var(--card-bg-dark); 
            border-right: 1px solid var(--card-border-dark); 
        }

        .main-content {
            flex-grow: 1;
            padding: 2rem;
            padding-bottom: 100px;
            overflow-y: auto;
        }
        
        .glass-card {
            border-radius: 20px;
            padding: 1.5rem;
            border: 1px solid;
            box-shadow: 0 8px 32px rgba(var(--primary-rgb), 0.1);
            transition: background-color 0.5s ease, border-color 0.5s ease, transform 0.3s ease;
        }
        .glass-card:hover { transform: translateY(-5px); }
        body.light-theme .glass-card { 
            background-color: var(--card-bg-light); 
            border-color: var(--card-border-light); 
        }
        body.dark-theme .glass-card { 
            background-color: var(--card-bg-dark); 
            border-color: var(--card-border-dark); 
        }

        .futuristic-input, .futuristic-select, .futuristic-textarea {
            border: 2px solid;
            border-radius: 12px;
            padding: 12px 16px;
            transition: all 0.3s ease;
            font-weight: 500;
            width: 100%;
            outline: none;
        }
        body.light-theme .futuristic-input, body.light-theme .futuristic-select, body.light-theme .futuristic-textarea { 
            background-color: var(--input-bg-light); 
            border-color: var(--input-border-light); 
            color: var(--text-light); 
        }
        body.dark-theme .futuristic-input, body.dark-theme .futuristic-select, body.dark-theme .futuristic-textarea { 
            background-color: var(--input-bg-dark); 
            border-color: var(--input-border-dark); 
            color: var(--text-dark); 
        }
        .futuristic-input:focus, .futuristic-select:focus, .futuristic-textarea:focus {
            border-color: rgb(var(--primary-rgb));
            box-shadow: 0 0 0 4px rgba(var(--primary-rgb), 0.2);
        }
        
        .futuristic-btn {
            background: linear-gradient(135deg, rgb(var(--primary-rgb)) 0%, rgb(var(--primary-dark-rgb)) 100%);
            border: none; border-radius: 12px; color: white; font-weight: 600;
            padding: 12px 24px; transition: all 0.3s ease; cursor: pointer;
            display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem;
        }
        .futuristic-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(var(--primary-rgb), 0.25);
        }
        .futuristic-btn-secondary { background: linear-gradient(135deg, #34d399 0%, #059669 100%); }
        .futuristic-btn-secondary:hover { box-shadow: 0 10px 20px rgba(52, 211, 153, 0.25); }
        .futuristic-btn-tertiary { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
        .futuristic-btn-tertiary:hover { box-shadow: 0 10px 20px rgba(245, 158, 11, 0.25); }
        .futuristic-btn-neutral { background: linear-gradient(135deg, #64748b 0%, #334155 100%); }
        .futuristic-btn-neutral:hover { box-shadow: 0 10px 20px rgba(100, 116, 139, 0.25); }

        .nav-item {
            display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem;
            border-radius: 12px; font-weight: 500; transition: all 0.3s ease; cursor: pointer;
        }
        .nav-item.active {
            background: linear-gradient(135deg, rgb(var(--primary-rgb)) 0%, rgb(var(--primary-dark-rgb)) 100%);
            color: white; box-shadow: 0 6px 20px rgba(var(--primary-rgb), 0.3); transform: translateY(-2px);
        }
        .nav-item:not(.active):hover { background-color: rgba(var(--primary-rgb), 0.1); transform: translateX(5px); }
        body.light-theme .nav-item:not(.active) { color: #334155; }
        body.dark-theme .nav-item:not(.active) { color: var(--text-dark); }
        
        .text-muted { color: var(--text-muted-dark); }
        body.light-theme .text-muted { color: var(--text-muted-light); }
        body.light-theme .text-gray-800 { color: #1f2937; }
        body.dark-theme .text-gray-800 { color: var(--text-dark); }


        .table-header { border-bottom: 2px solid; }
        .table-row { border-bottom: 1px solid; }
        body.light-theme .table-header, body.light-theme .table-row { border-color: var(--card-border-light); }
        body.dark-theme .table-header, body.dark-theme .table-row { border-color: var(--card-border-dark); }
        body.light-theme .table-header { background-color: rgba(var(--primary-rgb), 0.05); }
        body.dark-theme .table-header { background-color: rgba(var(--primary-rgb), 0.1); }
        
        .invoice-preview { box-shadow: 0 15px 40px rgba(0, 0, 0, 0.1); transition: background-color 0.5s ease, color 0.5s ease; }
        body.light-theme .invoice-preview { background-color: var(--invoice-bg-light); color: var(--text-light); }
        body.dark-theme .invoice-preview { background-color: var(--invoice-bg-dark); color: var(--text-dark); }
        
        .fixed-footer {
            position: fixed; bottom: 0; left: 0; right: 0;
            padding: 1rem 2rem;
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            display: flex; justify-content: center; align-items: center; gap: 1rem;
            z-index: 100;
        }
        body.light-theme .fixed-footer { background-color: var(--card-bg-light); border-top: 1px solid var(--card-border-light); }
        body.dark-theme .fixed-footer { background-color: var(--card-bg-dark); border-top: 1px solid var(--card-border-dark); }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgb(var(--primary-rgb)); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: rgb(var(--primary-dark-rgb)); }
        
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in-up { animation: fadeInUp 0.5s ease-out forwards; }
        
        @media print {
            .no-print { display: none !important; }
            .sidebar, .main-content > .flex.justify-between, .fixed-footer { display: none !important; }
            .main-layout { display: block; }
            .main-content { padding: 0; overflow: visible; }
            .invoice-preview-container { border: none !important; }
            .invoice-preview { box-shadow: none; margin: 0; padding: 0; }
            body { background-color: white !important; color: black !important; }
            .invoice-preview {
                background-color: white !important;
                color: black !important;
            }
            .invoice-preview *, .invoice-preview .text-gray-800 {
                color: black !important;
            }
        }
    </style>
</head>
<body class="dark-theme">
    <div class="main-layout">
        <aside class="sidebar no-print">
            <div class="flex justify-between items-center mb-6">
                <div class="flex items-center space-x-3">
                    <div class="bg-gradient-to-br from-blue-500 to-blue-700 p-2 rounded-lg shadow-lg">
                        <i data-lucide="file-text" class="w-6 h-6 text-white"></i>
                    </div>
                    <div>
                        <h1 class="font-bold text-lg tracking-wider">VINAYAKA</h1>
                        <p class="text-xs text-muted">INDUSTRIES</p>
                    </div>
                </div>
                <button id="theme-toggle" class="p-2 rounded-full transition-colors duration-300 hover:bg-black/10 dark:hover:bg-white/10">
                    <i id="theme-icon" data-lucide="sun" class="w-5 h-5 text-muted"></i>
                </button>
            </div>

            <nav class="flex-grow">
                <ul class="space-y-2">
                    <li><a href="#dashboard" class="nav-item active"><i data-lucide="layout-dashboard" class="w-5 h-5"></i><span>Dashboard</span></a></li>
                    <li><a href="#create-invoice" class="nav-item"><i data-lucide="file-plus" class="w-5 h-5"></i><span>Create Invoice</span></a></li>
                    <li><a href="#quotation" class="nav-item"><i data-lucide="file-check-2" class="w-5 h-5"></i><span>Quotation</span></a></li>
                    <li><a href="#invoice-history" class="nav-item"><i data-lucide="history" class="w-5 h-5"></i><span>History</span></a></li>
                    <li><a href="#customers" class="nav-item"><i data-lucide="users" class="w-5 h-5"></i><span>Customers</span></a></li>
                    <li><a href="#products" class="nav-item"><i data-lucide="package" class="w-5 h-5"></i><span>Products</span></a></li>
                    <li><a href="#reports" class="nav-item"><i data-lucide="bar-chart-3" class="w-5 h-5"></i><span>Reports</span></a></li>
                </ul>
            </nav>
             <div>
                <a href="#settings" class="nav-item"><i data-lucide="settings" class="w-5 h-5"></i><span>Settings</span></a>
              </div>
        </aside>

        <main class="main-content">
             <div id="dashboard" class="page">
                <div class="flex justify-between items-center mb-8 fade-in-up" style="animation-delay: 100ms;">
                    <div>
                        <h2 class="text-3xl font-bold">Invoice Generator Pro</h2>
                        <p class="text-muted">Create professional invoices with GST compliance</p>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span class="bg-green-500/20 text-green-400 text-xs font-semibold px-3 py-1 rounded-full flex items-center">
                            <div class="w-2 h-2 bg-green-500 rounded-full mr-2 animate-pulse"></div>GST Ready
                        </span>
                        <button onclick="syncData()" class="futuristic-btn futuristic-btn-neutral">
                            <i data-lucide="refresh-cw" class="w-4 h-4"></i><span>Sync</span>
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="glass-card p-6 fade-in-up" style="animation-delay: 200ms;">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-muted text-sm">TOTAL INVOICES</p>
                                <p class="text-3xl font-bold" id="stats-total-invoices">0</p>
                            </div>
                            <div class="bg-blue-500/20 p-3 rounded-lg"><i data-lucide="file-text" class="text-blue-400"></i></div>
                        </div>
                    </div>
                    <div class="glass-card p-6 fade-in-up" style="animation-delay: 300ms;">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-muted text-sm">REVENUE</p>
                                <p class="text-3xl font-bold" id="stats-revenue">₹0</p>
                            </div>
                            <div class="bg-green-500/20 p-3 rounded-lg"><i data-lucide="dollar-sign" class="text-green-400"></i></div>
                        </div>
                    </div>
                    <div class="glass-card p-6 fade-in-up" style="animation-delay: 400ms;">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-muted text-sm">ACTIVE CUSTOMERS</p>
                                <p class="text-3xl font-bold" id="stats-active-customers">0</p>
                            </div>
                            <div class="bg-yellow-500/20 p-3 rounded-lg"><i data-lucide="users" class="text-yellow-400"></i></div>
                        </div>
                    </div>
                    <div class="glass-card p-6 fade-in-up" style="animation-delay: 500ms;">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-muted text-sm">PRODUCTS</p>
                                <p class="text-3xl font-bold" id="stats-products">0</p>
                            </div>
                            <div class="bg-purple-500/20 p-3 rounded-lg"><i data-lucide="package" class="text-purple-400"></i></div>
                        </div>
                    </div>
                </div>

                <div class="glass-card p-6 fade-in-up" style="animation-delay: 600ms;">
                    <h3 class="text-xl font-bold mb-4">Quick Actions</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <a href="#create-invoice" class="nav-link-action futuristic-btn p-6 rounded-lg flex flex-col items-start justify-between text-left h-40">
                            <i data-lucide="file-plus" class="w-8 h-8 mb-4"></i>
                            <div>
                                <p class="font-bold text-lg">Create Invoice</p>
                                <p class="text-sm font-normal text-white/70">Generate GST invoice</p>
                            </div>
                        </a>
                        <a href="#customers" class="nav-link-action futuristic-btn futuristic-btn-secondary p-6 rounded-lg flex flex-col items-start justify-between text-left h-40">
                            <i data-lucide="user-plus" class="w-8 h-8 mb-4"></i>
                            <div>
                                <p class="font-bold text-lg">Add Customer</p>
                                <p class="text-sm font-normal text-white/70">Register new customer</p>
                            </div>
                        </a>
                        <a href="#products" class="nav-link-action futuristic-btn futuristic-btn-tertiary p-6 rounded-lg flex flex-col items-start justify-between text-left h-40">
                            <i data-lucide="package-plus" class="w-8 h-8 mb-4"></i>
                            <div>
                                <p class="font-bold text-lg">Add Product</p>
                                <p class="text-sm font-normal text-white/70">Manage inventory</p>
                            </div>
                        </a>
                    </div>
                </div>
            </div>

            <div id="create-invoice" class="page hidden">
                <div class="flex justify-between items-center mb-8">
                    <div>
                        <h2 class="text-3xl font-bold">Create Invoice</h2>
                        <p class="text-muted">Generate GST compliant invoices</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="glass-card p-8">
                        <h3 class="text-xl font-bold mb-6">Invoice Details</h3>
                        <form id="invoice-form" class="space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-muted mb-2">Invoice Number</label>
                                    <div class="relative">
                                        <input id="invoice-number" type="text" class="futuristic-input pr-10" readonly>
                                        <button type="button" onclick="refreshInvoiceNumber()" class="absolute inset-y-0 right-0 flex items-center pr-3 text-muted hover:text-blue-400 transition-colors" title="Refresh Invoice Number">
                                            <i data-lucide="refresh-cw" class="w-5 h-5"></i>
                                        </button>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-muted mb-2">Invoice Date</label>
                                    <input id="invoice-date" type="date" class="futuristic-input" required>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-muted mb-2">Select Customer</label>
                                <select id="customer-select" class="futuristic-select" required></select>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-muted mb-2">Customer GSTIN</label>
                                <input id="customer-gstin-display" type="text" class="futuristic-input bg-opacity-50" readonly>
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-muted mb-2">Place of Supply</label>
                                    <input id="place-of-supply-display" type="text" class="futuristic-input bg-opacity-50" readonly>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-muted mb-2">Dispatch</label>
                                    <select id="dispatch-method" class="futuristic-select">
                                        <option>By Transport</option>
                                        <option>By Self</option>
                                    </select>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-muted mb-2">Eway Bill #</label>
                                <input id="eway-bill-number" type="text" class="futuristic-input" placeholder="Enter E-Way Bill Number if applicable">
                            </div>
                        </form>

                        <div class="mt-8">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-bold">Invoice Items</h3>
                                <button onclick="addInvoiceItem()" class="futuristic-btn futuristic-btn-secondary px-4 py-2">
                                    <i data-lucide="plus" class="w-4 h-4"></i><span>Add Item</span>
                                </button>
                            </div>
                            <div id="invoice-items-container" class="space-y-4 max-h-[50vh] overflow-y-auto p-1">
                            </div>
                        </div>
                    </div>

                    <div class="p-2 rounded-lg">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-bold">Live Preview</h3>
                            <button onclick="resetInvoiceForm()" class="text-sm futuristic-btn futuristic-btn-neutral px-3 py-1">
                                <i data-lucide="rotate-cw" class="w-4 h-4"></i><span>Reset</span>
                            </button>
                        </div>
                        <div id="invoice-preview-container" class="border-2 border-dashed border-white/20 rounded-lg overflow-hidden">
                            <div id="invoice-preview" class="invoice-preview">
                                <div class="flex flex-col justify-center items-center text-center text-muted h-full p-6">
                                    <i data-lucide="file-text" class="w-16 h-16 mx-auto mb-4 opacity-50"></i>
                                    <p>Invoice preview will appear here</p>
                                    <p class="text-sm">Fill in the invoice details to see the live preview</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="invoice-history" class="page hidden">
                <div class="flex justify-between items-center mb-8">
                    <div>
                        <h2 class="text-3xl font-bold">History</h2>
                        <p class="text-muted">View and manage all documents</p>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div id="history-toggle" class="flex rounded-lg bg-slate-700 p-1">
                            <button class="px-4 py-1 text-sm rounded-md" data-type="invoices">Invoices</button>
                            <button class="px-4 py-1 text-sm rounded-md" data-type="quotations">Quotations</button>
                        </div>
                        <button onclick="syncData()" class="futuristic-btn futuristic-btn-neutral">
                            <i data-lucide="refresh-cw" class="w-4 h-4"></i><span>Load Data</span>
                        </button>
                    </div>
                </div>

                <div class="glass-card p-6">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead>
                                <tr class="table-header">
                                    <th class="p-4">Number</th>
                                    <th class="p-4">Date</th>
                                    <th class="p-4">Customer</th>
                                    <th class="p-4">Amount</th>
                                    <th class="p-4">Status</th>
                                    <th class="p-4">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="invoice-history-table">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="customers" class="page hidden">
                 <div class="flex justify-between items-center mb-8">
                    <div>
                        <h2 class="text-3xl font-bold">Customer Management</h2>
                        <p class="text-muted">Add and manage your customers</p>
                    </div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-1 glass-card p-8">
                        <h3 class="text-xl font-bold mb-6">Add New Customer</h3>
                        <form id="add-customer-form" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-muted mb-2">Company Name</label>
                                <input name="Customer Name" type="text" class="futuristic-input" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-muted mb-2">Address</label>
                                <textarea name="Address" rows="3" class="futuristic-textarea" required></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-muted mb-2">Contact Number</label>
                                <input name="contact" type="text" class="futuristic-input" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-muted mb-2">GSTIN</label>
                                <input name="Customer GSTIN" type="text" class="futuristic-input" required>
                            </div>
                            <button type="submit" class="w-full futuristic-btn futuristic-btn-secondary font-bold py-3 mt-4">Add Customer</button>
                        </form>
                    </div>
                    <div class="lg:col-span-2 glass-card p-8">
                        <h3 class="text-xl font-bold mb-6">Existing Customers</h3>
                        <div id="existing-customers-list" class="space-y-4 max-h-[60vh] overflow-y-auto pr-4">
                        </div>
                    </div>
                </div>
            </div>

            <div id="products" class="page hidden">
                <div class="flex justify-between items-center mb-8">
                    <div>
                        <h2 class="text-3xl font-bold">Inventory Management</h2>
                        <p class="text-muted">Add and manage your products</p>
                    </div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-1 glass-card p-8">
                        <h3 class="text-xl font-bold mb-6">Add New Product</h3>
                        <form id="add-product-form" class="space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-muted mb-2">Model</label>
                                    <input name="MODEL" type="text" class="futuristic-input" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-muted mb-2">Model Number</label>
                                    <input name="MODEL NUMBER" type="text" class="futuristic-input">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-muted mb-2">Device</label>
                                <input name="DEVICE" type="text" class="futuristic-input">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-muted mb-2">Size</label>
                                    <input name="SIZE" type="text" class="futuristic-input">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-muted mb-2">HSN/SAC</label>
                                    <input name="HSN/SAC" type="text" value="8413" class="futuristic-input" required>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-muted mb-2">Item Name</label>
                                <input name="ITEM NAME" type="text" class="futuristic-input" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-muted mb-2">Price (₹)</label>
                                <input name="PRICE" type="number" value="0" class="futuristic-input" required>
                            </div>
                             <div>
                                <label class="block text-sm font-medium text-muted mb-2">Availability</label>
                                <select name="AVAILABILITY" class="futuristic-select">
                                    <option value="Yes">Yes</option>
                                    <option value="No">No</option>
                                </select>
                            </div>
                            <button type="submit" class="w-full futuristic-btn futuristic-btn-secondary font-bold py-3 mt-4">Add Product</button>
                        </form>
                    </div>
                    <div class="lg:col-span-2 glass-card p-8">
                        <h3 class="text-xl font-bold mb-6">Existing Products</h3>
                        <div id="existing-products-list" class="space-y-4 max-h-[60vh] overflow-y-auto pr-4">
                        </div>
                    </div>
                </div>
            </div>

            <div id="reports" class="page hidden">
                 <div class="flex justify-between items-center mb-8">
                    <div>
                        <h2 class="text-3xl font-bold">Reports & Analytics</h2>
                        <p class="text-muted">GST returns and business insights</p>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="glass-card p-6">
                        <h3 class="text-lg font-bold mb-6">GSTR-1 Summary</h3>
                        <div class="space-y-2">
                            <div class="flex justify-between">
                                <span class="text-muted">B2B Supplies</span>
                                <span id="gstr1-b2b">₹0</span>
                            </div>
                             <div class="flex justify-between font-bold border-t pt-2 mt-2 border-white/10">
                                <span>Total Output Tax</span>
                                <span id="gstr1-total">₹0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="settings" class="page hidden">
                <div class="flex justify-between items-center mb-8">
                    <div>
                        <h2 class="text-3xl font-bold">Settings</h2>
                        <p class="text-muted">Manage application settings</p>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="glass-card p-8">
                        <h3 class="text-xl font-bold mb-6">Invoice Settings</h3>
                        <form id="invoice-settings-form" class="space-y-4">
                            <div>
                                <label for="invoice-prefix" class="block text-sm font-medium text-muted mb-2">Invoice Prefix</label>
                                <input id="invoice-prefix" type="text" class="futuristic-input" placeholder="e.g., INV-">
                            </div>
                            <div>
                                <label for="invoice-next-number" class="block text-sm font-medium text-muted mb-2">Next Invoice Number</label>
                                <input id="invoice-next-number" type="number" class="futuristic-input" placeholder="e.g., 101" min="1">
                            </div>
                            <p class="text-sm text-muted">Example: <span id="invoice-example" class="font-mono p-1 bg-black/20 rounded"></span></p>
                            <button type="submit" class="w-full futuristic-btn font-bold py-3 mt-4">Save Settings</button>
                        </form>
                    </div>

                    <div class="glass-card p-8">
                        <h3 class="text-xl font-bold mb-6">Company Settings</h3>
                        <form id="company-settings-form" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-muted mb-2">Company Name</label>
                                <input id="company-name" type="text" value="Vinayaka Industries" class="futuristic-input">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-muted mb-2">Company Address</label>
                                <textarea id="company-address" rows="3" class="futuristic-textarea"></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-muted mb-2">Company GSTIN</label>
                                <input id="company-gstin" type="text" class="futuristic-input">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-muted mb-2">Contact Number</label>
                                <input id="company-contact" type="text" class="futuristic-input">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-muted mb-2">Email</label>
                                <input id="company-email" type="email" class="futuristic-input">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-muted mb-2">Terms & Conditions</label>
                                <textarea id="company-terms" rows="4" class="futuristic-textarea" placeholder="Enter default terms and conditions for invoices..."></textarea>
                            </div>
                            <button type="submit" class="w-full futuristic-btn futuristic-btn-secondary font-bold py-3 mt-4">Save Company Info</button>
                        </form>
                    </div>

                    <div class="glass-card p-8">
                        <h3 class="text-xl font-bold mb-6">Bank Details</h3>
                        <form id="bank-settings-form" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-muted mb-2">Bank Name</label>
                                <input id="bank-name" type="text" class="futuristic-input">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-muted mb-2">Account Number</label>
                                <input id="bank-account-number" type="text" class="futuristic-input">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-muted mb-2">IFSC Code</label>
                                <input id="bank-ifsc-code" type="text" class="futuristic-input">
                            </div>
                            <button type="submit" class="w-full futuristic-btn futuristic-btn-tertiary font-bold py-3 mt-4">Save Bank Details</button>
                        </form>
                    </div>
                </div>
            </div>

            <div id="quotation" class="page hidden">
                <div class="flex justify-between items-center mb-8">
                    <div>
                        <h2 class="text-3xl font-bold">Create Quotation</h2>
                        <p class="text-muted">Generate a new estimate for a customer</p>
                    </div>
                </div>
                 </div>
        </main>
    </div>
    <footer class="fixed-footer no-print page-footer hidden" data-page="create-invoice">
        <a href="#settings" class="nav-link-action futuristic-btn futuristic-btn-neutral"><i data-lucide="settings" class="w-5 h-5"></i>Settings</a>
        <button onclick="previewInvoice()" class="futuristic-btn futuristic-btn-secondary"><i data-lucide="eye" class="w-5 h-5"></i>Preview Live</button>
        <button onclick="handleLoadData()" class="futuristic-btn futuristic-btn-neutral"><i data-lucide="upload-cloud" class="w-5 h-5"></i>Load Data</button>
        <button onclick="generatePDF()" class="futuristic-btn"><i data-lucide="file-down" class="w-5 h-5"></i>Generate</button>
    </footer>
     <footer class="fixed-footer no-print page-footer hidden" data-page="quotation">
     </footer>

    <script>
        lucide.createIcons();

        // --- THEME TOGGLE ---
        const themeToggle = document.getElementById('theme-toggle');
        const setTheme = (isDark) => {
            document.body.className = isDark ? 'dark-theme' : 'light-theme';
            document.getElementById('theme-icon').setAttribute('data-lucide', isDark ? 'sun' : 'moon');
            lucide.createIcons();
            localStorage.setItem('invoiceAppTheme', isDark ? 'dark' : 'light');
        };
        themeToggle.onclick = () => setTheme(!document.body.classList.contains('dark-theme'));
        
        // --- APP LOGIC ---
        const GET_API_URL = 'https://script.google.com/macros/s/AKfycbytvxDO1jlUxa289NXACCuRj0osY4Idep6WXaNC_rJ9WR_6h1pUYfWpBdtsI-AfuGkB/exec';
        const POST_API_URL = '/.netlify/functions/proxy'; 

        let customers = [], allProducts = [], invoiceItems = [], invoiceHistory = [], quotationHistory = [], currentInvoiceNumber = 'VI-001';

        window.onload = () => {
            try {
                setTheme(localStorage.getItem('invoiceAppTheme') !== 'light');
                showPage(window.location.hash.substring(1) || 'dashboard');
                init();
            } catch (e) {
                console.error("Critical error on load:", e);
                showToast("A critical error occurred.", "error");
            }
        };

        function postData(payload) {
            return fetch(POST_API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            }).then(r => r.json());
        }

        function showToast(title, icon = 'success') {
            const isDark = document.body.classList.contains('dark-theme');
            Swal.mixin({
                toast: true, position: 'top-end', showConfirmButton: false, timer: 3000, timerProgressBar: true,
                background: isDark ? '#1e293b' : '#f1f5f9', color: isDark ? '#f8fafc' : '#0f172a',
                didOpen: (toast) => { toast.onmouseenter = Swal.stopTimer; toast.onmouseleave = Swal.resumeTimer; }
            }).fire({ icon, title });
        }
        
        const navLinks = document.querySelectorAll('.nav-item, .nav-link-action');
        const pages = document.querySelectorAll('.page');
        const footers = document.querySelectorAll('.page-footer');

        function showPage(pageId) {
            pages.forEach(page => page.classList.add('hidden'));
            footers.forEach(footer => footer.classList.add('hidden'));

            const activePage = document.getElementById(pageId);
            if (activePage) activePage.classList.remove('hidden');

            const activeFooter = document.querySelector(`.page-footer[data-page="${pageId}"], .page-footer[data-page="${pageId.split('-')[0]}"]`);
            if (activeFooter) activeFooter.classList.remove('hidden');

            document.querySelectorAll('.nav-item').forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('href') === `#${pageId}`) link.classList.add('active');
            });
        }
        navLinks.forEach(link => link.addEventListener('click', (e) => {
            e.preventDefault();
            const pageId = link.getAttribute('href').substring(1);
            showPage(pageId);
            window.location.hash = pageId;
        }));

        async function init() {
            setupEventListeners();
            loadInvoiceSettings();
            loadCompanySettings();
            loadBankSettings();
            initializeInvoiceForm();
            await syncData(true); // Pass true for initial load
        }
        
        function processAllData(data, isInitialLoad = false) {
             customers = data.customers || [];
             allProducts = (data.products || []).map((p, index) => ({
                ...p, 
                row_index: index,
                uniqueModel: `${p.MODEL || ''} ${p['MODEL NUMBER'] || ''}`.trim().toUpperCase(),
                uniqueItemName: `${p.SIZE || ''} ${p['ITEM NAME'] || ''}`.trim().toUpperCase()
            }));

             invoiceHistory = data.invoiceHistory || [];
             quotationHistory = data.quotationHistory || [];
             
             // Only set a new invoice number on initial load or after a reset
             if (isInitialLoad) {
                const settings = JSON.parse(localStorage.getItem('invoiceConfig') || '{}');
                const prefix = settings.prefix || 'VI-';
                let nextNum;

                const latestNumStr = String(data.latestInvoiceNumber || '');
                if (latestNumStr) {
                    const numericPart = parseInt(latestNumStr.replace(/[^0-9]/g, ''), 10);
                    nextNum = isNaN(numericPart) ? (settings.nextNumber || 1) : numericPart + 1;
                } else {
                    nextNum = settings.nextNumber || (invoiceHistory.length + 1);
                }
                
                currentInvoiceNumber = `${prefix}${String(nextNum).padStart(3, '0')}`;
                document.getElementById('invoice-number').value = currentInvoiceNumber;
             }
             
             renderCustomerList();
             renderProductList();
             updateDashboardStats();
             populateCustomerSelect();
             renderInvoiceHistory();

             document.querySelectorAll('.invoice-item').forEach((item, index) => {
                 populateModelDropdown(index);
             });
        }

        function setupEventListeners() {
            document.getElementById('add-customer-form').addEventListener('submit', handleAddCustomerFormSubmit);
            document.getElementById('add-product-form').addEventListener('submit', handleAddProductFormSubmit);
            document.getElementById('invoice-settings-form').addEventListener('submit', handleInvoiceSettingsFormSubmit);
            document.getElementById('company-settings-form').addEventListener('submit', handleCompanySettingsFormSubmit);
            document.getElementById('bank-settings-form').addEventListener('submit', handleBankSettingsFormSubmit);
            
            document.getElementById('invoice-prefix').addEventListener('input', updateInvoiceExample);
            document.getElementById('invoice-next-number').addEventListener('input', updateInvoiceExample);
            document.getElementById('invoice-form').addEventListener('input', updateInvoicePreview);
            document.getElementById('customer-select').addEventListener('change', populateCustomerDetails);
        }

        function initializeInvoiceForm() {
            const today = new Date();
            document.getElementById('invoice-date').value = today.toISOString().split('T')[0];
            if (invoiceItems.length === 0) addInvoiceItem();
        }
        
        function addInvoiceItem() {
            const container = document.getElementById('invoice-items-container');
            const itemIndex = invoiceItems.length;
            const itemHtml = `<div class="invoice-item bg-black/10 dark:bg-white/5 p-4 rounded-xl space-y-3" data-index="${itemIndex}">
                <div class="flex justify-between items-center"><h4 class="font-semibold">Item ${itemIndex + 1}</h4><button type="button" onclick="removeInvoiceItem(${itemIndex})" class="text-red-400 hover:text-red-300"><i data-lucide="x-circle" class="w-5 h-5"></i></button></div>
                <div class="grid grid-cols-2 gap-3">
                    <select class="item-model futuristic-select text-sm" onchange="updateDependentDropdowns(${itemIndex})"><option value="">SELECT MODEL</option></select>
                    <select class="item-device futuristic-select text-sm" onchange="updateDependentDropdowns(${itemIndex})"><option value="">(BLANK)</option><option value="SWING DEVICE">SWING DEVICE</option><option value="TRAVEL DEVICE">TRAVEL DEVICE</option></select>
                </div>
                <select class="item-name futuristic-select text-sm" onchange="populateItemDetails(${itemIndex})"><option value="">SELECT ITEM NAME</option></select>
                <div class="grid grid-cols-6 gap-2 text-sm">
                    <input type="text" class="item-hsn futuristic-input col-span-2" placeholder="HSN/SAC" readonly>
                    <input type="number" class="item-rate futuristic-input" placeholder="Rate" readonly>
                    <input type="number" class="item-quantity futuristic-input" value="1" min="1" oninput="calculateItemTotal(${itemIndex})" placeholder="Qty">
                    <input type="number" class="item-discount futuristic-input" value="0" min="0" max="100" oninput="calculateItemTotal(${itemIndex})" placeholder="Disc %">
                    <input type="number" class="item-tax-rate futuristic-input" value="18" oninput="calculateItemTotal(${itemIndex})" placeholder="Tax %">
                </div>
                <input type="number" class="item-total futuristic-input bg-opacity-50" placeholder="Total" readonly>
            </div>`;
            container.insertAdjacentHTML('beforeend', itemHtml);
            invoiceItems.push({ quantity: 1, rate: 0, discount: 0, taxRate: 18 });
            lucide.createIcons();
            populateModelDropdown(itemIndex);
        }

        function removeInvoiceItem(index) {
            invoiceItems.splice(index, 1);
            const itemElement = document.querySelector(`.invoice-item[data-index="${index}"]`);
            if (itemElement) itemElement.remove();

            document.querySelectorAll('.invoice-item').forEach((element, newIndex) => {
                element.dataset.index = newIndex;
                element.querySelector('h4').textContent = `Item ${newIndex + 1}`;
                const removeBtn = element.querySelector('button');
                if (removeBtn) removeBtn.setAttribute('onclick', `removeInvoiceItem(${newIndex})`);
                element.querySelector('.item-model').setAttribute('onchange', `updateDependentDropdowns(${newIndex})`);
                element.querySelector('.item-device').setAttribute('onchange', `updateDependentDropdowns(${newIndex})`);
                element.querySelector('.item-name').setAttribute('onchange', `populateItemDetails(${newIndex})`);
                element.querySelectorAll('input[oninput]').forEach(inp => inp.setAttribute('oninput', `calculateItemTotal(${newIndex})`));
            });

            if (invoiceItems.length === 0) addInvoiceItem();
            updateInvoicePreview();
        }

        function populateModelDropdown(index) {
            const models = [...new Set(allProducts.map(p => p.uniqueModel).filter(Boolean))];
            const select = document.querySelector(`[data-index="${index}"] .item-model`);
            if (!select) return;
            select.innerHTML = '<option value="">SELECT MODEL</option>';
            models.forEach(model => {
                select.innerHTML += `<option value="${model}">${model}</option>`;
            });
        }

        function updateDependentDropdowns(index) {
            const itemElement = document.querySelector(`[data-index="${index}"]`);
            const modelSelect = itemElement.querySelector('.item-model');
            const deviceSelect = itemElement.querySelector('.item-device');
            const nameSelect = itemElement.querySelector('.item-name');
            const selectedModel = modelSelect.value.toUpperCase();
            const selectedDevice = deviceSelect.value.toUpperCase();
            
            const items = allProducts.filter(p => {
                const modelMatch = p.uniqueModel.toUpperCase() === selectedModel;
                const deviceValue = (p.DEVICE || '').trim().toUpperCase();
                const deviceMatch = selectedDevice === "" ? deviceValue === "" : deviceValue === selectedDevice;
                return modelMatch && deviceMatch;
            });

            nameSelect.innerHTML = '<option value="">SELECT ITEM NAME</option>';
            const uniqueItems = [...new Map(items.map(item => [item.uniqueItemName, item])).values()];

            uniqueItems.forEach(item => {
                nameSelect.innerHTML += `<option value="${item.row_index}">${item.uniqueItemName}</option>`;
            });

            // Clear details when dropdowns change
            itemElement.querySelector('.item-hsn').value = '';
            itemElement.querySelector('.item-rate').value = '';
            calculateItemTotal(index);
        }

        function populateItemDetails(index) {
            const itemElement = document.querySelector(`[data-index="${index}"]`);
            const nameSelect = itemElement.querySelector('.item-name');
            const selectedProductId = nameSelect.value;
            const product = allProducts.find(p => p.row_index == selectedProductId);

            itemElement.querySelector('.item-hsn').value = product ? '8431' : '';
            itemElement.querySelector('.item-rate').value = product ? (product.PRICE || '') : '';
            calculateItemTotal(index);
        }

        function calculateItemTotal(index) {
            const itemElement = document.querySelector(`[data-index="${index}"]`);
            if (!itemElement) return;

            const quantity = parseFloat(itemElement.querySelector('.item-quantity').value || 1);
            const rate = parseFloat(itemElement.querySelector('.item-rate').value || 0);
            const discount = parseFloat(itemElement.querySelector('.item-discount').value || 0);
            const taxRate = parseFloat(itemElement.querySelector('.item-tax-rate').value || 0);

            const subTotal = quantity * rate;
            const discountAmount = subTotal * (discount / 100);
            const taxableAmount = subTotal - discountAmount;
            const taxAmount = taxableAmount * (taxRate / 100);
            const total = taxableAmount + taxAmount;
            
            itemElement.querySelector('.item-total').value = total > 0 ? total.toFixed(2) : '';
            
            if (invoiceItems[index]) {
                const product = allProducts.find(p => p.row_index == itemElement.querySelector('.item-name').value);
                let fullDescription = '';
                if (product) {
                    const descriptionParts = [
                        product.MODEL,
                        product['MODEL NUMBER'],
                        product.DEVICE,
                        product.SIZE,
                        product['ITEM NAME']
                    ];
                    fullDescription = descriptionParts.filter(Boolean).join('_');
                }
                invoiceItems[index] = { ...invoiceItems[index], quantity, rate, discount, taxRate, taxableAmount, taxAmount, total, hsn: "8431", description: fullDescription };
            }
            updateInvoicePreview();
        }

        function populateCustomerSelect() {
            const select = document.getElementById('customer-select');
            if (!select) return;
            const currentVal = select.value;
            select.innerHTML = '<option value="">Select a customer...</option>';
            customers.forEach(customer => {
                select.innerHTML += `<option value="${customer['Customer Name']}">${customer['Customer Name']}</option>`;
            });
            select.value = currentVal;
        }

        function populateCustomerDetails() {
            const selectedName = document.getElementById('customer-select').value;
            const customer = customers.find(c => c['Customer Name'] === selectedName);
            if (customer) {
                document.getElementById('customer-gstin-display').value = customer['Customer GSTIN'] || 'N/A';
                document.getElementById('place-of-supply-display').value = customer['Address'] || 'N/A';
            } else {
                document.getElementById('customer-gstin-display').value = '';
                document.getElementById('place-of-supply-display').value = '';
            }
            updateInvoicePreview();
        }
        
        function updateInvoicePreview() {
            const preview = document.getElementById('invoice-preview');
            const customerName = document.getElementById('customer-select').value;
            const selectedCustomer = customers.find(c => c['Customer Name'] === customerName);
            const companySettings = JSON.parse(localStorage.getItem('companySettings') || '{}');
            const bankSettings = JSON.parse(localStorage.getItem('bankSettings') || '{}');
            
            if (!selectedCustomer || invoiceItems.length === 0 || invoiceItems.every(i => !i.description)) {
                 preview.innerHTML = `<div class="p-6 flex flex-col justify-center items-center text-center text-muted h-full"><i data-lucide="file-text" class="w-16 h-16 mx-auto mb-4 opacity-50"></i><p>Invoice preview will appear here</p><p class="text-sm">Fill in the invoice details to see live preview</p></div>`;
                 lucide.createIcons();
                 return;
            }

            const invoiceDate = document.getElementById('invoice-date').value;
            let totalTaxableAmount = 0, totalTax = 0, grandTotal = 0;

            const itemsHtml = invoiceItems.filter(item => item.description).map((item, index) => {
                totalTaxableAmount += item.taxableAmount || 0;
                totalTax += item.taxAmount || 0;
                grandTotal += item.total || 0;
                return `<tr class="border-b text-xs"><td class="p-2 text-center">${index + 1}</td><td class="p-2">${item.description}</td><td class="p-2 text-center">${item.hsn}</td><td class="p-2 text-center">${item.quantity}</td><td class="p-2 text-right">₹${(item.rate || 0).toFixed(2)}</td><td class="p-2 text-right">₹${(item.taxableAmount || 0).toFixed(2)}</td></tr>`;
            }).join('');
            
            const taxRate = invoiceItems.length > 0 ? invoiceItems[0].taxRate : 0;
            const isIntraState = (companySettings.gstin || '').substring(0, 2) === (selectedCustomer['Customer GSTIN'] || '').substring(0, 2);
            let taxRows = isIntraState
                ? `<tr><td colspan="5" class="p-2 text-right font-semibold">CGST (${taxRate/2}%):</td><td class="p-2 text-right font-semibold">₹${(totalTax / 2).toFixed(2)}</td></tr>
                   <tr><td colspan="5" class="p-2 text-right font-semibold">SGST (${taxRate/2}%):</td><td class="p-2 text-right font-semibold">₹${(totalTax / 2).toFixed(2)}</td></tr>`
                : `<tr><td colspan="5" class="p-2 text-right font-semibold">IGST (${taxRate}%):</td><td class="p-2 text-right font-semibold">₹${totalTax.toFixed(2)}</td></tr>`;
            
            const grandTotalInWords = amountToWords(grandTotal);
            const termsAndConditions = (companySettings.terms || `1. Goods once sold will not be taken back.
2. Interest @18% p.a. will be charged if the bill is not paid within 30 days.
3. All disputes are subject to jurisdiction of local courts.`).replace(/\n/g, '<br>');

            preview.innerHTML = `<div class="p-8">
                <header class="pb-4 mb-4 border-b-2 border-dotted"><div class="flex justify-between items-start">
                    <div class="flex items-start space-x-4">
                        <img src="https://drive.google.com/uc?id=1L_NG4hUWi56GAaSTWBYFyau5cpG2Pb7W" alt="Logo" class="h-16">
                        <div>
                            <h2 class="text-xl font-bold text-gray-800">VINAYAKA INDUSTRIES</h2>
                            <p class="text-xs max-w-xs">${companySettings.address}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="font-bold text-gray-800">GSTIN: ${companySettings.gstin}</p>
                        <h1 class="text-2xl font-bold mt-2 text-gray-800">TAX INVOICE</h1>
                    </div>
                </div></header>
                <div class="flex justify-between text-sm border-b-2 border-dotted pb-4 mb-4">
                    <div class="w-1/2">
                        <strong class="block mb-2">Bill To:</strong>
                        <table><tbody>
                            <tr><td class="pr-2 font-bold">Name</td><td>: ${selectedCustomer['Customer Name']}</td></tr>
                            <tr><td class="pr-2 font-bold">Address</td><td>: ${selectedCustomer.Address}</td></tr>
                            <tr><td class="pr-2 font-bold">GSTIN</td><td>: ${selectedCustomer['Customer GSTIN']}</td></tr>
                        </tbody></table>
                    </div>
                    <div class="w-1/2">
                         <table><tbody>
                            <tr><td class="pr-2 font-bold">Invoice #</td><td>: ${document.getElementById('invoice-number').value}</td></tr>
                            <tr><td class="pr-2 font-bold">Date</td><td>: ${new Date(invoiceDate).toLocaleDateString('en-GB')}</td></tr>
                            <tr><td class="pr-2 font-bold">Dispatch</td><td>: ${document.getElementById('dispatch-method').value}</td></tr>
                            <tr><td class="pr-2 font-bold">Eway Bill #</td><td>: ${document.getElementById('eway-bill-number').value || '_________________'}</td></tr>
                         </tbody></table>
                    </div>
                </div>
                <table class="w-full text-sm mb-2">
                    <thead><tr class="table-header text-xs"><th class="p-2 text-left">#</th><th class="p-2 text-left">Item</th><th class="p-2 text-center">HSN</th><th class="p-2 text-center">Qty</th><th class="p-2 text-right">Unit Price</th><th class="p-2 text-right">Taxable Amount</th></tr></thead>
                    <tbody>${itemsHtml}</tbody>
                </table>
                <div class="flex justify-end">
                    <table class="w-1/2 text-sm">
                        <tbody>
                            <tr><td colspan="5" class="p-2 text-right font-semibold border-t-2">Subtotal:</td><td class="p-2 text-right font-semibold border-t-2">₹${totalTaxableAmount.toFixed(2)}</td></tr>
                            ${taxRows}
                            <tr class="bg-blue-500/10"><td colspan="5" class="p-3 text-right text-lg font-bold">Grand Total:</td><td class="p-3 text-right text-lg font-bold">₹${grandTotal.toFixed(2)}</td></tr>
                        </tbody>
                    </table>
                </div>
                <div class="border-t-2 border-dotted pt-2 mt-2 text-xs font-semibold">Amount in Words: ${grandTotalInWords}</div>
                <div class="mt-6 pt-4 border-t-2 border-dotted text-xs">
                    <p class="font-bold mb-2">Terms & Conditions:</p>
                    <p>${termsAndConditions}</p>
                </div>
                <div class="flex justify-between mt-8">
                    <div class="text-xs"><p class="font-bold">Bank Details:</p><div><p>Bank: ${bankSettings.name || ''}</p><p>Acc No: ${bankSettings.accountNumber || ''}</p><p>IFSC: ${bankSettings.ifsc || ''}</p></div></div>
                    <div class="text-center text-xs pt-8">
                        <p class="border-t pt-2">For Vinayaka Industries</p><p>(Authorized Signatory)</p>
                    </div>
                </div>
            </div>`;
        }

        async function generatePDF() {
            Swal.fire({ title: 'Generating PDF...', text: 'Please wait while we create your document.', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

            const element = document.getElementById('invoice-preview');
            const opt = { margin: 0.25, filename: `${document.getElementById('invoice-number').value}.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2, logging: false, useCORS: true }, jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }};
            
            try {
                await html2pdf().set(opt).from(element).save();
                Swal.close(); 
                showToast('PDF Generated Successfully!', 'success');
            } catch (error) {
                Swal.close(); 
                showToast('PDF generation failed. Check console.', 'error');
                console.error("PDF Generation Error:", error);
            }
        }
        
        function getInvoiceDataForPost() {
            if (!document.getElementById('customer-select').value) {
                showToast('Please select a customer.', 'error'); return null;
            }
            if (invoiceItems.some(i => !i.description)) {
                showToast('Please select a valid product for all items.', 'error'); return null;
            }

            const totalTaxableValue = invoiceItems.reduce((sum, item) => sum + (item.taxableAmount || 0), 0);
            const isIntraState = (document.getElementById('customer-gstin-display').value || '').substring(0, 2) === (JSON.parse(localStorage.getItem('companySettings') || '{}').gstin || '').substring(0, 2);
            const totalTax = invoiceItems.reduce((sum, item) => sum + (item.taxAmount || 0), 0);
            const grandTotal = invoiceItems.reduce((sum, item) => sum + (item.total || 0), 0);
            
            return {
                invoiceData: {
                    invoiceNumber: document.getElementById('invoice-number').value, date: document.getElementById('invoice-date').value,
                    customerName: document.getElementById('customer-select').value,
                    totalTaxableValue: totalTaxableValue.toFixed(2), 
                    totalCGST: (isIntraState ? totalTax / 2 : 0).toFixed(2), 
                    totalSGST: (isIntraState ? totalTax / 2 : 0).toFixed(2), 
                    totalIGST: (!isIntraState ? totalTax : 0).toFixed(2),
                    grandTotal: grandTotal.toFixed(2),
                    status: 'unpaid'
                },
                items: JSON.parse(JSON.stringify(invoiceItems))
            };
        }

        async function saveInvoiceRecord(invoiceDataForPost, action = 'addInvoice') {
             try {
                const response = await postData({ action: action, data: invoiceDataForPost });
                if (response.status === 'success') {
                    await syncData(); 
                    showToast(`Invoice ${action === 'addInvoice' ? 'added' : 'updated'} successfully!`, 'success');
                } else { throw new Error(response.message || 'Failed to save on server.'); }
            } catch (error) {
                showToast(`Save failed: ${error.message}`, 'error');
                throw error; 
            }
        }
        
        async function handleLoadData() {
            const invoiceDataForPost = getInvoiceDataForPost();
            if (!invoiceDataForPost) return; 

            const invoiceNumber = invoiceDataForPost.invoiceData.invoiceNumber;
            const existingInvoice = invoiceHistory.find(inv => inv.invoiceNumber === invoiceNumber);

            if (existingInvoice) {
                Swal.fire({
                    title: 'Invoice Exists',
                    text: `Invoice number ${invoiceNumber} is already in your history. Do you want to replace it with the current data?`,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Yes, replace it!',
                    cancelButtonText: 'No, cancel',
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                }).then((result) => {
                    if (result.isConfirmed) {
                        Swal.fire({
                            title: 'Final Confirmation',
                            text: 'Are you sure you want to submit and overwrite the existing invoice?',
                            icon: 'question',
                            showCancelButton: true,
                            confirmButtonText: 'SUBMIT Invoice',
                        }).then(async (finalResult) => {
                            if (finalResult.isConfirmed) {
                                Swal.fire({ title: 'Updating...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
                                try {
                                    await saveInvoiceRecord(invoiceDataForPost, 'updateInvoice');
                                    Swal.close();
                                } catch (e) {
                                    Swal.close();
                                    showToast('Update failed!', 'error');
                                }
                            }
                        });
                    }
                });
            } else {
                Swal.fire({ title: 'Loading Data...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
                try {
                    await saveInvoiceRecord(invoiceDataForPost, 'addInvoice');
                    Swal.close();
                } catch(e) {
                     Swal.close();
                     showToast('Load data failed!', 'error');
                }
            }
        }

        async function refreshInvoiceNumber() {
            showToast('Refreshing invoice number...', 'info');
            await syncData(true); // Pass true to force a new number generation
        }

        function resetInvoiceForm() {
            document.getElementById('invoice-form').reset();
            populateCustomerDetails();
            const container = document.getElementById('invoice-items-container');
            container.innerHTML = '';
            invoiceItems = []; 
            initializeInvoiceForm(); 
            updateInvoicePreview();
            refreshInvoiceNumber();
        }

        function previewInvoice() { updateInvoicePreview(); showToast('Preview updated!', 'info'); }

        function renderInvoiceHistory() {
            const tbody = document.getElementById('invoice-history-table');
            if (!tbody) return;

            if (!invoiceHistory || invoiceHistory.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" class="p-8 text-center text-muted">No invoice history found.</td></tr>`;
                return;
            }

            tbody.innerHTML = invoiceHistory.map((invoice, index) => {
                const amount = parseFloat(invoice.amount || 0);
                const status = invoice.status || 'unpaid';

                return `<tr class="table-row hover:bg-black/10 dark:hover:bg-white/5">
                            <td class="p-4">${invoice.invoiceNumber}</td>
                            <td class="p-4">${new Date(invoice.date).toLocaleDateString('en-IN')}</td>
                            <td class="p-4">${invoice.customerName}</td>
                            <td class="p-4">₹${amount.toFixed(2)}</td>
                            <td class="p-4"><span class="px-2 py-1 rounded text-xs ${status === 'paid' ? 'text-green-400 bg-green-500/20' : 'text-yellow-400 bg-yellow-500/20'}">${status.toUpperCase()}</span></td>
                            <td class="p-4">
                                <button onclick="loadInvoiceForEditing(${index})" class="text-blue-400 hover:text-blue-300" title="Edit Invoice">
                                    <i data-lucide="edit"></i>
                                </button>
                            </td>
                        </tr>`;
            }).join('');
            lucide.createIcons();
        }

        function loadInvoiceForEditing(index) {
            Swal.fire({
                title: 'Are you sure?',
                text: "Do you want to edit this invoice? Any unsaved changes in the current form will be lost.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Yes, edit it!',
                cancelButtonText: 'No, cancel'
            }).then((result) => {
                if (result.isConfirmed) {
                    const invoiceToEdit = invoiceHistory[index];
                    if (!invoiceToEdit || !invoiceToEdit.fullInvoiceJSON) {
                        showToast('Could not load invoice data.', 'error');
                        return;
                    }

                    try {
                        const fullData = JSON.parse(invoiceToEdit.fullInvoiceJSON);
                        const invoiceData = fullData.invoiceData;
                        const itemsData = fullData.items;

                        showPage('create-invoice');
                        window.location.hash = 'create-invoice';

                        document.getElementById('invoice-number').value = invoiceData.invoiceNumber;
                        document.getElementById('invoice-date').value = invoiceData.date;
                        document.getElementById('customer-select').value = invoiceData.customerName;
                        populateCustomerDetails();

                        const container = document.getElementById('invoice-items-container');
                        container.innerHTML = '';
                        invoiceItems = [];

                        itemsData.forEach(itemData => {
                            addInvoiceItem();
                            const newIndex = invoiceItems.length - 1;
                            const itemElement = document.querySelector(`.invoice-item[data-index="${newIndex}"]`);
                            
                            const originalProduct = allProducts.find(p => {
                                const fullProductName = [p.MODEL, p['MODEL NUMBER'], p.DEVICE, p.SIZE, p['ITEM NAME']].filter(Boolean).join('_');
                                return fullProductName === itemData.description;
                            });

                            if (originalProduct) {
                                itemElement.querySelector('.item-model').value = originalProduct.uniqueModel;
                                updateDependentDropdowns(newIndex);
                                itemElement.querySelector('.item-device').value = originalProduct.DEVICE || '';
                                updateDependentDropdowns(newIndex);
                                itemElement.querySelector('.item-name').value = originalProduct.row_index;
                                
                                populateItemDetails(newIndex); 
                                
                                itemElement.querySelector('.item-quantity').value = itemData.quantity;
                                itemElement.querySelector('.item-discount').value = itemData.discount;
                                
                                calculateItemTotal(newIndex);
                            }
                        });

                        showToast(`Loaded Invoice ${invoiceData.invoiceNumber} for editing.`, 'info');
                        updateInvoicePreview();

                    } catch (error) {
                        console.error("Error parsing invoice data for editing:", error);
                        showToast('Failed to parse invoice data.', 'error');
                    }
                }
            });
        }


        function renderCustomerList() {
            const listEl = document.getElementById('existing-customers-list');
            if(listEl) listEl.innerHTML = customers.map(c => `<div class="p-4 rounded-lg bg-black/10 dark:bg-white/5"><p class="font-bold">${c['Customer Name']}</p><p class="text-sm text-muted">${c.Address}</p><p class="text-sm text-muted">GSTIN: ${c['Customer GSTIN']}</p></div>`).join('');
        }

        function renderProductList() {
             const listEl = document.getElementById('existing-products-list');
             if(listEl) listEl.innerHTML = allProducts.map(p => `<div class="p-4 rounded-lg bg-black/10 dark:hover:bg-white/5 flex justify-between items-center"><div><p class="font-bold">${p.MODEL || ''} ${p['MODEL NUMBER'] || ''}</p><p class="text-sm text-muted">${p.DEVICE || ''} - ${p['ITEM NAME'] || ''}</p><p class="text-lg font-semibold text-amber-400">₹${(p.PRICE || 0).toFixed(2)}</p></div><p class="text-sm text-muted">HSN: ${p['HSN/SAC'] || 'N/A'}</p></div>`).join('');
        }
        
        function animateCountUp(element, endValue, isCurrency = false) {
            let startValue = 0;
            const duration = 1500;
            const startTime = performance.now();

            function easeOutCubic(t) { return 1 - Math.pow(1 - t, 3); }

            function frame(currentTime) {
                const elapsedTime = currentTime - startTime;
                if (elapsedTime > duration) {
                    element.textContent = (isCurrency ? '₹' : '') + endValue.toLocaleString('en-IN', isCurrency ? {minimumFractionDigits: 2, maximumFractionDigits: 2} : {});
                    return;
                }
                const progress = easeOutCubic(elapsedTime / duration);
                const currentValue = startValue + (endValue - startValue) * progress;
                
                element.textContent = (isCurrency ? '₹' : '') + (isCurrency ? currentValue.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : Math.round(currentValue).toLocaleString('en-IN'));
                requestAnimationFrame(frame);
            }
            requestAnimationFrame(frame);
        }

        function updateDashboardStats() {
            const totalRevenue = invoiceHistory.reduce((sum, inv) => sum + (parseFloat(inv.amount) || 0), 0);
            animateCountUp(document.getElementById('stats-total-invoices'), invoiceHistory.length);
            animateCountUp(document.getElementById('stats-revenue'), totalRevenue, true);
            animateCountUp(document.getElementById('stats-active-customers'), customers.length);
            animateCountUp(document.getElementById('stats-products'), allProducts.length);
        }

        function handleAddCustomerFormSubmit(e) { e.preventDefault(); showToast('Add new customers via the Google Sheet, then press Sync.', 'info'); }
        function handleAddProductFormSubmit(e) { e.preventDefault(); showToast('Add new products via the Google Sheet, then press Sync.', 'info'); }
        
        function handleInvoiceSettingsFormSubmit(e) {
            e.preventDefault();
            const config = { prefix: document.getElementById('invoice-prefix').value, nextNumber: parseInt(document.getElementById('invoice-next-number').value) };
            localStorage.setItem('invoiceConfig', JSON.stringify(config));
            showToast('Invoice settings saved!');
            loadInvoiceSettings();
        }

        function handleCompanySettingsFormSubmit(e) {
            e.preventDefault();
            const companyData = {
                name: document.getElementById('company-name').value, address: document.getElementById('company-address').value,
                gstin: document.getElementById('company-gstin').value, contact: document.getElementById('company-contact').value,
                email: document.getElementById('company-email').value,
                terms: document.getElementById('company-terms').value
            };
            localStorage.setItem('companySettings', JSON.stringify(companyData));
            showToast('Company settings saved!');
            updateInvoicePreview();
        }

        function handleBankSettingsFormSubmit(e) {
            e.preventDefault();
            const bankData = {
                name: document.getElementById('bank-name').value, 
                accountNumber: document.getElementById('bank-account-number').value,
                ifsc: document.getElementById('bank-ifsc-code').value
            };
            localStorage.setItem('bankSettings', JSON.stringify(bankData));
            showToast('Bank details saved!');
        }

        function loadInvoiceSettings() {
            const config = JSON.parse(localStorage.getItem('invoiceConfig') || '{}');
            document.getElementById('invoice-prefix').value = config.prefix || 'VI-';
            document.getElementById('invoice-next-number').value = config.nextNumber || 1;
            updateInvoiceExample();
        }

        function loadCompanySettings() {
            const settings = JSON.parse(localStorage.getItem('companySettings') || '{}');
            document.getElementById('company-name').value = settings.name || 'Vinayaka Industries';
            document.getElementById('company-address').value = settings.address || '';
            document.getElementById('company-gstin').value = settings.gstin || '';
            document.getElementById('company-contact').value = settings.contact || '';
            document.getElementById('company-email').value = settings.email || '';
            document.getElementById('company-terms').value = settings.terms || '';
        }

        function loadBankSettings() {
            const settings = JSON.parse(localStorage.getItem('bankSettings') || '{}');
            document.getElementById('bank-name').value = settings.name || '';
            document.getElementById('bank-account-number').value = settings.accountNumber || '';
            document.getElementById('bank-ifsc-code').value = settings.ifsc || '';
        }

        function updateInvoiceExample() {
            const prefix = document.getElementById('invoice-prefix').value;
            const nextNumber = document.getElementById('invoice-next-number').value;
            document.getElementById('invoice-example').textContent = `${prefix}${String(nextNumber).padStart(3, '0')}`;
        }
        
        function amountToWords(amount) {
            const a = ['','one ','two ','three ','four ', 'five ','six ','seven ','eight ','nine ','ten ','eleven ','twelve ','thirteen ','fourteen ','fifteen ','sixteen ','seventeen ','eighteen ','nineteen '];
            const b = ['', '', 'twenty','thirty','forty','fifty', 'sixty','seventy','eighty','ninety'];
            const number = parseFloat(amount).toFixed(2).split(".");
            const main = parseInt(number[0]);
            const decimal = parseInt(number[1]);
            
            function inWords(num) {
                if ((num = num.toString()).length > 9) return 'overflow';
                const n = ('000000000' + num).substr(-9).match(/^(\d{2})(\d{2})(\d{2})(\d{1})(\d{2})$/);
                if (!n) return ''; let str = '';
                str += (n[1] != 0) ? (a[Number(n[1])] || b[n[1][0]] + ' ' + a[n[1][1]]) + 'crore ' : '';
                str += (n[2] != 0) ? (a[Number(n[2])] || b[n[2][0]] + ' ' + a[n[2][1]]) + 'lakh ' : '';
                str += (n[3] != 0) ? (a[Number(n[3])] || b[n[3][0]] + ' ' + a[n[3][1]]) + 'thousand ' : '';
                str += (n[4] != 0) ? (a[Number(n[4])] || b[n[4][0]] + ' ' + a[n[4][1]]) + 'hundred ' : '';
                str += (n[5] != 0) ? ((str != '') ? 'and ' : '') + (a[Number(n[5])] || b[n[5][0]] + ' ' + a[n[5][1]]) : '';
                return str;
            }

            let mainInWords = inWords(main);
            let decimalInWords = inWords(decimal);
            
            let result = mainInWords ? mainInWords.trim() + ' rupees' : '';
            if(decimalInWords) {
                result += (result ? ' and ' : '') + decimalInWords.trim() + ' paise';
            }
            return result.toUpperCase() + ' ONLY';
        }

        function fetchJSONP(url) {
            return new Promise((resolve, reject) => {
                const callbackName = '__jsonp_cb_' + Date.now() + Math.random().toString(36).substring(2);
                const script = document.createElement('script');

                const timeout = setTimeout(() => {
                    delete window[callbackName];
                    if (document.head.contains(script)) document.head.removeChild(script);
                    reject(new Error('JSONP request timed out'));
                }, 15000);

                window[callbackName] = (data) => {
                    clearTimeout(timeout);
                    delete window[callbackName];
                    if (document.head.contains(script)) document.head.removeChild(script);
                    resolve(data);
                };

                script.src = `${url}${url.includes('?') ? '&' : '?'}callback=${callbackName}`;
                script.onerror = () => reject(new Error('JSONP script failed to load'));
                document.head.appendChild(script);
            });
        }

        async function syncData(isInitialLoad = false) {
            showToast('Syncing from Google Sheets...', 'info');

            if (!GET_API_URL || GET_API_URL.includes('PASTE_YOUR')) {
                showToast('API URL is not configured. Please edit the HTML file.', 'error');
                return;
            }

            try {
                const result = await fetchJSONP(`${GET_API_URL}?action=getAllData`);

                if (result.status !== 'success') {
                    throw new Error(result.message || 'Failed to fetch data from API');
                }
                
                processAllData(result.data, isInitialLoad);
                showToast('Live data loaded!', 'success');
            } catch (error) {
                console.error("Error fetching live data:", error);
                showToast(`Could not fetch live data: ${error.message}`, "error");
            }
        }
    </script>
</body>
</html>
