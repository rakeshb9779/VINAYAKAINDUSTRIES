<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>nvoiceForge Pro - Advanced GST Invoice Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        :root {
            --primary-rgb: 14 185 166;
            --primary-dark-rgb: 15 118 110;
            --bg-light: 240 253 250;
            --text-light: 30 41 59;
            --card-bg-light: rgba(255, 255, 255, 0.6);
            --card-border-light: rgba(14, 185, 166, 0.2);
            --input-bg-light: rgba(255, 255, 255, 0.7);
            --input-border-light: rgba(14, 185, 166, 0.3);
            --invoice-bg-light: white;
            --table-header-bg-light: #f8fafc;
            --text-muted-light: #64748b;
            --border-light: #94a3b8;
            --bg-dark: #0d1a1e;
            --text-dark: #cbd5e1;
            --card-bg-dark: rgba(15, 23, 42, 0.5);
            --card-border-dark: rgba(14, 185, 166, 0.3);
            --input-bg-dark: rgba(30, 41, 59, 0.5);
            --input-border-dark: rgba(14, 185, 166, 0.4);
            --invoice-bg-dark: #1e293b;
            --table-header-bg-dark: #334155;
            --text-muted-dark: #94a3b8;
            --border-dark: #64748b;
        }
        * { box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; transition: background-color 0.5s ease, color 0.5s ease; overflow-x: hidden;}
        body.light-theme { background-color: rgb(var(--bg-light)); color: rgb(var(--text-light)); }
        body.dark-theme { background-color: var(--bg-dark); color: var(--text-dark); }
        .main-layout { display: flex; height: 100vh; }
        .sidebar {
            width: 35%; height: 100vh; position: fixed; top: 0; left: 0;
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            padding: 2rem; overflow-y: auto; transition: background-color 0.5s ease, border-color 0.5s ease;
        }
        body.light-theme .sidebar { background-color: var(--card-bg-light); border-right: 1px solid var(--card-border-light); }
        body.dark-theme .sidebar { background-color: var(--card-bg-dark); border-right: 1px solid var(--card-border-dark); }
        .main-content { width: 65%; margin-left: 35%; padding: 2rem; padding-bottom: 100px; overflow-y: auto; }
        .glass-card {
            border-radius: 20px; padding: 1.25rem; border: 1px solid;
            box-shadow: 0 8px 32px rgba(var(--primary-rgb), 0.1);
            margin-bottom: 1.5rem; transition: background-color 0.5s ease, border-color 0.5s ease;
        }
        body.light-theme .glass-card { background-color: var(--card-bg-light); border-color: var(--card-border-light); }
        body.dark-theme .glass-card { background-color: var(--card-bg-dark); border-color: var(--card-border-dark); }
        .futuristic-input {
            border: 2px solid; border-radius: 12px; padding: 12px 16px;
            transition: all 0.3s ease; font-weight: 500; width: 100%;
        }
        body.light-theme .futuristic-input { background-color: var(--input-bg-light); border-color: var(--input-border-light); color: var(--text-light); }
        body.dark-theme .futuristic-input { background-color: var(--input-bg-dark); border-color: var(--input-border-dark); color: var(--text-dark); }
        .futuristic-input:focus { border-color: rgb(var(--primary-rgb)); box-shadow: 0 0 0 4px rgba(var(--primary-rgb), 0.2); outline: none; }
        body.light-theme .futuristic-input:focus { background-color: white; }
        body.dark-theme .futuristic-input:focus { background-color: #334155; }
        .section-header {
            background: linear-gradient(135deg, rgb(var(--primary-rgb)) 0%, rgb(var(--primary-dark-rgb)) 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
            font-weight: 800; font-size: 1.5rem; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.75rem;
        }
        .fixed-footer {
            position: fixed; bottom: 0; left: 0; width: 100%;
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            padding: 1rem 2rem; display: flex; justify-content: center; align-items: center; gap: 1rem;
            z-index: 100; transition: background-color 0.5s ease, border-color 0.5s ease;
        }
        body.light-theme .fixed-footer { background-color: var(--card-bg-light); border-top: 1px solid var(--card-border-light); }
        body.dark-theme .fixed-footer { background-color: var(--card-bg-dark); border-top: 1px solid var(--card-border-dark); }
        .footer-btn {
            background: linear-gradient(135deg, rgb(var(--primary-rgb)) 0%, rgb(var(--primary-dark-rgb)) 100%);
            border: none; border-radius: 12px; color: white; font-weight: 600; padding: 12px 24px;
            transition: all 0.3s ease; cursor: pointer; display: flex; align-items: center; gap: 0.5rem;
        }
        .footer-btn:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(var(--primary-rgb), 0.2); }
        .footer-btn.settings-btn, .footer-btn.load-btn { background: linear-gradient(135deg, #64748b 0%, #334155 100%); }
        .footer-btn.settings-btn:hover, .footer-btn.load-btn:hover { box-shadow: 0 10px 20px rgba(51, 65, 85, 0.2); }
        #invoice-preview-container { display: flex; flex-direction: column; gap: 1rem; }
        .invoice-page {
            width: 100%;
            aspect-ratio: 1 / 1.414;
            padding: 2rem; border-radius: 12px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.1);
            transition: background-color 0.5s ease, border-color 0.5s ease;
            display: flex; flex-direction: column;
            border: 1px solid;
            font-size: 0.9rem;
        }
        body.light-theme .invoice-page { background-color: var(--invoice-bg-light); border-color: var(--border-light); }
        body.dark-theme .invoice-page { background-color: var(--invoice-bg-dark); border-color: var(--border-dark); }
        body.dark-theme .invoice-page .text-slate-900 { color: white; }
        body.dark-theme .invoice-page .text-slate-800 { color: var(--text-dark); }
        body.dark-theme .invoice-page .text-slate-700 { color: var(--text-muted-dark); }
        body.dark-theme .invoice-page .text-slate-600, body.dark-theme #invoice-preview .text-slate-500 { color: var(--text-muted-dark); }
        body.dark-theme .invoice-page .border-slate-300 { border-color: var(--border-dark); }
        .invoice-table { width: 100%; border-collapse: collapse; border: 1px solid; }
        body.light-theme .invoice-table { border-color: var(--border-light); }
        body.dark-theme .invoice-table { border-color: var(--border-dark); }
        .invoice-table th, .invoice-table td {
            border-right: 1px solid;
            padding: 6px; text-align: left; font-size: 0.75rem;
        }
        body.light-theme .invoice-table th, body.light-theme .invoice-table td { border-color: var(--border-light); }
        body.dark-theme .invoice-table th, body.dark-theme .invoice-table td { border-color: var(--border-dark); }
        .invoice-table th:last-child, .invoice-table td:last-child { border-right: none; }
        .invoice-table thead tr { border-bottom: 1px solid; }
        body.light-theme .invoice-table thead tr { border-color: var(--border-light); }
        body.dark-theme .invoice-table thead tr { border-color: var(--border-dark); }
        .invoice-table th { font-weight: 600; }
        body.light-theme .invoice-table th { background-color: #e2e8f0; color: #334155; }
        body.dark-theme .invoice-table th { background-color: var(--table-header-bg-dark); color: var(--text-dark); }
        .searchable-dropdown { position: relative; }
        .searchable-dropdown-content {
            position: absolute; top: 100%; left: 0; right: 0; border: 1px solid; border-radius: 12px;
            max-height: 200px; overflow-y: auto; z-index: 1000; display: none;
        }
        body.light-theme .searchable-dropdown-content { background-color: white; border-color: #e2e8f0; }
        body.dark-theme .searchable-dropdown-content { background-color: #334155; border-color: #475569; }
        .searchable-dropdown-content div { padding: 10px 15px; cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        body.light-theme .searchable-dropdown-content div:hover { background-color: #f1f5f9; }
        body.dark-theme .searchable-dropdown-content div:hover { background-color: #475569; }
        .fade-in-item { animation: fadeIn 0.5s ease-out forwards; opacity: 0; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in-item:nth-child(1) { animation-delay: 0.1s; } .fade-in-item:nth-child(2) { animation-delay: 0.2s; }
        .fade-in-item:nth-child(3) { animation-delay: 0.3s; }
        ::-webkit-scrollbar { width: 8px; } ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: rgb(var(--primary-rgb)); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: rgb(var(--primary-dark-rgb)); }
        .app-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(5px); z-index: 1000; display: flex; align-items: center; justify-content: center; opacity: 0; visibility: hidden; transition: all 0.3s ease; }
        .app-modal.active { opacity: 1; visibility: visible; }
        .modal-content { background: white; border-radius: 20px; max-width: 90vw; max-height: 90vh; overflow: auto; position: relative; padding: 2rem; transform: scale(0.8); transition: transform 0.3s ease; box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25); }
        .app-modal.active .modal-content { transform: scale(1); }
        body.dark-theme .modal-content { background-color: var(--invoice-bg-dark); }
        @media print {
            body * { visibility: hidden; }
            .sidebar, .fixed-footer { display: none; }
            .main-content { width: 100%; margin: 0; padding: 0; }
            #invoice-preview-container, #invoice-preview-container * { visibility: visible; }
            .invoice-page {
                box-shadow: none; border: 1px solid #333 !important; margin: 0;
                font-size: 9px;
            }
            .invoice-page:not(:last-child) { page-break-after: always; }
        }
    </style>
</head>
<body class="dark-theme">
    <div class="main-layout">
        <aside class="sidebar">
            <div class="fade-in-item flex justify-between items-center">
                <img src="https://drive.google.com/uc?id=1L_NG4hUWi56GAaSTWBYFyau5cpG2Pb7W" alt="VINAYAKA INDUSTRIES LOGO" class="h-12 mb-6 rounded-xl shadow-lg">
                <button id="theme-toggle" class="p-2 rounded-full transition-colors duration-300">
                    <i id="theme-icon" data-lucide="moon" class="w-6 h-6 text-slate-500"></i>
                </button>
            </div>
            <section class="glass-card fade-in-item">
                <h2 class="section-header"><i data-lucide="user-round" class="w-6 h-6"></i>Customer Details</h2>
                <div class="space-y-3">
                    <input type="text" id="customer-name" class="futuristic-input" list="customer-names-datalist" onblur="populateCustomerDetails()" placeholder="Customer Name">
                    <datalist id="customer-names-datalist"></datalist>
                    <input type="text" id="customer-gstin" class="futuristic-input" oninput="updateInvoice()" placeholder="Customer GSTIN">
                    <textarea id="customer-address" class="futuristic-input" rows="2" oninput="updateInvoice()" placeholder="Place of Delivery"></textarea>
                </div>
            </section>
            <section class="glass-card fade-in-item">
                <h2 class="section-header"><i data-lucide="package-plus" class="w-6 h-6"></i>Items</h2>
                <div id="items-container" class="space-y-4"></div>
                <div id="no-items-message" class="text-center italic p-4" style="display: none;">No items added.</div>
                <button type="button" onclick="addItem()" class="footer-btn mt-4 w-full"><i data-lucide="plus" class="w-5 h-5"></i>Add Item</button>
            </section>
        </aside>
        <main class="main-content">
            <div id="invoice-preview-container">
                <!-- Invoice pages will be rendered here by JS -->
            </div>
        </main>
    </div>
    <footer class="fixed-footer">
        <button onclick="updateInvoice()" class="footer-btn"><i data-lucide="eye" class="w-5 h-5"></i>Preview Live</button>
        <button onclick="printInvoice()" class="footer-btn"><i data-lucide="printer" class="w-5 h-5"></i>Print</button>
        <button onclick="downloadPDF()" class="footer-btn"><i data-lucide="file-down" class="w-5 h-5"></i>Download</button>
        <button onclick="saveInvoice()" class="footer-btn"><i data-lucide="save" class="w-5 h-5"></i>Save</button>
        <button onclick="showSettings()" class="footer-btn settings-btn"><i data-lucide="settings" class="w-5 h-5"></i>Settings</button>
    </footer>
    <!-- Settings Modal -->
    <div id="settings-modal" class="app-modal">
        <div class="modal-content">
            <button onclick="hideSettings()" class="absolute top-4 right-4 z-10 bg-red-500 hover:bg-red-600 text-white rounded-full p-2"><i data-lucide="x" class="w-6 h-6"></i></button>
            <h2 class="text-3xl font-black mb-6 text-center"><span class="section-header">App Settings</span></h2>
            <input type="hidden" id="settings-invoice-date"><input type="hidden" id="settings-due-date"><input type="hidden" id="settings-invoice-number">
            <section class="glass-card p-6 mb-6">
                <h3 class="section-header text-2xl"><i data-lucide="building" class="w-5 h-5"></i>Company Details</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- COMPANY NAME field intentionally removed to use LOGO only -->
                    <input type="text" id="settings-company-gstin" class="futuristic-input" oninput="updateSettings()" placeholder="Company GSTIN">
                    <input type="text" id="settings-company-state" class="futuristic-input" oninput="updateSettings()" placeholder="State">
                    <input type="text" id="settings-company-state-code" class="futuristic-input" oninput="updateSettings()" placeholder="State Code">
                    <input type="text" id="settings-company-contact" class="futuristic-input" oninput="updateSettings()" placeholder="Contact No.">
                    <input type="email" id="settings-company-email" class="futuristic-input" oninput="updateSettings()" placeholder="Email">
                    <div class="md:col-span-2"><textarea id="settings-company-address" class="futuristic-input w-full" rows="2" oninput="updateSettings()" placeholder="Address"></textarea></div>
                </div>
                <div class="mt-4">
                    <label for="settings-invoice-prefix" class="block mb-1 font-bold text-slate-600">Start Invoice From</label>
                    <input type="text" id="settings-invoice-prefix" class="futuristic-input" oninput="updateSettings()" placeholder="E.g. VI-001">
                </div>
            </section>
            <section class="glass-card p-6 mb-6">
                <h3 class="section-header text-2xl"><i data-lucide="banknote" class="w-5 h-5"></i>Bank & Payment</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input type="text" id="settings-bank-name" class="futuristic-input" oninput="updateSettings()" placeholder="Bank Name">
                    <input type="text" id="settings-account-number" class="futuristic-input" oninput="updateSettings()" placeholder="Account Number">
                    <input type="text" id="settings-ifsc-code" class="futuristic-input" oninput="updateSettings()" placeholder="IFSC Code">
                    <input type="text" id="settings-swift-code" class="futuristic-input" oninput="updateSettings()" placeholder="SWIFT Code">
                    <div class="md:col-span-2"><textarea id="settings-payment-terms" class="futuristic-input w-full" rows="2" oninput="updateSettings()" placeholder="Payment Terms"></textarea></div>
                    <div class="md:col-span-2"><textarea id="settings-notes" class="futuristic-input w-full" rows="2" oninput="updateSettings()" placeholder="Notes / Remarks"></textarea></div>
                </div>
            </section>
            <div class="text-center"><button onclick="hideSettings()" class="footer-btn text-lg"><i data-lucide="check-circle" class="w-6 h-6"></i>Done</button></div>
        </div>
    </div>
    <script>
        // Proxy function path
        const GOOGLE_APPS_SCRIPT_URL = '/.netlify/functions/proxy';
        const CUSTOMERS_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRFxJyIv-_4zkNDXwmv5dYgWE-LRybVLKayk8jmiUCdbuL1XX4Ac0DuU5ip1jZmo-GaDQwWUhJFw8Pt/pub?gid=1988877295&single=true&output=csv';
        const PRODUCTS_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRFxJyIv-_4zkNDXwmv5dYgWE-LRybVLKayk8jmiUCdbuL1XX4Ac0DuU5ip1jZmo-GaDQwWUhJFw8Pt/pub?gid=0&single=true&output=csv';
        let invoiceData = {}, items = [], nextItemId = 1, customerData = [], productData = [], appSettings = {}, invoiceHistory = [];
        const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 3000, timerProgressBar: true, didOpen:t=>{t.onmouseenter=Swal.stopTimer;t.onmouseleave=Swal.resumeTimer} });
        const showSuccess = m => Toast.fire({ icon: 'success', title: m, background: 'var(--bg-light)', color: 'rgb(var(--primary-dark-rgb))' });
        const showError = m => Toast.fire({ icon: 'error', title: m, background: '#fee2e2', color: '#991b1b' });
        const escapeHtml = t => String(t).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'})[m]);
        function showSettings() {
            Object.keys(appSettings).forEach(key => {
                const el = document.getElementById(`settings-${key.replace(/([A-Z])/g, "-$1").toLowerCase()}`);
                if (el) el.value = appSettings[key];
            });
            document.getElementById('settings-invoice-number').value = invoiceData.invoiceNumber;
            document.getElementById('settings-invoice-date').value = invoiceData.invoiceDate;
            document.getElementById('settings-due-date').value = invoiceData.dueDate;
            document.getElementById('settings-modal').classList.add('active');
        }
        function hideSettings() {
            document.getElementById('settings-modal').classList.remove('active');
            updateInvoice();
        }
        function updateSettings() {
            document.querySelectorAll('#settings-modal [id^="settings-"]').forEach(el => {
                const key = el.id.replace('settings-', '').replace(/-(\w)/g, (m, p1) => p1.toUpperCase());
                if (key in appSettings) appSettings[key] = el.value;
                else if (key in invoiceData) invoiceData[key] = el.value;
            });
            // update starting invoice prefix too
            if (document.getElementById('settings-invoice-prefix')) {
                appSettings.invoicePrefix = document.getElementById('settings-invoice-prefix').value;
            }
            saveDataToLocalStorage();
        }
        async function fetchCsvData(url, dataName) {
            Swal.fire({ title: `Loading ${dataName}...`, html: '<div class="loading"></div>', allowOutsideClick: false, showConfirmButton: false, background: 'var(--card-bg-dark)', color: 'var(--text-dark)' });
            return new Promise((resolve, reject) => {
                Papa.parse(url, { download: true, header: true,
                    complete: r => { Swal.close(); const d = r.data.filter(row => Object.values(row).some(v => v)); resolve(d); showSuccess(`${dataName} loaded!`); },
                    error: e => { Swal.close(); showError(`Failed to load ${dataName}`); reject(e); }
                });
            });
        }
        function populateCustomerDetails() {
            const name = document.getElementById('customer-name').value;
            const found = customerData.find(c => c['Customer Name']?.toLowerCase() === name.toLowerCase());
            document.getElementById('customer-gstin').value = found?.['Customer GSTIN'] || '';
            document.getElementById('customer-address').value = found?.Address || '';
            if(found) showSuccess(`Customer loaded!`);
            updateInvoice();
        }
        function populateProductDetails(itemId) {
            const item = items.find(i => i.id === itemId); if (!item) return;
            // Model+ModelNumber format
            const found = productData.find(p =>
                (p.MODEL + " " + (p["MODEL NUMBER"] || "")).trim().toLowerCase() === (item.model || "").toLowerCase() &&
                p.DEVICE?.toLowerCase() === (item.device || "").toLowerCase() &&
                (p.SIZE + ' | ' + p['ITEM NAME'])?.toLowerCase() === (item.itemName || "").toLowerCase()
            );
            if (found) {
                item.description = [
                    (found.MODEL + " " + (found["MODEL NUMBER"] || "")).trim(),
                    found.DEVICE, found['ITEM NAME'], found.SIZE
                ].filter(Boolean).join(' - ');
                item.hsnSac = found['HSN/SAC'] || '8431';
                item.rate = parseFloat(found.PRICE || 0).toFixed(2);
                item.gstRate = parseFloat(found.GST_Rate || 18).toFixed(2);
            } else {
                item.description = ''; item.hsnSac = ''; item.rate = '0.00'; item.gstRate = '18.00';
            }
            const row = document.getElementById(`item-row-${itemId}`);
            row.querySelector('[name="full-description"]').value = item.description;
            row.querySelector('[name="hsn-sac"]').value = item.hsnSac;
            row.querySelector('[name="rate"]').value = item.rate;
            updateInvoice();
        }
        function populateDropdownOptions(select, options, defaultText, selected) {
            select.innerHTML = `<option value="">${defaultText}</option>` + options.map(opt => `<option value="${escapeHtml(opt)}" ${selected?.toLowerCase() === opt.toLowerCase() ? 'selected' : ''}>${escapeHtml(opt).toUpperCase()}</option>`).join('');
        }
        function renderSpecificItemDropdowns(item) {
            const row = document.getElementById(`item-row-${item.id}`); if (!row) return;
            // Model: combine MODEL + MODEL NUMBER and show unique
            const allModels = [...new Set(productData.map(p => ((p.MODEL + " " + (p["MODEL NUMBER"] || "")).trim())).filter(Boolean))].sort();
            populateDropdownOptions(row.querySelector('[name="model-select"]'), allModels, 'Select Model', item.model);
            const devices = [...new Set(productData.filter(p =>
                ((p.MODEL + " " + (p["MODEL NUMBER"] || "")).trim()) === item.model
            ).map(p => p.DEVICE).filter(Boolean))].sort();
            populateDropdownOptions(row.querySelector('[name="device-select"]'), devices, 'Select Device', item.device);
        }
        function addItem() { items.push({ id: nextItemId++, quantity: '1', discount: '0' }); renderItems(); updateInvoice(); }
        function removeItem(id) { items = items.filter(i => i.id !== id); renderItems(); updateInvoice(); }
        function updateItemField(id, field, value) { const item = items.find(i => i.id === id); if (item) { item[field] = value; updateInvoice(); } }
        function updateProductSelection(itemId, field, value) {
            const item = items.find(i => i.id === itemId); if (!item) return;
            item[field] = value;
            if (field === 'model') { item.device = ''; item.itemName = ''; }
            if (field === 'device') { item.itemName = ''; }
            const row = document.getElementById(`item-row-${itemId}`);
            if(field === 'model') renderSpecificItemDropdowns(item);
            if(field === 'device') { const searchInput = row.querySelector('.searchable-input'); searchInput.value = ''; }
            populateProductDetails(itemId);
        }
        function renderItems() {
            const container = document.getElementById('items-container');
            container.innerHTML = '';
            document.getElementById('no-items-message').style.display = items.length === 0 ? 'block' : 'none';
            items.forEach(item => {
                const itemRowHtml = `
                    <div id="item-row-${item.id}" class="glass-card p-3 relative">
                        <div class="grid grid-cols-2 gap-3">
                            <div><select name="model-select" class="futuristic-input text-sm p-2"></select></div>
                            <div><select name="device-select" class="futuristic-input text-sm p-2"></select></div>
                            <div class="col-span-2 searchable-dropdown">
                                <input type="text" name="item-name-search" class="futuristic-input searchable-input text-sm p-2" placeholder="Search & Select Item Name">
                                <div class="searchable-dropdown-content"></div>
                            </div>
                            <div class="col-span-2"><input type="text" name="full-description" class="futuristic-input bg-opacity-50 text-xs p-2" readonly placeholder="Full Description"></div>
                            <div class="col-span-2 grid grid-cols-4 gap-2">
                                <input type="text" name="hsn-sac" class="futuristic-input bg-opacity-50 text-sm p-2" readonly placeholder="HSN">
                                <input type="number" name="quantity" class="futuristic-input text-sm p-2" value="${item.quantity}" min="0" placeholder="Qty">
                                <input type="number" name="rate" class="futuristic-input bg-opacity-50 text-sm p-2" readonly placeholder="Rate">
                                <input type="number" name="discount" class="futuristic-input text-sm p-2" value="${item.discount || 0}" min="0" max="100" placeholder="Disc %">
                            </div>
                        </div>
                        <button type="button" onclick="removeItem(${item.id})" class="absolute top-2 right-2 bg-red-500 hover:bg-red-600 text-white rounded-full p-1"><i data-lucide="x" class="w-4 h-4"></i></button>
                    </div>`;
                container.insertAdjacentHTML('beforeend', itemRowHtml);
                const row = document.getElementById(`item-row-${item.id}`);
                row.querySelector('[name="model-select"]').onchange = e => updateProductSelection(item.id, 'model', e.target.value);
                row.querySelector('[name="device-select"]').onchange = e => updateProductSelection(item.id, 'device', e.target.value);
                row.querySelector('[name="quantity"]').oninput = e => updateItemField(item.id, 'quantity', e.target.value);
                row.querySelector('[name="discount"]').oninput = e => updateItemField(item.id, 'discount', e.target.value);
                const searchInput = row.querySelector('.searchable-input');
                const dropdownContent = row.querySelector('.searchable-dropdown-content');
                searchInput.onfocus = () => filterItemNames(item.id, '');
                searchInput.oninput = () => filterItemNames(item.id, searchInput.value);
                document.addEventListener('click', (e) => { if (!row.contains(e.target)) dropdownContent.style.display = 'none'; });
                renderSpecificItemDropdowns(item);
                populateProductDetails(item.id);
            });
            lucide.createIcons();
        }
        function filterItemNames(itemId, searchTerm) {
            const item = items.find(i => i.id === itemId); if (!item) return;
            const row = document.getElementById(`item-row-${itemId}`);
            const dropdownContent = row.querySelector('.searchable-dropdown-content');
            // Model + Model Number filtering
            const itemNames = [...new Set(productData
                .filter(p => ((p.MODEL + " " + (p["MODEL NUMBER"] || "")).trim()) === item.model && p.DEVICE === item.device && (p.SIZE + ' | ' + p['ITEM NAME'])?.toLowerCase().includes(searchTerm.toLowerCase()))
                .map(p => p.SIZE + ' | ' + p['ITEM NAME']).filter(Boolean))].sort();
            dropdownContent.innerHTML = itemNames.map(name => `<div data-name="${escapeHtml(name)}">${escapeHtml(name)}</div>`).join('');
            dropdownContent.style.display = 'block';
            dropdownContent.querySelectorAll('div').forEach(div => {
                div.onclick = () => {
                    row.querySelector('.searchable-input').value = div.dataset.name;
                    dropdownContent.style.display = 'none';
                    updateProductSelection(itemId, 'itemName', div.dataset.name);
                };
            });
        }
        const units = ['', 'one', 'two', 'three', 'four', 'five', 'six', 'seven', 'eight', 'nine'];
        const teens = ['ten', 'eleven', 'twelve', 'thirteen', 'fourteen', 'fifteen', 'sixteen', 'seventeen', 'eighteen', 'nineteen'];
        const tens = ['', '', 'twenty', 'thirty', 'forty', 'fifty', 'sixty', 'seventy', 'eighty', 'ninety'];
        function numToWords(n) {
            if (n < 10) return units[n];
            if (n >= 10 && n < 20) return teens[n - 10];
            if (n < 100) return tens[Math.floor(n / 10)] + (n % 10 !== 0 ? ' ' + units[n % 10] : '');
            if (n < 1000) return units[Math.floor(n / 100)] + ' hundred' + (n % 100 !== 0 ? ' and ' + numToWords(n % 100) : '');
            return '';
        }
        function convertToWordsIndian(num) {
            num = Math.floor(num); if (num === 0) return 'zero';
            let words = [];
            let crore = Math.floor(num / 10000000); if (crore > 0) { words.push(numToWords(crore) + ' crore'); num %= 10000000; }
            let lakh = Math.floor(num / 100000); if (lakh > 0) { words.push(numToWords(lakh) + ' lakh'); num %= 100000; }
            let thousand = Math.floor(num / 1000); if (thousand > 0) { words.push(numToWords(thousand) + ' thousand'); num %= 1000; }
            if (num > 0) { words.push(numToWords(num)); }
            return words.join(' ').trim();
        }
        function convertAmountToWords(amount) {
            const amountFloat = parseFloat(amount); if (isNaN(amountFloat)) return 'ZERO RUPEES ONLY';
            const [rupees, paise] = amountFloat.toFixed(2).split('.').map(Number);
            let words = convertToWordsIndian(rupees) + ' rupees';
            if (paise > 0) { words += ' and ' + convertToWordsIndian(paise) + ' paise'; }
            return words.toUpperCase();
        }
        // --- Invoice Number Management ---
        function parseInvoiceParts(invoiceString) {
            const match = invoiceString.match(/^([^\d]*)(\d+)$/);
            if (match) return { prefix: match[1], number: parseInt(match[2], 10), length: match[2].length };
            return { prefix: invoiceString, number: 1, length: 3 }; // fallback
        }
        function getNextInvoiceNumber(current, manual) {
            if (manual) return manual;
            let { prefix, number, length } = parseInvoiceParts(current || appSettings.invoicePrefix || 'VI-001');
            let nextNum = (number + 1).toString().padStart(length, '0');
            return `${prefix}${nextNum}`;
        }
        // --- END Invoice Number Management ---
        function updateInvoice() {
            invoiceData.customerName = document.getElementById('customer-name').value;
            invoiceData.customerAddress = document.getElementById('customer-address').value;
            invoiceData.customerGSTIN = document.getElementById('customer-gstin').value;
            // Invoice Number dynamic logic
            let manualInvoiceNo = invoiceData.invoiceNumber && invoiceData.invoiceNumber !== appSettings.invoicePrefix ? invoiceData.invoiceNumber : '';
            invoiceData.invoiceNumber = manualInvoiceNo || (invoiceData.invoiceNumber || appSettings.invoicePrefix || 'VI-001');
            // GST Calculation
            let totalTaxableValue = 0, totalCGST = 0, totalSGST = 0, totalIGST = 0;
            const karnatakaStateCode = "29";
            const buyerStateCode = invoiceData.customerGSTIN?.substring(0, 2);
            invoiceData.isInterstate = buyerStateCode !== karnatakaStateCode && !!buyerStateCode;
            items.forEach(item => {
                const preDiscountAmount = (parseFloat(item.quantity) || 0) * (parseFloat(item.rate) || 0);
                const discountAmount = preDiscountAmount * (parseFloat(item.discount || 0) / 100);
                const taxableValue = preDiscountAmount - discountAmount;
                item.taxableValue = taxableValue.toFixed(2);
                totalTaxableValue += taxableValue;
                const gstRate = parseFloat(item.gstRate) || 0;
                item.igstAmount = '0.00'; item.cgstAmount = '0.00'; item.sgstAmount = '0.00';
                if (invoiceData.isInterstate) {
                    item.igstAmount = (taxableValue * gstRate / 100).toFixed(2); totalIGST += parseFloat(item.igstAmount);
                } else {
                    item.cgstAmount = (taxableValue * gstRate / 200).toFixed(2); totalCGST += parseFloat(item.cgstAmount);
                    item.sgstAmount = (taxableValue * gstRate / 200).toFixed(2); totalSGST += parseFloat(item.sgstAmount);
                }
                item.lineTotal = (taxableValue + parseFloat(item.igstAmount) + parseFloat(item.cgstAmount) + parseFloat(item.sgstAmount)).toFixed(2);
            });
            invoiceData.totalTaxableValue = totalTaxableValue.toFixed(2);
            invoiceData.totalIGST = totalIGST.toFixed(2);
            invoiceData.totalCGST = totalCGST.toFixed(2);
            invoiceData.totalSGST = totalSGST.toFixed(2);
            const grandTotal = totalTaxableValue + totalIGST + totalCGST + totalSGST;
            const roundedGrandTotal = Math.round(grandTotal);
            invoiceData.roundOff = (roundedGrandTotal - grandTotal).toFixed(2);
            invoiceData.grandTotal = roundedGrandTotal.toFixed(2);
            invoiceData.grandTotalWords = convertAmountToWords(invoiceData.grandTotal);
            saveDataToLocalStorage();
            renderPaginatedInvoice();
        }
        function renderPaginatedInvoice() {
            const container = document.getElementById('invoice-preview-container');
            container.innerHTML = '';
            const itemsPerPage = 15;
            const pageCount = Math.ceil(items.length / itemsPerPage) || 1;
            for (let i = 0; i < pageCount; i++) {
                const itemChunk = items.slice(i * itemsPerPage, (i + 1) * itemsPerPage);
                container.innerHTML += generateInvoicePageHTML(itemChunk, i, pageCount);
            }
            lucide.createIcons();
        }
        function generateInvoicePageHTML(pageItems, currentPage, totalPages) {
            let gstSummaryHtml = '';
            if (invoiceData.isInterstate) {
                gstSummaryHtml = `<div class="flex justify-between"><span>IGST</span><span>₹${invoiceData.totalIGST}</span></div>`;
            } else {
                gstSummaryHtml = `<div class="flex justify-between"><span>CGST</span><span>₹${invoiceData.totalCGST}</span></div>
                                  <div class="flex justify-between"><span>SGST</span><span>₹${invoiceData.totalSGST}</span></div>`;
            }
            let headers = `<th>SrNo.</th><th>Product name</th><th>HSN/SAC</th><th>Qty</th><th>Rate</th><th>Disc%</th><th>Amount</th>`;
            let bodyHtml = pageItems.map((item, index) => {
                return `<tr>
                    <td>${currentPage * 15 + index + 1}</td>
                    <td>${escapeHtml(item.description)}</td>
                    <td>${item.hsnSac}</td>
                    <td>${item.quantity}</td>
                    <td>${item.rate}</td>
                    <td>${item.discount || 0}%</td>
                    <td class="font-semibold">₹${item.taxableValue}</td>
                </tr>`;
            }).join('');
            return `
                <div class="invoice-page">
                    <div class="flex justify-between items-start pb-4 border-b-2 border-slate-300">
                        <div class="w-1/4">
                            <img src="https://drive.google.com/uc?id=1L_NG4hUWi56GAaSTWBYFyau5cpG2Pb7W" alt="Vinayaka Logo" class="h-16 rounded-xl">
                        </div>
                        <div class="text-center flex-1">
                            <p class="text-xs text-slate-500 font-bold">No.34, Lakshmipura Main Road, Chikkabanavara post, Abbigere, Bangalore - 560090</p>
                            <p class="text-xs text-slate-500 font-bold">GSTIN: 29AQCPK0903A1ZI</p>
                            <p class="text-xs text-slate-500 font-bold">Phone: +91 9448355315, +91 9980561436</p>
                            <p class="text-xs text-slate-500 font-bold">Email: Vinayakaindustries.banglore@mail.com</p>
                        </div>
                        <div class="w-1/4 text-right"></div>
                    </div>
                    <div class="flex justify-between items-center py-1 border-b-2 border-slate-300"><span class="text-xs">Debit Memo</span><h1 class="text-base font-bold">TAX INVOICE</h1><span class="text-xs">Original</span></div>
                    <div class="grid grid-cols-2 gap-4 py-2 border-b-2 border-slate-300">
                        <div class="text-xs"><p class="font-bold">M/s. : <span class="font-normal">${invoiceData.customerName || ''}</span></p><p class="font-bold">Place of Supply : <span class="font-normal">${invoiceData.customerAddress?.split(',').pop().trim() || ''}</span></p><p class="font-bold">GSTIN No. : <span class="font-normal">${invoiceData.customerGSTIN || ''}</span></p></div>
                        <div class="text-xs border-l-2 border-slate-300 pl-4"><p class="font-bold">Invoice No. : <span class="font-normal">${invoiceData.invoiceNumber || ''}</span></p><p class="font-bold">Date : <span class="font-normal">${invoiceData.invoiceDate || ''}</span></p><p class="font-bold">DELIVERY : <span class="font-normal">${invoiceData.customerAddress || ''}</span></p></div>
                    </div>
                    <div class="flex-grow mb-2"><table class="invoice-table"><thead><tr>${headers}</tr></thead><tbody>${bodyHtml}</tbody></table></div>
                    <div class="grid grid-cols-2 gap-4 text-xs mt-auto">
                        <div class="space-y-1">
                            <p class="font-bold">GSTIN No. : <span class="font-normal">29AQCPK0903A1ZI</span></p>
                            <p class="font-bold">Total GST : <span class="font-normal">${convertAmountToWords((parseFloat(invoiceData.totalIGST) + parseFloat(invoiceData.totalCGST) + parseFloat(invoiceData.totalSGST)).toFixed(2))} ONLY</span></p>
                            <p class="font-bold">Bill Amount : <span class="font-normal capitalize">${invoiceData.grandTotalWords} ONLY</span></p>
                            <div class="pt-2"><p class="font-bold">Bank Details:</p><p class="font-normal">Bank: ${appSettings.bankName || ''}<br>A/C: ${appSettings.accountNumber || ''}<br>IFSC: ${appSettings.ifscCode || ''}</p></div>
                            <div class="pt-2"><p class="font-bold">Terms & Conditions:</p><p class="font-normal whitespace-pre-line">${appSettings.paymentTerms || ''}</p></div>
                            <div class="pt-2"><p class="font-bold">Note:</p><p class="font-normal">${appSettings.notes || ''}</p></div>
                        </div>
                        <div class="border-l-2 border-slate-300 pl-4">
                            <div class="flex justify-between py-1 border-b border-slate-300"><span class="font-bold">Taxable Amount</span><span>₹${invoiceData.totalTaxableValue || '0.00'}</span></div>
                            <div class="py-1 border-b border-slate-300">${gstSummaryHtml}</div>
                            <div class="flex justify-between py-1 border-b border-slate-300"><span class="font-bold">Round off</span><span>${invoiceData.roundOff || '0.00'}</span></div>
                            <div class="flex justify-between py-1 font-bold text-sm"><span class="font-bold">Grand Total</span><span>₹${invoiceData.grandTotal || '0.00'}</span></div>
                            <div class="mt-12 text-center"><p class="font-bold">For, <img src="https://drive.google.com/uc?id=1L_NG4hUWi56GAaSTWBYFyau5cpG2Pb7W" alt="Vinayaka Logo" class="h-8 mx-auto"></p><p>(Authorized Signature)</p></div>
                        </div>
                    </div>
                </div>`;
        }
        function validateInvoiceData() {
            if (!appSettings.companyGSTIN) { showError('Company GSTIN is required.'); showSettings(); return false; }
            if (!invoiceData.customerName) { showError('Customer Name is required.'); return false; }
            if (items.length === 0) { showError('At least one item is required.'); return false; }
            return true;
        }
        function printInvoice() { if (!validateInvoiceData()) return; window.print(); }
        function downloadPDF() { if (!validateInvoiceData()) return; Swal.fire({title:'Generating PDF...'}); html2pdf().from(document.getElementById('invoice-preview-container')).set({margin:0.25, filename:`invoice-${invoiceData.invoiceNumber}.pdf`, jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }}).save().then(()=>Swal.close()); }
        async function saveInvoice() {
            if (!validateInvoiceData()) return;
            Swal.fire({ title: 'Saving Invoice...', html: '<div class="loading"></div>', allowOutsideClick: false, showConfirmButton: false });
            const dataToSend = { invoiceData: { ...invoiceData, ...appSettings }, items: [...items] };
            try {
                const response = await fetch(GOOGLE_APPS_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify(dataToSend),
                    headers: { 'Content-Type': 'application/json' }
                });
                if (!response.ok) throw new Error(`Server responded with status: ${response.status}`);
                const result = await response.json();
                if (result.status === 'success') {
                    Swal.close();
                    showSuccess(`Invoice ${result.invoiceNumber || invoiceData.invoiceNumber} saved!`);
                } else {
                    throw new Error(result.message || 'Unknown error from server.');
                }
            } catch (error) {
                Swal.close();
                console.error("Save error:", error);
                showError(`Save failed: ${error.message}`);
            }
        }
        function saveDataToLocalStorage() {
            localStorage.setItem('invoiceForgeDataV4', JSON.stringify({ invoiceData, items, nextItemId, appSettings, theme: document.body.className }));
        }
        function loadDataFromLocalStorage() {
            const data = JSON.parse(localStorage.getItem('invoiceForgeDataV4'));
            if (data) {
                invoiceData = data.invoiceData || {};
                items = data.items || [];
                nextItemId = data.nextItemId || 1;
                appSettings = data.appSettings || {};
                document.body.className = data.theme || 'dark-theme';
                document.getElementById('customer-name').value = invoiceData.customerName;
                document.getElementById('customer-address').value = invoiceData.customerAddress;
                document.getElementById('customer-gstin').value = invoiceData.customerGSTIN;
                renderItems();
                return true;
            }
            return false;
        }
        document.addEventListener('DOMContentLoaded', async () => {
            const themeToggle = document.getElementById('theme-toggle');
            const themeIcon = document.getElementById('theme-icon');
            const setTheme = (isDark) => {
                document.body.className = isDark ? 'dark-theme' : 'light-theme';
                themeIcon.setAttribute('data-lucide', isDark ? 'sun' : 'moon');
                lucide.createIcons();
            };
            themeToggle.onclick = () => {
                const isDark = document.body.classList.contains('dark-theme');
                setTheme(!isDark);
                saveDataToLocalStorage();
            };
            const dataLoaded = loadDataFromLocalStorage();
            if (!dataLoaded) {
                setTheme(true);
                const today = new Date().toISOString().split('T')[0];
                invoiceData = { invoiceDate: today, dueDate: today, invoiceNumber: 'VI-001' };
                appSettings = {
                    companyGSTIN: '29AQCPK0903A1ZI',
                    companyContact: '+91 9448355315, +91 9980561436',
                    companyEmail: 'Vinayakaindustries.banglore@mail.com',
                    companyAddress: 'No.34, Lakshmipura Main Road, Chikkabanavara post, Abbigere, Bangalore - 560090',
                    invoicePrefix: 'VI-001',
                    bankName: 'Bank',
                    accountNumber: 'Account No.',
                    ifscCode: 'IFSC',
                    paymentTerms: '1. Goods once sold will not be taken back.\n2. Interest @18% p.a. will be charged if payment is not made within due date.',
                    notes: 'Thank you!'
                };
                addItem();
            } else {
                 setTheme(document.body.className.includes('dark-theme'));
            }
            showSuccess('Welcome to InvoiceForge!');
            try { customerData = await fetchCsvData(CUSTOMERS_CSV_URL, 'Customers'); document.getElementById('customer-names-datalist').innerHTML = customerData.map(c => `<option value="${escapeHtml(c['Customer Name'])}">`).join(''); } catch(e) {}
            try { productData = await fetchCsvData(PRODUCTS_CSV_URL, 'Products'); renderItems(); } catch(e) {}
            updateInvoice();
        });
    </script>
</body>
</html>
