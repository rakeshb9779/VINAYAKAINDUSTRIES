<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>VINAYAKA INDUSTRIES | Invoice Generator Pro</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- PapaParse for CSV -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <!-- html2pdf for PDF Download -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        html, body { height: 100%; }
        body { font-family: 'Inter', sans-serif; background: #1e2636; color: #f1f5f9; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-thumb { background: #38bdf8; border-radius: 6px; }
        .nav-active { background: #272e3b; color: #38bdf8; }
        .hide { display: none !important; }
        .sidebar-main { transition: transform 0.2s; z-index: 40; }
        .sidebar-main.closed { transform: translateX(-100%); }
        .sidebar-main.open { transform: translateX(0); }
        .sidebar-mini { width: 56px; transition: width 0.3s; }
        .sidebar-mini.expanded { width: 240px; }
        .nav-item .lucide { transition: color 0.15s; }
        .nav-item:hover, .nav-item.active { background: #23293a; color: #38bdf8 !important; }
        .nav-item.active .lucide, .nav-item:hover .lucide { color: #38bdf8 !important; }
        .brand-logo { height: 38px; }
        @media (max-width: 900px) {
            .sidebar-main { position: fixed; left: 0; top: 0; bottom: 0; width: 210px; z-index: 50; }
            .sidebar-mini { display: none !important; }
            .main-content { margin-left: 0 !important; }
        }
        @media (max-width: 600px) {
            .sidebar-main { width: 100vw; }
        }
        .transition { transition: all 0.3s; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="h-screen w-screen">

<div id="app" class="flex h-screen w-screen overflow-hidden">

    <!-- Main Navigation Sidebar -->
    <nav id="mainSidebar"
         class="sidebar-main open flex flex-col justify-between bg-[#192030] text-[#b3bed6] border-r border-[#283047] shadow-lg transition md:open w-56 fixed left-0 top-0 bottom-0 z-30"
         onmouseenter="expandSidebar()" onmouseleave="collapseSidebar()" style="min-width:56px">
        <div>
            <div class="flex items-center h-16 justify-center border-b border-[#283047]">
                <img src="https://drive.google.com/uc?id=1L_NG4hUWi56GAaSTWBYFyau5cpG2Pb7W" alt="VINAYAKA INDUSTRIES LOGO" class="brand-logo mx-auto">
            </div>
            <ul id="navList" class="flex flex-col mt-2 gap-1">
                <li class="nav-item px-4 py-3 flex items-center gap-3 cursor-pointer rounded-lg transition" data-page="dashboard">
                    <i data-lucide="home" class="lucide w-5 h-5"></i>
                    <span class="nav-label">Dashboard</span>
                </li>
                <li class="nav-item px-4 py-3 flex items-center gap-3 cursor-pointer rounded-lg transition" data-page="invoice">
                    <i data-lucide="file-plus" class="lucide w-5 h-5"></i>
                    <span class="nav-label">Create Invoice</span>
                </li>
                <li class="nav-item px-4 py-3 flex items-center gap-3 cursor-pointer rounded-lg transition" data-page="history">
                    <i data-lucide="history" class="lucide w-5 h-5"></i>
                    <span class="nav-label">Invoice History</span>
                </li>
                <li class="nav-item px-4 py-3 flex items-center gap-3 cursor-pointer rounded-lg transition" data-page="customers">
                    <i data-lucide="users" class="lucide w-5 h-5"></i>
                    <span class="nav-label">Customers</span>
                </li>
                <li class="nav-item px-4 py-3 flex items-center gap-3 cursor-pointer rounded-lg transition" data-page="products">
                    <i data-lucide="package" class="lucide w-5 h-5"></i>
                    <span class="nav-label">Products</span>
                </li>
                <li class="nav-item px-4 py-3 flex items-center gap-3 cursor-pointer rounded-lg transition" data-page="reports">
                    <i data-lucide="bar-chart" class="lucide w-5 h-5"></i>
                    <span class="nav-label">Reports</span>
                </li>
                <li class="nav-item px-4 py-3 flex items-center gap-3 cursor-pointer rounded-lg transition" data-page="settings">
                    <i data-lucide="settings" class="lucide w-5 h-5"></i>
                    <span class="nav-label">Settings</span>
                </li>
            </ul>
        </div>
        <div class="mb-4 flex flex-col items-center">
            <button id="sidebarToggle" onclick="toggleSidebar()" class="p-2 bg-[#23293a] rounded-full shadow hover:bg-[#2d3547] transition"><i data-lucide="menu" class="lucide w-5 h-5"></i></button>
        </div>
    </nav>

    <!-- Overlay for mobile when sidebar open -->
    <div id="sidebarOverlay" onclick="closeSidebarMobile()" class="fixed z-20 inset-0 bg-black bg-opacity-40 hidden md:hidden"></div>

    <!-- Main Content Area -->
    <main id="mainContent" class="main-content flex-1 ml-56 h-screen overflow-auto transition bg-[#202a3b] scrollbar-hide">

        <!-- DASHBOARD PAGE -->
        <section id="dashboardPage" class="page-section py-6 px-8">
            <h1 class="text-3xl font-extrabold mb-2 flex items-center gap-2"><i data-lucide="home" class="lucide w-7 h-7 text-[#38bdf8]"></i>Dashboard</h1>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-8">
                <div class="rounded-xl p-6 bg-[#22304b] flex flex-col gap-1 shadow">
                    <span class="text-sm text-[#60a5fa] font-semibold">Total Invoices</span>
                    <span id="dashboardTotalInvoices" class="text-2xl font-bold">-</span>
                </div>
                <div class="rounded-xl p-6 bg-[#22304b] flex flex-col gap-1 shadow">
                    <span class="text-sm text-[#60a5fa] font-semibold">Total Customers</span>
                    <span id="dashboardTotalCustomers" class="text-2xl font-bold">-</span>
                </div>
                <div class="rounded-xl p-6 bg-[#22304b] flex flex-col gap-1 shadow">
                    <span class="text-sm text-[#60a5fa] font-semibold">Total Products</span>
                    <span id="dashboardTotalProducts" class="text-2xl font-bold">-</span>
                </div>
            </div>
            <div class="rounded-xl p-8 mt-8 bg-[#233043] shadow flex flex-col gap-3">
                <span class="text-lg font-semibold text-[#38bdf8]">Total Sales</span>
                <span id="dashboardTotalSales" class="text-2xl font-bold">â‚¹-</span>
            </div>
        </section>

        <!-- CREATE INVOICE PAGE -->
        <section id="invoicePage" class="page-section hide flex h-full">
            <!-- Invoice Sidebar (existing glass UI, your layout) -->
            <aside id="invoiceSidebar" class="w-[360px] min-w-[340px] bg-[#1c2635] border-r border-[#23293a] h-full px-7 py-8 flex flex-col gap-8">
                <div class="flex items-center gap-2 mb-6">
                    <img src="https://drive.google.com/uc?id=1L_NG4hUWi56GAaSTWBYFyau5cpG2Pb7W" class="brand-logo mr-2" alt="VINAYAKA Logo">
                    <span class="uppercase tracking-widest font-bold text-[#a0aec0] text-xs">Vinayaka Industries LOGO</span>
                </div>
                <div>
                    <h2 class="font-bold text-xl mb-4 text-[#38bdf8] flex items-center gap-2"><i data-lucide="user-round" class="lucide w-5 h-5"></i>Customer Details</h2>
                    <input type="text" id="customer-name" class="w-full rounded-lg mb-2 px-4 py-3 bg-[#22304b] text-white outline-none" placeholder="Customer Name">
                    <input type="text" id="customer-gstin" class="w-full rounded-lg mb-2 px-4 py-3 bg-[#22304b] text-white outline-none" placeholder="Customer GSTIN">
                    <textarea id="customer-address" class="w-full rounded-lg px-4 py-3 bg-[#22304b] text-white outline-none mb-2" rows="2" placeholder="Place of Delivery"></textarea>
                </div>
                <div>
                    <h2 class="font-bold text-xl mb-4 text-[#38bdf8] flex items-center gap-2"><i data-lucide="package-plus" class="lucide w-5 h-5"></i>Items</h2>
                    <div id="items-container" class="space-y-4"></div>
                    <div id="no-items-message" class="text-center italic p-4" style="display: none;">No items added.</div>
                    <button type="button" onclick="addItem()" class="bg-[#38bdf8] hover:bg-[#2563eb] text-white px-4 py-2 rounded-lg font-bold mt-3 w-full flex items-center justify-center gap-2"><i data-lucide="plus" class="lucide w-5 h-5"></i>Add Item</button>
                </div>
            </aside>
            <!-- Invoice Content -->
            <div class="flex-1 h-full overflow-auto px-4 py-7 bg-[#202a3b]">
                <div id="invoice-preview-container"></div>
                <footer class="flex gap-4 justify-center fixed bottom-4 left-[360px] right-4 z-40">
                    <button onclick="updateInvoice()" class="bg-[#38bdf8] hover:bg-[#2563eb] text-white px-6 py-3 rounded-lg font-semibold flex items-center gap-2"><i data-lucide="eye" class="lucide w-5 h-5"></i>Preview Live</button>
                    <button onclick="printInvoice()" class="bg-[#38bdf8] hover:bg-[#2563eb] text-white px-6 py-3 rounded-lg font-semibold flex items-center gap-2"><i data-lucide="printer" class="lucide w-5 h-5"></i>Print</button>
                    <button onclick="downloadPDF()" class="bg-[#38bdf8] hover:bg-[#2563eb] text-white px-6 py-3 rounded-lg font-semibold flex items-center gap-2"><i data-lucide="file-down" class="lucide w-5 h-5"></i>Download</button>
                    <button onclick="saveInvoice()" class="bg-[#22d3ee] hover:bg-[#0891b2] text-white px-6 py-3 rounded-lg font-semibold flex items-center gap-2"><i data-lucide="save" class="lucide w-5 h-5"></i>Save</button>
                    <button onclick="showSettings()" class="bg-[#64748b] hover:bg-[#334155] text-white px-6 py-3 rounded-lg font-semibold flex items-center gap-2"><i data-lucide="settings" class="lucide w-5 h-5"></i>Settings</button>
                </footer>
            </div>
        </section>

        <!-- INVOICE HISTORY PAGE -->
        <section id="historyPage" class="page-section hide py-10 px-8">
            <h1 class="text-2xl font-bold mb-5 flex items-center gap-2"><i data-lucide="history" class="lucide w-6 h-6 text-[#38bdf8]"></i>Invoice History</h1>
            <div class="mb-4 flex gap-2">
                <input type="text" id="history-search" class="rounded-lg px-4 py-2 bg-[#22304b] text-white outline-none w-72" placeholder="Search Invoice No or Customer Name">
                <button onclick="loadInvoiceHistory()" class="bg-[#38bdf8] hover:bg-[#2563eb] text-white px-4 py-2 rounded-lg font-semibold flex items-center gap-2"><i data-lucide="refresh-cw" class="lucide w-4 h-4"></i>Refresh</button>
            </div>
            <div id="history-list" class="space-y-3 max-h-[60vh] overflow-y-auto"></div>
        </section>

        <!-- CUSTOMERS PAGE -->
        <section id="customersPage" class="page-section hide py-10 px-8">
            <h1 class="text-2xl font-bold mb-4 flex items-center gap-2"><i data-lucide="users" class="lucide w-6 h-6 text-[#38bdf8]"></i>Customers</h1>
            <div class="mb-6 flex gap-4 items-end">
                <input type="text" id="newCustomerName" class="rounded-lg px-4 py-2 bg-[#22304b] text-white outline-none" placeholder="Customer Name">
                <input type="text" id="newCustomerGSTIN" class="rounded-lg px-4 py-2 bg-[#22304b] text-white outline-none" placeholder="GSTIN">
                <input type="text" id="newCustomerAddress" class="rounded-lg px-4 py-2 bg-[#22304b] text-white outline-none" placeholder="Address">
                <button onclick="addNewCustomer()" class="bg-[#38bdf8] hover:bg-[#2563eb] text-white px-5 py-2 rounded-lg font-semibold flex items-center gap-2"><i data-lucide="user-plus" class="lucide w-5 h-5"></i>Add</button>
            </div>
            <div id="customerList" class="space-y-2"></div>
        </section>

        <!-- PRODUCTS PAGE -->
        <section id="productsPage" class="page-section hide py-10 px-8">
            <h1 class="text-2xl font-bold mb-4 flex items-center gap-2"><i data-lucide="package" class="lucide w-6 h-6 text-[#38bdf8]"></i>Products</h1>
            <div class="mb-6 flex gap-4 items-end">
                <input type="text" id="newProductModel" class="rounded-lg px-4 py-2 bg-[#22304b] text-white outline-none" placeholder="Model + Model No.">
                <input type="text" id="newProductDevice" class="rounded-lg px-4 py-2 bg-[#22304b] text-white outline-none" placeholder="Device">
                <input type="text" id="newProductName" class="rounded-lg px-4 py-2 bg-[#22304b] text-white outline-none" placeholder="Item Name">
                <input type="text" id="newProductHSN" class="rounded-lg px-4 py-2 bg-[#22304b] text-white outline-none" placeholder="HSN/SAC">
                <input type="text" id="newProductRate" class="rounded-lg px-4 py-2 bg-[#22304b] text-white outline-none" placeholder="Rate">
                <button onclick="addNewProduct()" class="bg-[#38bdf8] hover:bg-[#2563eb] text-white px-5 py-2 rounded-lg font-semibold flex items-center gap-2"><i data-lucide="plus" class="lucide w-5 h-5"></i>Add</button>
            </div>
            <div id="productList" class="space-y-2"></div>
        </section>

        <!-- REPORTS PAGE -->
        <section id="reportsPage" class="page-section hide py-10 px-8">
            <h1 class="text-2xl font-bold mb-4 flex items-center gap-2"><i data-lucide="bar-chart" class="lucide w-6 h-6 text-[#38bdf8]"></i>Reports</h1>
            <div class="rounded-lg bg-[#22304b] p-6 text-white">
                <h2 class="font-bold mb-3">Coming Soon: Sales/Tax Reports, Inventory, and More!</h2>
                <div id="reports-content"></div>
            </div>
        </section>

        <!-- SETTINGS PAGE -->
        <section id="settingsPage" class="page-section hide py-10 px-8">
            <h1 class="text-2xl font-bold mb-4 flex items-center gap-2"><i data-lucide="settings" class="lucide w-6 h-6 text-[#38bdf8]"></i>Settings</h1>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-10">
                <div class="bg-[#22304b] p-6 rounded-xl">
                    <h2 class="font-semibold text-[#38bdf8] mb-3">Invoice Prefix</h2>
                    <input type="text" id="settings-invoice-prefix" class="rounded-lg px-4 py-2 bg-[#1c2635] text-white outline-none w-48" placeholder="e.g. VI-001">
                </div>
                <div class="bg-[#22304b] p-6 rounded-xl">
                    <h2 class="font-semibold text-[#38bdf8] mb-3">Company Details</h2>
                    <input type="text" id="settings-gstin" class="rounded-lg px-4 py-2 bg-[#1c2635] text-white outline-none w-80 mb-2" placeholder="GSTIN">
                    <input type="text" id="settings-contact" class="rounded-lg px-4 py-2 bg-[#1c2635] text-white outline-none w-80 mb-2" placeholder="Contact Numbers">
                    <input type="text" id="settings-email" class="rounded-lg px-4 py-2 bg-[#1c2635] text-white outline-none w-80 mb-2" placeholder="Email">
                    <input type="text" id="settings-address" class="rounded-lg px-4 py-2 bg-[#1c2635] text-white outline-none w-80 mb-2" placeholder="Company Address">
                </div>
                <div class="bg-[#22304b] p-6 rounded-xl">
                    <h2 class="font-semibold text-[#38bdf8] mb-3">Bank & Payment</h2>
                    <input type="text" id="settings-bank-name" class="rounded-lg px-4 py-2 bg-[#1c2635] text-white outline-none w-72 mb-2" placeholder="Bank Name">
                    <input type="text" id="settings-account-number" class="rounded-lg px-4 py-2 bg-[#1c2635] text-white outline-none w-72 mb-2" placeholder="Account Number">
                    <input type="text" id="settings-ifsc-code" class="rounded-lg px-4 py-2 bg-[#1c2635] text-white outline-none w-72 mb-2" placeholder="IFSC Code">
                    <input type="text" id="settings-payment-terms" class="rounded-lg px-4 py-2 bg-[#1c2635] text-white outline-none w-72 mb-2" placeholder="Payment Terms">
                </div>
                <div class="bg-[#22304b] p-6 rounded-xl">
                    <h2 class="font-semibold text-[#38bdf8] mb-3">Other Preferences</h2>
                    <div class="flex items-center gap-3 mb-3">
                        <input type="checkbox" id="settings-keep-draft" class="w-5 h-5">
                        <label for="settings-keep-draft" class="text-white">Keep Invoice Draft after Save</label>
                    </div>
                    <textarea id="settings-notes" class="rounded-lg px-4 py-2 bg-[#1c2635] text-white outline-none w-full" rows="3" placeholder="Notes / Remarks"></textarea>
                </div>
            </div>
            <button onclick="saveSettings()" class="bg-[#22d3ee] hover:bg-[#0891b2] text-white px-7 py-3 rounded-lg font-semibold mt-8 flex items-center gap-2"><i data-lucide="save" class="lucide w-5 h-5"></i>Save Settings</button>
        </section>
    </main>
</div>

<!-- SWEETALERT2 TOAST -->
<script>
    const Toast = Swal.mixin({ toast:true, position:'top-end', showConfirmButton:false, timer:2700, timerProgressBar:true, didOpen:t=>{t.onmouseenter=Swal.stopTimer;t.onmouseleave=Swal.resumeTimer} });
    const showSuccess = m=>Toast.fire({icon:'success',title:m,background:'#1e293b',color:'#38bdf8'});
    const showError = m=>Toast.fire({icon:'error',title:m,background:'#fee2e2',color:'#991b1b'});
</script>

<!-- MAIN APP LOGIC -->
<script>
// ===============================
// === CONFIGURATION
// ===============================
const GOOGLE_APPS_SCRIPT_URL = 'https://vinayakaindustries.netlify.app/.netlify/functions/proxy'; // your Netlify proxy URL!
const COMPANY_LOGO_URL = "https://drive.google.com/uc?id=1L_NG4hUWi56GAaSTWBYFyau5cpG2Pb7W";

// ===============================
// === STATE/STORE
// ===============================
let state = {
    currentPage: "dashboard",
    customers: [],
    products: [],
    history: [],
    appSettings: {
        invoicePrefix: "VI-001",
        gstin: "29AQCPK0903A1ZI",
        contact: "+91 9448355315, +91 9980561436",
        email: "Vinayakaindustries.banglore@mail.com",
        address: "No.34, Lakshmipura Main Road, Chikkabanavara post, Abbigere, Bangalore - 560090",
        bankName: "",
        accountNumber: "",
        ifscCode: "",
        paymentTerms: "",
        notes: "",
        keepDraft: false,
    },
    invoiceDraft: {
        invoiceNumber: "VI-001",
        customerName: "",
        customerGSTIN: "",
        customerAddress: "",
        items: []
    }
};

// ===============================
// === SIDEBAR + NAV
// ===============================
function expandSidebar() {
    document.getElementById('mainSidebar').classList.remove('closed');
}
function collapseSidebar() {
    if (state.currentPage === "invoice") {
        document.getElementById('mainSidebar').classList.add('closed');
    }
}
function toggleSidebar() {
    let el = document.getElementById('mainSidebar');
    el.classList.toggle('closed');
}
function closeSidebarMobile() {
    document.getElementById('mainSidebar').classList.add('closed');
    document.getElementById('sidebarOverlay').classList.add('hidden');
}

// Navigation logic
document.querySelectorAll('.nav-item').forEach(item => {
    item.onclick = () => {
        let page = item.dataset.page;
        setPage(page);
        if (window.innerWidth < 900) closeSidebarMobile();
    };
});

function setPage(page) {
    state.currentPage = page;
    document.querySelectorAll('.page-section').forEach(sec => sec.classList.add('hide'));
    document.getElementById(page + "Page").classList.remove('hide');
    document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
    document.querySelector('.nav-item[data-page="' + page + '"]').classList.add('active');
    if (page === "invoice") {
        collapseSidebar();
        document.getElementById('mainContent').classList.add('flex');
    } else {
        expandSidebar();
        document.getElementById('mainContent').classList.remove('flex');
    }
    if (page === "dashboard") renderDashboard();
    if (page === "history") loadInvoiceHistory();
    if (page === "customers") renderCustomers();
    if (page === "products") renderProducts();
}
window.setPage = setPage;

// Hamburger (mobile)
document.getElementById('sidebarToggle').onclick = () => {
    let sidebar = document.getElementById('mainSidebar');
    sidebar.classList.toggle('closed');
    document.getElementById('sidebarOverlay').classList.toggle('hidden');
};

// ===============================
// === DASHBOARD
// ===============================
function renderDashboard() {
    document.getElementById('dashboardTotalInvoices').innerText = state.history.length;
    document.getElementById('dashboardTotalCustomers').innerText = state.customers.length;
    document.getElementById('dashboardTotalProducts').innerText = state.products.length;
    let totalSales = 0;
    state.history.forEach(inv => {
        let j = {};
        try { j = JSON.parse(inv.fullInvoiceJSON); } catch {}
        if (j && j.invoiceData && j.invoiceData.grandTotal) totalSales += parseFloat(j.invoiceData.grandTotal || 0);
    });
    document.getElementById('dashboardTotalSales').innerText = "â‚¹" + totalSales.toLocaleString("en-IN");
}

// ===============================
// === INVOICE ENGINE
// ===============================
function resetInvoiceDraft() {
    state.invoiceDraft = {
        invoiceNumber: state.appSettings.invoicePrefix || "VI-001",
        customerName: "",
        customerGSTIN: "",
        customerAddress: "",
        items: [{ model: "", device: "", itemName: "", description: "", hsnSac: "", quantity: 1, rate: 0, discount: 0 }]
    };
    updateInvoiceForm();
}
function updateInvoiceForm() {
    // Inputs to state
    document.getElementById('customer-name').value = state.invoiceDraft.customerName || "";
    document.getElementById('customer-gstin').value = state.invoiceDraft.customerGSTIN || "";
    document.getElementById('customer-address').value = state.invoiceDraft.customerAddress || "";
    renderItems();
    renderInvoicePreview();
}

// ==================
// ITEM RENDER/EDIT
// ==================
function renderItems() {
    const container = document.getElementById('items-container');
    if (!container) return;
    container.innerHTML = "";
    (state.invoiceDraft.items || []).forEach((item, idx) => {
        let html = `
        <div class="rounded-lg border border-[#23293a] bg-[#233043] p-3 relative flex flex-col gap-2">
            <div class="grid grid-cols-2 gap-2">
                <input type="text" placeholder="Model + Model No." value="${item.model || ""}" class="rounded px-2 py-1 bg-[#202a3b] text-white" oninput="updateItem(${idx}, 'model', this.value)">
                <select class="rounded px-2 py-1 bg-[#202a3b] text-white" onchange="updateItem(${idx}, 'device', this.value)">
                    <option value="">Select Device</option>
                    <option value="SWING DEVICE" ${item.device === "SWING DEVICE" ? "selected" : ""}>SWING DEVICE</option>
                    <option value="TRAVEL DEVICE" ${item.device === "TRAVEL DEVICE" ? "selected" : ""}>TRAVEL DEVICE</option>
                    <option value="-" ${item.device === "-" ? "selected" : ""}>-</option>
                </select>
            </div>
            <input type="text" placeholder="Item Name" value="${item.itemName || ""}" class="rounded px-2 py-1 bg-[#202a3b] text-white" oninput="updateItem(${idx}, 'itemName', this.value)">
            <input type="text" placeholder="Full Description" value="${item.description || ""}" class="rounded px-2 py-1 bg-[#202a3b] text-white" oninput="updateItem(${idx}, 'description', this.value)">
            <div class="grid grid-cols-4 gap-2">
                <input type="text" placeholder="HSN" value="${item.hsnSac || ""}" class="rounded px-2 py-1 bg-[#202a3b] text-white" oninput="updateItem(${idx}, 'hsnSac', this.value)">
                <input type="number" placeholder="Qty" value="${item.quantity || 1}" min="1" class="rounded px-2 py-1 bg-[#202a3b] text-white" oninput="updateItem(${idx}, 'quantity', this.value)">
                <input type="number" placeholder="Rate" value="${item.rate || 0}" class="rounded px-2 py-1 bg-[#202a3b] text-white" oninput="updateItem(${idx}, 'rate', this.value)">
                <input type="number" placeholder="Disc%" value="${item.discount || 0}" min="0" max="100" class="rounded px-2 py-1 bg-[#202a3b] text-white" oninput="updateItem(${idx}, 'discount', this.value)">
            </div>
            ${state.invoiceDraft.items.length > 1 ? `<button onclick="removeItem(${idx})" class="absolute right-2 top-2 text-red-400 hover:text-red-600"><i data-lucide='x' class='lucide w-4 h-4'></i></button>` : ""}
        </div>
        `;
        container.insertAdjacentHTML('beforeend', html);
    });
    lucide.createIcons();
}
window.updateItem = (idx, field, val) => {
    state.invoiceDraft.items[idx][field] = val;
    renderInvoicePreview();
};
window.removeItem = idx => {
    state.invoiceDraft.items.splice(idx, 1);
    renderItems(); renderInvoicePreview();
};
window.addItem = () => {
    state.invoiceDraft.items.push({ model: "", device: "", itemName: "", description: "", hsnSac: "", quantity: 1, rate: 0, discount: 0 });
    renderItems(); renderInvoicePreview();
};

// ==================
// INVOICE PREVIEW
// ==================
function renderInvoicePreview() {
    // Calculate totals
    let items = state.invoiceDraft.items || [];
    let total = 0;
    let rows = items.map((item, idx) => {
        let qty = parseFloat(item.quantity) || 1;
        let rate = parseFloat(item.rate) || 0;
        let disc = parseFloat(item.discount) || 0;
        let amt = qty * rate * (1 - disc / 100);
        total += amt;
        return `<tr class="border-b border-[#23293a]"><td class="p-2">${idx + 1}</td><td class="p-2">${(item.model || "") + (item.model && item.itemName ? " " : "") + (item.itemName || "")}</td><td class="p-2">${item.hsnSac || ""}</td><td class="p-2">${qty}</td><td class="p-2">â‚¹${rate.toFixed(2)}</td><td class="p-2">${disc}%</td><td class="p-2">â‚¹${amt.toFixed(2)}</td></tr>`;
    }).join('');
    let previewHTML = `
    <div class="bg-white rounded-lg p-7 shadow text-black max-w-4xl mx-auto mt-2 mb-10 border border-[#d1d5db]">
        <div class="flex justify-between items-start border-b pb-2">
            <img src="${COMPANY_LOGO_URL}" class="h-14" alt="Vinayaka Logo">
            <div class="text-xs text-right leading-4">
                <div>${state.appSettings.address}</div>
                <div>GSTIN: ${state.appSettings.gstin}</div>
                <div>Phone: ${state.appSettings.contact}</div>
                <div>Email: ${state.appSettings.email}</div>
            </div>
        </div>
        <div class="text-center text-base font-bold my-3">TAX INVOICE</div>
        <div class="flex gap-4 justify-between border-b pb-2 mb-2 text-xs">
            <div>
                <div><b>M/s.:</b> ${state.invoiceDraft.customerName || "-"}</div>
                <div><b>Place of Supply:</b> ${state.invoiceDraft.customerAddress || "-"}</div>
                <div><b>GSTIN No.:</b> ${state.invoiceDraft.customerGSTIN || "-"}</div>
            </div>
            <div>
                <div><b>Invoice No.:</b> ${state.invoiceDraft.invoiceNumber || "-"}</div>
                <div><b>Date:</b> ${new Date().toISOString().slice(0, 10)}</div>
                <div><b>DELIVERY:</b> ${state.invoiceDraft.customerAddress || "-"}</div>
            </div>
        </div>
        <table class="w-full text-xs border mb-3">
            <thead class="bg-[#e2e8f0] text-[#23293a]">
                <tr><th class="p-2">SrNo.</th><th>Product name</th><th>HSN/SAC</th><th>Qty</th><th>Rate</th><th>Disc%</th><th>Amount</th></tr>
            </thead>
            <tbody>${rows}</tbody>
        </table>
        <div class="flex justify-between text-sm">
            <div>
                <b>GSTIN No.:</b> ${state.appSettings.gstin}<br>
                <b>Bill Amount:</b> â‚¹${total.toFixed(2)}<br>
            </div>
            <div class="text-right">
                <b>Grand Total:</b> â‚¹${total.toFixed(2)}<br>
                <b>Bank:</b> ${state.appSettings.bankName}<br>
                <b>IFSC:</b> ${state.appSettings.ifscCode}<br>
            </div>
        </div>
        <div class="mt-2 text-xs">${state.appSettings.paymentTerms}</div>
        <div class="mt-1 text-xs text-gray-500">${state.appSettings.notes}</div>
    </div>`;
    document.getElementById('invoice-preview-container').innerHTML = previewHTML;
}
window.updateInvoice = () => {
    // update from form fields
    state.invoiceDraft.customerName = document.getElementById('customer-name').value;
    state.invoiceDraft.customerGSTIN = document.getElementById('customer-gstin').value;
    state.invoiceDraft.customerAddress = document.getElementById('customer-address').value;
    renderInvoicePreview();
};

// ==================
// PDF, PRINT, SAVE
// ==================
window.printInvoice = () => window.print();

window.downloadPDF = () => {
    Swal.fire({title:'Generating PDF...'});
    html2pdf().from(document.getElementById('invoice-preview-container')).set({
        margin: 0.25,
        filename: `${state.invoiceDraft.invoiceNumber || "invoice"}.pdf`,
        jsPDF: {unit:'in',format:'a4',orientation:'portrait'}
    }).save().then(()=>Swal.close());
};

window.saveInvoice = async () => {
    // POST to your Netlify Proxy
    Swal.fire({title:'Saving Invoice...',allowOutsideClick:false,showConfirmButton:false});
    let dataToSend = {
        invoiceData: {
            invoiceNumber: state.invoiceDraft.invoiceNumber,
            customerName: state.invoiceDraft.customerName,
            customerGSTIN: state.invoiceDraft.customerGSTIN,
            customerAddress: state.invoiceDraft.customerAddress,
            ...state.appSettings
        },
        items: state.invoiceDraft.items
    };
    try {
        let response = await fetch(GOOGLE_APPS_SCRIPT_URL, {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify(dataToSend)
        });
        if (!response.ok) throw new Error("Failed to save invoice!");
        let result = await response.json();
        Swal.close();
        showSuccess("Invoice Saved!");
        // After Save: Only reset invoice if toggle OFF
        if (!state.appSettings.keepDraft) resetInvoiceDraft();
    } catch (e) {
        Swal.close();
        showError("Save failed: "+(e.message||e));
    }
};

// ===============================
// === HISTORY / CUSTOMERS / PRODUCTS
// ===============================
function loadInvoiceHistory() {
    document.getElementById('history-list').innerHTML = "<div class='text-gray-400'>Loading...</div>";
    fetch(GOOGLE_APPS_SCRIPT_URL+"?action=getInvoices").then(r=>r.json()).then(res=>{
        state.history = res.data || [];
        renderHistory();
        renderDashboard();
    });
}
function renderHistory() {
    let q = (document.getElementById('history-search').value || "").toLowerCase();
    let filtered = state.history.filter(h => (h.invoiceNumber || "").toLowerCase().includes(q) || (h.customerName || "").toLowerCase().includes(q));
    if (!filtered.length) {
        document.getElementById('history-list').innerHTML = "<div class='text-gray-400'>No invoices found.</div>";
        return;
    }
    document.getElementById('history-list').innerHTML = filtered.map(inv => `
        <div class="bg-[#23293a] p-4 rounded-lg flex justify-between items-center">
            <div>
                <div><b>${inv.invoiceNumber}</b> â€“ ${inv.customerName || ""}</div>
                <div class="text-xs text-gray-400">${inv.date || ""}</div>
            </div>
            <button onclick="showInvoiceDetail('${inv.invoiceNumber}')" class="bg-[#38bdf8] text-white px-4 py-1 rounded flex items-center gap-1"><i data-lucide="eye" class="lucide w-4 h-4"></i>View</button>
        </div>
    `).join('');
    lucide.createIcons();
}
window.showInvoiceDetail = invoiceNumber => {
    let inv = state.history.find(h => h.invoiceNumber === invoiceNumber);
    if (!inv) return;
    let j = {};
    try { j = JSON.parse(inv.fullInvoiceJSON); } catch {}
    Swal.fire({
        title: 'Invoice ' + invoiceNumber,
        html: `<pre style="text-align:left;max-height:60vh;overflow:auto">${JSON.stringify(j,null,2)}</pre>`,
        width: 700
    });
};
document.getElementById('history-search').oninput = renderHistory;

function renderCustomers() {
    let list = state.customers.map(c => `<div class="bg-[#233043] rounded p-3 flex justify-between items-center">
        <div>
            <b>${c.name}</b><br>
            <span class="text-xs text-gray-400">${c.gstin || ""}</span>
            <span class="text-xs text-gray-400">${c.address || ""}</span>
        </div>
        <button onclick="deleteCustomer('${c.name}')" class="bg-red-600 text-white px-3 py-1 rounded text-xs">Delete</button>
    </div>`).join('');
    document.getElementById('customerList').innerHTML = list || "<div class='text-gray-400'>No customers yet.</div>";
}
window.addNewCustomer = () => {
    let name = document.getElementById('newCustomerName').value;
    if (!name) return showError("Enter customer name!");
    state.customers.push({
        name,
        gstin: document.getElementById('newCustomerGSTIN').value,
        address: document.getElementById('newCustomerAddress').value
    });
    renderCustomers();
    document.getElementById('newCustomerName').value = "";
    document.getElementById('newCustomerGSTIN').value = "";
    document.getElementById('newCustomerAddress').value = "";
};
window.deleteCustomer = name => {
    state.customers = state.customers.filter(c => c.name !== name);
    renderCustomers();
};

function renderProducts() {
    let list = state.products.map(p => `<div class="bg-[#233043] rounded p-3 flex justify-between items-center">
        <div>
            <b>${p.model || ""}</b> - ${p.device || ""} - ${p.name || ""}<br>
            <span class="text-xs text-gray-400">HSN: ${p.hsn || ""}</span>
            <span class="text-xs text-gray-400">Rate: â‚¹${p.rate || ""}</span>
        </div>
        <button onclick="deleteProduct('${p.model}','${p.name}')" class="bg-red-600 text-white px-3 py-1 rounded text-xs">Delete</button>
    </div>`).join('');
    document.getElementById('productList').innerHTML = list || "<div class='text-gray-400'>No products yet.</div>";
}
window.addNewProduct = () => {
    let model = document.getElementById('newProductModel').value;
    let name = document.getElementById('newProductName').value;
    if (!model || !name) return showError("Model and Name required!");
    state.products.push({
        model,
        device: document.getElementById('newProductDevice').value,
        name,
        hsn: document.getElementById('newProductHSN').value,
        rate: document.getElementById('newProductRate').value
    });
    renderProducts();
    document.getElementById('newProductModel').value = "";
    document.getElementById('newProductDevice').value = "";
    document.getElementById('newProductName').value = "";
    document.getElementById('newProductHSN').value = "";
    document.getElementById('newProductRate').value = "";
};
window.deleteProduct = (model, name) => {
    state.products = state.products.filter(p => p.model !== model || p.name !== name);
    renderProducts();
};

// ===============================
// === SETTINGS (INVOICE PREFIX, DRAFT TOGGLE, COMPANY INFO, ETC.)
// ===============================
function showSettings() { setPage("settings"); }
window.saveSettings = () => {
    state.appSettings.invoicePrefix = document.getElementById('settings-invoice-prefix').value;
    state.appSettings.gstin = document.getElementById('settings-gstin').value;
    state.appSettings.contact = document.getElementById('settings-contact').value;
    state.appSettings.email = document.getElementById('settings-email').value;
    state.appSettings.address = document.getElementById('settings-address').value;
    state.appSettings.bankName = document.getElementById('settings-bank-name').value;
    state.appSettings.accountNumber = document.getElementById('settings-account-number').value;
    state.appSettings.ifscCode = document.getElementById('settings-ifsc-code').value;
    state.appSettings.paymentTerms = document.getElementById('settings-payment-terms').value;
    state.appSettings.notes = document.getElementById('settings-notes').value;
    state.appSettings.keepDraft = document.getElementById('settings-keep-draft').checked;
    showSuccess("Settings Saved!");
    localStorage.setItem("vinayakaAppSettings", JSON.stringify(state.appSettings));
    resetInvoiceDraft();
};
function loadSettings() {
    let s = localStorage.getItem("vinayakaAppSettings");
    if (s) state.appSettings = {...state.appSettings, ...JSON.parse(s)};
    document.getElementById('settings-invoice-prefix').value = state.appSettings.invoicePrefix;
    document.getElementById('settings-gstin').value = state.appSettings.gstin;
    document.getElementById('settings-contact').value = state.appSettings.contact;
    document.getElementById('settings-email').value = state.appSettings.email;
    document.getElementById('settings-address').value = state.appSettings.address;
    document.getElementById('settings-bank-name').value = state.appSettings.bankName;
    document.getElementById('settings-account-number').value = state.appSettings.accountNumber;
    document.getElementById('settings-ifsc-code').value = state.appSettings.ifscCode;
    document.getElementById('settings-payment-terms').value = state.appSettings.paymentTerms;
    document.getElementById('settings-notes').value = state.appSettings.notes;
    document.getElementById('settings-keep-draft').checked = !!state.appSettings.keepDraft;
}

// ===============================
// === INVOICE NUMBER AUTOINCREMENT
// ===============================
function incrementInvoicePrefix(prefix) {
    let match = prefix.match(/(\d+)(?!.*\d)/);
    if (!match) return prefix;
    let num = match[1], nextNum = (parseInt(num) + 1).toString().padStart(num.length, '0');
    return prefix.slice(0, match.index) + nextNum + prefix.slice(match.index + num.length);
}

// When user saves invoice, bump number if not keepDraft
function afterInvoiceSave() {
    if (!state.appSettings.keepDraft) {
        state.appSettings.invoicePrefix = incrementInvoicePrefix(state.appSettings.invoicePrefix);
        state.invoiceDraft.invoiceNumber = state.appSettings.invoicePrefix;
        localStorage.setItem("vinayakaAppSettings", JSON.stringify(state.appSettings));
    }
}

// ===============================
// === INIT APP
// ===============================
window.onload = () => {
    loadSettings();
    resetInvoiceDraft();
    setPage("dashboard");
    lucide.createIcons();
};

</script>

</body>
</html>
